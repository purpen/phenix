{%extends 'layout/shop.html'%}
{% block title%}收货地址-{% endblock %}
{% block page_css %}
<style type="text/css">
#mfrbird{
	margin-top:0;
}
h3.ui.header{
	font-weight:400;
}
  @media only screen and (max-width: 767px){
    .ui.small.modal {
      width: 92%;
      margin: 0 0 0 -47.5% !important;
      position:fixed !important;
    }
  }
  
  .ui.modal>.container{
    background-color: #F4F4F4;
  }
  .ui.modal>.container .content {
    padding: 1em;
  }
  .ui.form .field>.selection.dropdown{
    width:49%;
    min-width:3em !important;
  }
  
  #mmfoot{
	  display:none;
  }
  .addflex{
	  display: flex;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: -webkit-box;
      align-items: center;
      -webkit-box-align: center;
      padding: 0.7145rem;
	  position:fixed;
	  bottom:0;
	  background:#fff;
	  width: 100%;
	  z-index: 3;
	  max-width:767px;
	  margin:0 auto;
  }
  .addflex .addadress{
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      -webkit-flex-basis: 0;
      -ms-flex-preferred-size: 0;
      flex-basis: 0;
      flex-grow: 1;
	  font-size:1rem;
	  color:#be8914;
	  text-align:center;
	  line-height:2.1435rem;
  }
  .leftadd{
	  max-width:767px;
	  margin:0 auto;
	  background: #f5f5f5;
      position: fixed;
      width: 100%;
      height: 100%;
      bottom: 0;
      z-index: 100;
      visibility: hidden;
      -webkit-transform: translate3d(100%,0,0);
      transform: translate3d(100%,0,0);
      -webkit-transition: all 0.3s ease 0.05s;
      transition: all 0.3s ease 0.05s;
      padding: 0.35725rem 0;
  }
  .addshow .leftadd{
	  visibility: visible;
      -webkit-transform: translate3d(0,0,0);
      transform: translate3d(0,0,0);
  }
  .leftadd .ui.header{
	  font-weight:400;
  }
  .ui.form textarea.small{
      height: 4rem;
      min-height: 4rem;
  }
  .ui.toggle.checkbox input:checked~.box:before, .ui.toggle.checkbox input:checked~label:before{
  	  background-color:#21BA45;
  }
  .nextbtn{
	  display: flex;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: -webkit-box;
      align-items: center;
      -webkit-box-align: center;
	  position:fixed;
	  bottom:0;
	  left:0;
	  width: 100%;
	  z-index: 3;
  }
  .nextbtn .close-btn{
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      -webkit-flex-basis: 0;
      -ms-flex-preferred-size: 0;
      flex-basis: 0;
      flex-grow: 1;
	  font-size:1rem;
	  background: #fff;
	  text-align:center;
	  line-height:2.1435rem;
      padding: 0.7145rem;
  }
  .nextbtn .submit{
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      -webkit-flex-basis: 0;
      -ms-flex-preferred-size: 0;
      flex-basis: 0;
      flex-grow: 1;
	  font-size:1rem;
	  background:#be8914;
	  color:#fff;
	  text-align:center;
	  line-height:2.1435rem;
	  padding: 0.7145rem;
  }
  
  .addressitem{
      display: block;
      padding: 0 !important;
	  margin-bottom:4rem;
  }
  .addressitem .item{
	  border-bottom: 1px solid rgba(0,0,0,0.1);
      margin-bottom: 0.71428571rem!important;
  }
  .item .content{
      display: flex;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: -webkit-box;
      align-items: center;
      -webkit-box-align: center;
      padding: 0.7145rem;
	  background: #fff;
      border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  .actions{
	  display: flex;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: -webkit-box;
      align-items: center;
      -webkit-box-align: center;
      padding: 0.7145rem;
      background: #fff;
      background: #fff;
  }
  .actions .revise{
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      -webkit-flex-basis: 0;
      -ms-flex-preferred-size: 0;
      flex-basis: 0;
      flex-grow: 1;
      text-align: right;
  }
  .addr{
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      -webkit-flex-basis: 0;
      -ms-flex-preferred-size: 0;
      flex-basis: 0;
      flex-grow: 1;
      position: relative;
      margin-left: 0.35725rem;
	  color: #5d6266;
  }
  .addr span{
	  font-size:0.92885rem;
	  padding:0.07145rem 0;
	  display:block;
  }
  .choose.province,.choose.city,.choose.county,.choose.town{
	  cursor: pointer;
      word-wrap: break-word;
      line-height: 1em;
      white-space: normal;
      outline: 0;
      -webkit-transform: rotateZ(0);
      transform: rotateZ(0);
      height: 2.7142rem;
      color: rgba(0,0,0,.87);
      box-shadow: none;
      border: 1px solid rgba(34,36,38,.15);
      border-radius: .28571429rem;
      -webkit-transition: box-shadow .1s ease,width .1s ease;
      transition: box-shadow .1s ease,width .1s ease;
      background: #fff !important;
      display: inline-block !important;
	  width:49% !important;
	  height: 2.7142em !important;
	  margin-bottom:8px;
  }
  .choose:hover,.choose:focus {
      border-color: rgba(34,36,38,.35);
      box-shadow: none;
  }
  .choose.city,.choose.town{
	  float:right;
  }
  .sfooter.nav-menu{
  display: none;
  visibility: hidden;
}
.color-be.link{
  color:#be8914 !important;
}
.color-be.inverted.button{
  background:#be8914 !important;
  color: #fff !important;
}
@media only screen and (min-height: 500px){
    .leftadd {
        overflow: scroll;
    }

    .nextbtn {
        position: relative;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 3;
    }
}
</style>
{% endblock %}

{% block layout_js %}
<script type="text/javascript">

  var page = 1;
  var size = 10;
  var sort = 0;
  var type = 0;

  // 判断来源
  var order_rid = "{{ rid|default '' }}";

  // ajax 加载地址模板
  function load_address_mode(id){

    $.post("{{ app_url_wap }}/app/site/delivery_address/ajax_edit_address", {id: id}, function(result){
      if(result.success){
        result.data.app_url_wap = "{{ app_url_wap }}";
        var rendered = phenix.ajax_render_result('#sign_address_tpl', result.data);
        if(id==''){
            ajax_load_city(0,0,0,0);
        }else{
            ajax_load_city(result.data.province_id, result.data.city_id, result.data.county_id, result.data.town_id);          
        }

        $('#addbook-form-box').html(rendered); 
        $('#shipping').addClass('addshow');

      }else{
        //phenix.show_error_note(result.message, 3000);
      }
    }, 'json');
  }

  // ajax 加载地址列表-- remove
  function load_address_list(order_rid){
    $.post("{{ app_url_wap }}/app/site/address/ajax_fetch_list", {order_rid: order_rid}, function(result){
      if(result.success){
        result.data.app_url_wap = "{{ app_url_wap }}";
        result.data.results.app_url_packaged = "{{ app_url_packaged }}";
        if(order_rid != ''){
          result.data.is_from_order = true;
          result.data.rrid = order_rid;
        }else{
          result.data.is_from_order = false;
          result.data.rrid = '';       
        }
        var rendered = phenix.ajax_render_result('#fetch_address_list_tpl', result.data);
        $('#address-list-box').html(rendered); 
      }else{
        //phenix.show_error_note(result.message, 3000);
      }
    }, 'json');
  }

  
      // 加载地址列表
      function ajax_load_more(type, sort, page, size){

          var url = '{{ app_url_wap }}/app/site/delivery_address/ajax_load_more';
          $.get(url, { sort:sort, page:page, type:type, size:size }, function(rs){

            rs.data.app_url_wap = "{{ app_url_wap }}";
            rs.data.app_url_packaged = "{{ app_url_packaged }}";
            if(order_rid != ''){
              rs.data.is_from_order = true;
              rs.data.rrid = order_rid;
            }else{
              rs.data.is_from_order = false;
              rs.data.rrid = '';       
            }

              var rendered = phenix.ajax_render_result('#fetch_address_list_tpl', rs.data);
              if(page==1){
                $('#address-list-box').html(rendered);
              }else{
                $('#address-list-box').append(rendered);
              }

          }, 'json');
      }





  // ajax 加载省份城市
  function ajax_fetch_district(p_id, d_id){
    $.get('{{ app_url_wap }}/app/site/address/ajax_fetch_cities', {id: p_id, district_id: d_id}, function(result){
      if(result.success){
        var districts = result.data;
        var html = '';
        for(var i=0;i<districts.length;i++){
          if(districts[i]['active']){
            html += '<option value="'+ districts[i]['_id'] +'" selected="selected">'+ districts[i]['city'] +'</option>';
          }else{
            html += '<option value="'+ districts[i]['_id'] +'">'+ districts[i]['city'] +'</option>';
          }
        }
        $('#district-menu').html(html);
      }else{
        //phenix.show_error_note(result.message, 3000);
      }
    }, 'json');
  }

    // 加载城市列表
    function ajax_load_city(province_id, city_id, county_id, town_id){
        var url = '{{ app_url_wap }}/app/site/delivery_address/ajax_fetch_city';

        // 一级
        $.get(url, { pid:0, layer:1 }, function(rs){
            if(rs.success){
                fetch_province(province_id, rs.data);
                // 二级
                if(province_id){
                    $.get(url, {pid:province_id, layer:2}, function(rs){
                        if(rs.success){
                            fetch_city(province_id, city_id, rs.data);
                            // 三级
                            if(city_id){
                                $.get(url, {pid:city_id, layer:3}, function(rs){
                                    if(rs.success){
                                        fetch_county(city_id, county_id, rs.data);
                                        //  四级
                                        if(county_id){
                                            $.get(url, {pid:county_id, layer:4}, function(rs){
                                                if(rs.success){
                                                    fetch_town(county_id, town_id, rs.data);
                                                }
                                            }, 'json')                           
                                        }

                                    }
                                }, 'json')                           
                            }

                        }
                    }, 'json')
                }
        
            }else{
                phenix.show_error_note('获取城市失败');
            }    

        }, 'json');
    
    }


    // 渲染一级
    function fetch_province(province_id, data){

        var obj = $('#province_box');
        obj.val(province_id);
        $('select[name=city_id]').val(0);
        $('select[name=county_id]').val(0);
        $('select[name=town_id]').val(0);
        if(!data){
            return false;
        }
        $('#county_box').hide();
        $('#town_box').hide();
        var html = '<option value="0" >--请选择--</option>';
        for(var i=0;i<data.length;i++){
            if(data[i]['oid']==province_id){
                var active = 'selected="selected"';
            }else{
                var active = '';
            }
            html += '<option value="'+ data[i]['oid'] +'" '+ active +' >'+ data[i]['name'] +'</option>';
        }
        obj.html(html);
    
    }

    // 渲染二级
    function fetch_city(province_id, city_id, data){

        var obj = $('#city_box');
        obj.find('select[name=city_id]').val(city_id);
        $('select[name=county_id]').val(0);
        $('select[name=town_id]').val(0);
        if(!data){
            return false;
        }
        obj.show();
        $('#county_box').hide();
        $('#town_box').hide();
        var html = '<option value="0" >--请选择--</option>';
        for(var i=0;i<data.length;i++){
            if(data[i]['oid']==city_id){
                var active = 'selected="selected"';
            }else{
                var active = '';
            }
            html += '<option value="'+ data[i]['oid'] +'" '+ active +' >'+ data[i]['name'] +'</option>';
        }
        obj.html(html);
    }

    // 渲染三级
    function fetch_county(city_id, county_id, data){
        var obj = $('#county_box');
        obj.find('select[name=county_id]').val(county_id);
        $('select[name=town_id]').val(0);
        if(!data){
            return false;
        }
        obj.show();
        $('#town_box').hide();
        var html = '<option value="0" >--请选择--</option>';
        for(var i=0;i<data.length;i++){
            if(data[i]['oid']==county_id){
                var active = 'selected="selected"';
            }else{
                var active = '';
            }
            html += '<option value="'+ data[i]['oid'] +'" '+ active +' >'+ data[i]['name'] +'</option>';
        }
        obj.html(html);
    }

    // 渲染四级
    function fetch_town(county_id, town_id, data){
        var obj = $('#town_box');
        obj.find('select[name=town_id]').val(town_id);
        if(!data){
            return false;
        }
        obj.show();
        var html = '<option value="0" >--请选择--</option>';
        for(var i=0;i<data.length;i++){
            if(data[i]['oid']==town_id){
                var active = 'selected="selected"';
            }else{
                var active = '';
            }
            html += '<option value="'+ data[i]['oid'] +'" '+ active +' >'+ data[i]['name'] +'</option>';
        }
        obj.html(html);
    }

    // 清空下拉列表数据
    function clean_select(){
        var obj = $('#province_box');
        $('select[name=province_id]').val(0);
        var obj = $('#city_box');
        $('select[name=city_id]').val(0);
        obj.hide();
        var obj = $('#county_box');
        $('select[name=county_id]').val(0);
        obj.hide();
        var obj = $('#town_box');
        $('select[name=town_id]').val(0);
        obj.hide();
        
    }

</script>
{% endblock %}

{% block jquery %}

	$('.addflex').bind('click',function(){
        load_address_mode('');
	});

	$('.leftadd .close-btn').livequery(function(){
    $(this).bind('click',function(){
      $('#shipping').removeClass('addshow');
    });
	});
	// 编辑
	$('.ui.edit.button').livequery(function(){
    $(this).click(function(){
      var address_id = $(this).data('id');
      load_address_mode(address_id);
    });  
	});
	// 显示地址框
	$('.ui.addbook.add.button').click(function(){
        $('#addbook-form').clearForm();
        $('#addbook-form').find('[name=_id]').val('');
		$('.ui.addbook.add.modal').modal('show');

	});
	// 关闭地址框
	$('.ui.close-btn.button').click(function(){
		$('.ui.addbook.modal').modal('hide');
	});

	// 获取城市
	$('#province-menu').livequery(function(){
    $(this).change(function(){
      var p_id = $(this).val();
      ajax_fetch_district(p_id, 0);
    });
  });
	
	$('#addbook-form').livequery(function(){
		$(this).form({
			name: {
				identifier  : 'name',
				rules: [
					{
						type   : 'empty',
						prompt : '收货人姓名不能为空'
					}
				]
			},
			phone: {
				identifier  : 'password',
				rules: [
					{
						type   : 'empty',
						prompt : '联系电话不能为空'
					},
					{
						type   : 'length[11]',
						prompt : '联系电话必须11位字符'
					}
				]
			},
			address: {
				identifier  : 'address',
				rules: [
					{
						type   : 'empty',
						prompt : '地址区域不能为空'
					}
				]
			}

		}, {
			inline : true,
			onSuccess: function(event){
			  event.preventDefault();
                $(this).ajaxSubmit({
                    dataType: 'json',
                    beforeSubmit: function(){
                        phenix.before_submit();
                    },
                    success: function(rs){
                        if(rs.is_error){
                          phenix.after_submit();
                            $(event.target).addClass('error');
                            phenix.show_error_note(rs.message, event.target);
                        }else{
                            $('#shipping').removeClass('addshow');
                            clean_select();
                            //$('#addbook-form').clearForm();
                            phenix.after_submit();
                            if(rs.data.is_default==1){
                                $('.delivery_address_list').removeClass('active');
                                $('.is-default').hide();
                            }

                            if(order_rid != ''){
                              rs.data.is_from_order = true;
                              rs.data.rrid = order_rid;
                            }else{
                              rs.data.is_from_order = false;
                              rs.data.rrid = '';       
                            }
                            rs.data.app_url_packaged = "{{ app_url_packaged }}";
                            var rendered = phenix.ajax_render_result('#fetch_address_tpl', rs.data);
                            if(rs.data.mode=='create'){
                                $('#address-list-box').prepend(rendered);
                            }else{
                                $('#item-'+rs.data._id).replaceWith(rendered);
                            }

                        }
                    }
                });
			}
		});
	});
	
	$('.ui.cancel.button').livequery(function(){
		$(this).click(function(){
			$('#edit-form-box').empty();
		});
	});
	
	// 删除
	$('.ui.remove.button').livequery(function(){
    $(this).bind('click', function(){
      var id = $(this).data('id');
      if(confirm('确认执行这个删除操作吗?')){
        $.post('{{ app_url_wap }}/app/site/delivery_address/deleted', {id: id}, function(result){
          if (result.success){
            $('#item-'+result.data.id).remove();
          } else {
            phenix.show_error_note(result.message, 3000);
          }
        }, 'json');
          }
      return false;
    });
	});

	// 初始加载列表
    ajax_load_more(type, sort, page, size);

    // 二级
	$('#province_box').livequery(function(){
        $(this).change(function(){
            var url = '{{ app_url_wap }}/app/site/delivery_address/ajax_fetch_city';
            var pid = $(this).val();
            $.get(url, {pid: pid, layer:2}, function(rs){
                if(rs.success){
                    fetch_city(pid, 0, rs.data);
                }
            }, 'json');
        });
	});
	
    // 三级
	$('#city_box').livequery(function(){
        $(this).change(function(){
            var url = '{{ app_url_wap }}/app/site/delivery_address/ajax_fetch_city';
            var pid = $(this).val();
            $.get(url, {pid: pid, layer:3}, function(rs){
                if(rs.success){
                    fetch_county(pid, 0, rs.data);
                }
            }, 'json');
		});
	});

    // 四级
	$('#county_box').livequery(function(){
        $(this).change(function(){
            var url = '{{ app_url_wap }}/app/site/delivery_address/ajax_fetch_city';
            var pid = $(this).val();
            $.get(url, {pid: pid, layer:4}, function(rs){
                if(rs.success){
                    fetch_town(pid, 0, rs.data);
                }
            }, 'json');
		});
	});
	
{% endblock %}

{% block content %}
<div class="ui fiushop pb-0">
    <div class="ui sheader">
        <p>我的地址</p>
    </div>
</div>
<div class="ui responsive grid mt-2r" id="shipping">
	<div class="row">
		<div class="column p-0">
			<div class="addressitem" id="address-list-box">
        <!--ajax load list-->
			</div>
      <div class="addflex" id="create-new-address" data-id="0">
        <div class="addadress">
          + 添加地址
        </div>
      </div>
			
		</div>
	</div>
	
	<div class="leftadd p_50" id="addbook-form-box">
		
	</div>
	
</div>

{% endblock %}

{% block templates %}
{% mustache id:'sign_address_tpl' tpl:'mustache_m/sign_address.mustache' %}
{% mustache id:'fetch_address_list_tpl' tpl:'mustache_m/fetch_address_list.mustache' %}
{% mustache id:'fetch_address_tpl' tpl:'mustache_m/delivery_address.mustache' %}
{% endblock %}
