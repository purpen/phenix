{%extends 'layout/mobile.html'%}
{% block title%}收货地址管理-{% endblock %}
{% block page_css %}
<style type="text/css">
#mfrbird{
	margin-top:0;
	margin-bottom:3rem;
}
h3.ui.header{
	font-weight:400;
}
  @media only screen and (max-width: 767px){
    .ui.small.modal {
      width: 92%;
      margin: 0 0 0 -47.5% !important;
      position:fixed !important;
    }
  }
  
  .ui.modal>.container{
    background-color: #F4F4F4;
  }
  .ui.modal>.container .content {
    padding: 1em;
  }
  .ui.form .field>.selection.dropdown{
    width:49%;
    min-width:3em !important;
  }
  
  #mmfoot{
	  display:none;
  }
  .addflex{
	  display: flex;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: -webkit-box;
      align-items: center;
      -webkit-box-align: center;
      padding: 0.7145rem;
	  position:fixed;
	  bottom:0;
	  background:#fff;
	  width: 100%;
	  z-index: 3;
	  max-width:767px;
	  margin:0 auto;
  }
  .addflex .addadress{
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      -webkit-flex-basis: 0;
      -ms-flex-preferred-size: 0;
      flex-basis: 0;
      flex-grow: 1;
	  font-size:1rem;
	  color:#f36;
	  text-align:center;
	  line-height:2.1435rem;
  }
  .leftadd{
	  max-width:767px;
	  margin:0 auto;
	  background: #f5f5f5;
      position: fixed;
      width: 100%;
      height: 100%;
      bottom: 0;
      z-index: 100;
      visibility: hidden;
      -webkit-transform: translate3d(100%,0,0);
      transform: translate3d(100%,0,0);
      -webkit-transition: all 0.3s ease 0.05s;
      transition: all 0.3s ease 0.05s;
      padding: 0.35725rem 0;
  }
  .addshow .leftadd{
	  visibility: visible;
      -webkit-transform: translate3d(0,0,0);
      transform: translate3d(0,0,0);
  }
  .leftadd .ui.header{
	  font-weight:400;
  }
  .ui.form textarea.small{
      height: 4rem;
      min-height: 4rem;
  }
  .ui.toggle.checkbox.checked input:checked~label:before{
	  background-color:#21BA45;	
  }
  .nextbtn{
	  display: flex;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: -webkit-box;
      align-items: center;
      -webkit-box-align: center;
	  position:fixed;
	  bottom:0;
	  left:0;
	  width: 100%;
	  z-index: 3;
  }
  .nextbtn .close-btn{
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      -webkit-flex-basis: 0;
      -ms-flex-preferred-size: 0;
      flex-basis: 0;
      flex-grow: 1;
	  font-size:1rem;
	  background: #fff;
	  text-align:center;
	  line-height:2.1435rem;
      padding: 0.7145rem;
  }
  .nextbtn .submit{
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      -webkit-flex-basis: 0;
      -ms-flex-preferred-size: 0;
      flex-basis: 0;
      flex-grow: 1;
	  font-size:1rem;
	  background:#f36;
	  color:#fff;
	  text-align:center;
	  line-height:2.1435rem;
	  padding: 0.7145rem;
  }
  
  .addressitem{
      display: block;
      padding: 0 !important;
  }
  .addressitem .item{
	  border-bottom: 1px solid rgba(0,0,0,0.1);
      margin-bottom: 0.71428571rem!important;
  }
  .item .content{
      display: flex;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: -webkit-box;
      align-items: center;
      -webkit-box-align: center;
      padding: 0.7145rem;
	  background: #fff;
      border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  .actions{
	  display: flex;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: -webkit-box;
      align-items: center;
      -webkit-box-align: center;
      padding: 0.7145rem;
      background: #fff;
      background: #fff;
  }
  .actions .revise{
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      -webkit-flex-basis: 0;
      -ms-flex-preferred-size: 0;
      flex-basis: 0;
      flex-grow: 1;
      text-align: right;
  }
  .addr{
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      -webkit-flex-basis: 0;
      -ms-flex-preferred-size: 0;
      flex-basis: 0;
      flex-grow: 1;
      position: relative;
      margin-left: 0.35725rem;
  }
  .addr span{
	  font-size:0.92885rem;
	  padding:0.07145rem 0;
	  display:block;
  }
  .choose.province,.choose.city{
	  cursor: pointer;
      word-wrap: break-word;
      line-height: 1em;
      white-space: normal;
      outline: 0;
      -webkit-transform: rotateZ(0);
      transform: rotateZ(0);
      height: 2.7142rem;
      color: rgba(0,0,0,.87);
      box-shadow: none;
      border: 1px solid rgba(34,36,38,.15);
      border-radius: .28571429rem;
      -webkit-transition: box-shadow .1s ease,width .1s ease;
      transition: box-shadow .1s ease,width .1s ease;
      background: #fff !important;
      display: inline-block !important;
	  width:49% !important;
	  height: 2.7142em !important;
	  margin-bottom:8px;
  }
  .choose:hover,.choose:focus {
      border-color: rgba(34,36,38,.35);
      box-shadow: none;
  }
  .choose.city{
	  float:right;
  }
</style>
{% endblock %}

{% block layout_js %}
<script type="text/javascript">

  // ajax 加载地址模板
  function load_address_mode(id){

    $.post("{{ app_url_wap }}/app/site/address/ajax_edit_address", {id: id}, function(result){
      if(result.success){
        result.data.app_wap_url = "{{ app_url_wap }}";
        var rendered = phenix.ajax_render_result('#sign_address_tpl', result.data);

        $('#addbook-form-box').html(rendered); 
        $('#shipping').addClass('addshow');
        var p_id = $('#province-menu').val();
        if(p_id){
          ajax_fetch_district(p_id, result.data.city);
        }
      }else{
        phenix.show_error_note(result.message, 3000);
      }
    }, 'json');
  }

  // ajax 加载省份城市
  function ajax_fetch_district(p_id, d_id){
    $.get('{{ app_url_wap }}/app/site/address/ajax_fetch_cities', {id: p_id, d_id: d_id}, function(result){
      if(result.success){
        var districts = result.data;
        var html = '';
        for(var i=0;i<districts.length;i++){
          if(districts[i]['active']){
            html += '<option value="'+ districts[i]['_id'] +'" selected="selected">'+ districts[i]['city'] +'</option>';
          }else{
            html += '<option value="'+ districts[i]['_id'] +'">'+ districts[i]['city'] +'</option>';
          }
        }
        $('#district-menu').html(html);
      }else{
        phenix.show_error_note(result.message, 3000);
      }
    }, 'json');
  }

</script>
{% endblock %}

{% block jquery %}
	$('.addflex').bind('click',function(){
    load_address_mode('');
	});

	$('.leftadd .close-btn').livequery(function(){
    $(this).bind('click',function(){
      $('#shipping').removeClass('addshow');
    });
	});
	// 编辑
	$('.ui.edit.button').livequery(function(){
    $(this).click(function(){
      var address_id = $(this).data('id');
      load_address_mode(address_id);
    });  
	});
	// 显示地址框
	$('.ui.addbook.add.button').click(function(){
    $('#addbook-form').clearForm();
		$('.ui.addbook.add.modal').modal('show');

	});
	// 关闭地址框
	$('.ui.close-btn.button').click(function(){
		$('.ui.addbook.modal').modal('hide');
	});

	// 获取城市
	$('#province-menu').livequery(function(){
    $(this).change(function(){
      var p_id = $(this).val();
      ajax_fetch_district(p_id, 0);
    });
  });
	
	$('#addbook-form').livequery(function(){
		$(this).form({
			name: {
				identifier  : 'name',
				rules: [
					{
						type   : 'empty',
						prompt : '收货人姓名不能为空'
					}
				]
			},
			phone: {
				identifier  : 'password',
				rules: [
					{
						type   : 'empty',
						prompt : '联系电话不能为空'
					},
					{
						type   : 'length[11]',
						prompt : '联系电话必须11位字符'
					}
				]
			},
			address: {
				identifier  : 'address',
				rules: [
					{
						type   : 'empty',
						prompt : '地址区域不能为空'
					}
				]
			},
			zip: {
				identifier  : 'zip',
				rules: [
					{
						type   : 'empty',
						prompt : '邮政编码不能为空'
					}
				]
			}
		}, {
			inline : true,
			onSuccess: function(event){
			event.preventDefault();
        $(this).ajaxSubmit({
          dataType: 'json',
          beforeSubmit: function(){
            //phenix.before_submit();
          },
          success: function(data){
            if(data.is_error){
              //phenix.after_submit();
              $(event.target).addClass('error');
              phenix.show_error_note(data.message, event.target);
            }else{
              $('#shipping').removeClass('addshow');
            }
          }
        });
			}
		});
	});
	
	$('.ui.cancel.button').livequery(function(){
		$(this).click(function(){
			$('#edit-form-box').empty();
		});
	});
	
	// 删除
	$('.ui.remove.button').livequery(function(){
    $(this).bind('click', function(){
      var id = $(this).data('id');
      if(confirm('确认执行这个删除操作吗?')){
        $.post('{{ app_url_wap }}/app/site/address/remove_address', {id: id}, function(result){
          if (result.success){
            $('#'+result.data.id).remove();
          } else {
            phenix.show_error_note(result.message, 3000);
          }
        }, 'json');
          }
      return false;
    });
	});
	
{% endblock %}

{% block content %}
<div class="ui responsive grid mt-2r" id="shipping">
	<div class="row">
		<div class="column">
			<h3 class="ui header">管理收货地址</h3>
		</div>
	</div>
	
	<div class="row">
		<div class="column p-0">
			<div class="addressitem">
				{% addbooks_list var:'addresses' user_id:user.id size:8 %}
				{% for address in addresses.rows %}
				<div class="item {% if address.is_default %}active {% endif %}" id="{{ address._id }}" data-id="{{ address._id }}">
					<div class="content">
						<div class="addr">
							<h5 class="ui header pt-r mb-2r">{{ address.name }}</h5>
							<span>{{ address.area_province.city}} {{ address.area_district.city }}</span>
							<span> {{ address.address }} </span>
							<span>{{ address.phone }}</span>
						</div>
						
					</div>
					<div class="actions">
						{% if address.is_default == 1 %}
						<img src="{{ app_url_packaged }}/images/icon/is_default.png" width="71">
						{% endif %}
						<div class="revise">
							<a class="ui small gray icon edit button" data-id="{{ address._id }}">
								<i class="edit icon"></i>&nbsp;&nbsp;编辑
							</a>
							<a class="ui small gray icon remove button" data-id="{{ address._id }}">
								<i class="remove icon"></i>&nbsp;&nbsp;删除
							</a>
						</div>
					</div>
					
				</div>
				
				{% endfor %}
				
				
				
				<div class="addflex" id="create-new-address" data-id="0">
					<div class="addadress">
						+ 添加地址
					</div>
				</div>
			</div>
			
			
		</div>
	</div>
	
	<div class="leftadd" id="addbook-form-box">
    <!--
		<div class="ui grid m-0">
			<div class="row">
				<div class="column">
					<h4 class="ui header dividing pb-r mt-r">使用新地址</h4>
				</div>
			</div>
			
			<div class="row pt-0">
				<div class="column">
					<form action="{{ app_url_wap }}/app/site/address/ajax_save_address" class="ui form" method="post" id="addbook-form">
						<input type="hidden" name="_id" />
						<input type="hidden" name="plat" value="{{ plat }}" />
						<div class="field mb-2r">
							<h5 class="ui header mtb-r">收货人姓名</h5>
					  		<input type="text" name="name" />
						</div>
						<div class="field mb-2r">
							<h5 class="ui header mtb-r">联系电话</h5>
						  	<input type="text" name="phone" placeholder="11位手机号码" />
						</div>
						<div class="field mb-2r">
							<h5 class="ui header mtb-r">邮政编码</h5>
						  	<input type="text" name="zip" />
						</div>
						
						<div class="field mb-2r">
							<h5 class="ui header mtb-r">地址</h5>
							
							
							  <select name="province" value="{{ addbook.province }}" class="choose province">
								 
	  						  {% for province in provinces %}
	                <option{%if province._id==visitor.profile.province_id%} selected="selected"{%endif%} value="{{ province._id }}">{{ province.city }}</option>
	  						  {% endfor %}
	  						</select>
			
							  <select name="district" id="district-menu" value="{{ addbook.city }}" class="choose city">
	  						  {% for district in districts %}
	  						    <option {%if province._id==visitor.profile.district_id%} selected="selected"{%endif%} value="{{ district._id }}">{{ district.city }}</option>
	  						  {% endfor %}
							 </select>
							
						</div>
						
						<div class="field mb-3r">
							<textarea name="address" class="small">{{ addbook.address }}</textarea>
						</div>
						
		        		<div class="inline field">
							<div class="ui toggle checkbox {% if addbook.is_default == 1 %} checked {%endif%}">
								<input name="is_default" type="checkbox" {%if addbook.is_default==1%}checked="checked"{%endif%} value="1">
								<label>设为默认地址</label>
						    </div>
						</div>
			
						<div class="nextbtn">
							<div class="close-btn">
								取消
							</div>	
							<div class="submit">
								提交
							</div>
						</div>
			
					</form>
			
				</div>
			</div>
			
		</div>
    -->
		
	</div>
	
</div>

{% endblock %}

{% block templates %}
{% mustache id:'sign_address_tpl' tpl:'mustache_m/sign_address.mustache' %}
{% endblock %}
