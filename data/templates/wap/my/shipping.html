{%extends 'layout/mobile.html'%}
{% block title%}收货地址管理-{% endblock %}
{% block page_css %}
<style type="text/css">
#mfrbird{
	margin-top:0;
}
h3.ui.header{
	font-weight:400;
}
  @media only screen and (max-width: 767px){
    .ui.small.modal {
      width: 92%;
      margin: 0 0 0 -47.5% !important;
      position:fixed !important;
    }
  }
  #addbook-form-box{
    margin: 0 0 0 -47.5% !important;
    position:relative !important;
  }
  .ui.modal>.container{
    background-color: #F4F4F4;
  }
  .ui.modal>.container .content {
    padding: 1em;
  }
  .ui.form .field>.selection.dropdown{
    width:49%;
    min-width:3em !important;
  }
  
  #mmfoot{
	  display:none;
  }
  .addflex{
	  display: flex;
      display: -ms-flexbox;
      display: -webkit-flex;
      display: -webkit-box;
      align-items: center;
      -webkit-box-align: center;
      padding: 0.7145rem;
	  position:fixed;
	  bottom:0;
	  left:0;
	  background:#fff;
	  width: 100%;
	  z-index: 3;
  }
  .addflex .addadress{
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      -ms-flex: 1;
      flex: 1;
      -webkit-flex-basis: 0;
      -ms-flex-preferred-size: 0;
      flex-basis: 0;
      flex-grow: 1;
	  font-size:1rem;
	  color:#f36;
	  text-align:center;
	  line-height:2.1435rem;
  }
</style>
{% endblock %}

{% block jquery %}
	$('.ui.responsive.grid.mt-2r').css('min-height',document.documentElement.clientHeight-230);
	// 编辑
	$('.ui.addbook.edit.button').click(function(){
	  $('.ui.addbook.edit.modal').modal('show');
	});
	// 显示地址框
	$('.ui.addbook.add.button').click(function(){
    $('#addbook-form').clearForm();
		$('.ui.addbook.add.modal').modal('show');

	});
	// 关闭地址框
	$('.ui.close-btn.button').click(function(){
		$('.ui.addbook.modal').modal('hide');
	});
	
	$('#addbook-form').livequery(function(){
		$(this).form({
			name: {
				identifier  : 'name',
				rules: [
					{
						type   : 'empty',
						prompt : '收货人姓名不能为空'
					}
				]
			},
			phone: {
				identifier  : 'password',
				rules: [
					{
						type   : 'empty',
						prompt : '联系电话不能为空'
					},
					{
						type   : 'length[11]',
						prompt : '联系电话必须11位字符'
					}
				]
			},
			address: {
				identifier  : 'address',
				rules: [
					{
						type   : 'empty',
						prompt : '地址区域不能为空'
					}
				]
			},
			zip: {
				identifier  : 'zip',
				rules: [
					{
						type   : 'empty',
						prompt : '邮政编码不能为空'
					}
				]
			}
		}, {
			inline : true,
			onSuccess: function(event){
				event.preventDefault();
				$(this).ajaxSubmit();
			}
		});
	});
	
	$('.ui.province.dropdown').livequery(function(){
		$(this).dropdown({
			onChange : function(value, text){
				if (value) {
					$.get('{{ app_url_wap }}/app/site/address/ajax_fetch_districts', {id: value});
				}
			}
		});
	});
	
	$('.ui.district.dropdown').livequery(function(){
		$(this).dropdown();
	});
	
	$('.ui.cancel.button').livequery(function(){
		$(this).click(function(){
			$('#edit-form-box').empty();
		});
	});
	
	// 编辑
	$('.ui.edit.button').livequery(function(){
    $(this).bind('click', function(){
      var id = $(this).data('id');
      $.post('{{ app_url_wap }}/app/site/address/edit_address', {id: id, plat:'mobile'});
      return false;
    });
	});
	
	// 删除
	$('.ui.remove.button').livequery(function(){
    $(this).bind('click', function(){
      var id = $(this).data('id');
      if(confirm('确认执行这个删除操作吗?')){
        $.post('{{ app_url_wap }}/app/site/address/remove_address', {id: id}, function(result){
          if (result.success){
            if ($('#'+result.data.id).hasClass('active')) {
              // 清空默认值
              $('#addbook_default_id').val('');
            }
            $('#'+result.data.id).remove();
          } else {
            phenix.show_error_note(result.message, 5000);
          }
        }, 'json');
          }
      return false;
    });
	});
	
{% endblock %}

{% block content %}
<div class="ui responsive grid mt-2r">
	<div class="row">
		<div class="column">
			<h3 class="ui header">管理收货地址</h3>
		</div>
	</div>
	
	<div class="">
		
	</div>
	
	<div class="addflex">
		<div class="addadress">
			+ 添加地址
		</div>
	</div>
	
	<!--<div class="row">
		<div class="column">
			{% addbooks_list var:'addresses' user_id:user.id size:8 %}
			{% for address in addresses.rows %}
		  	<div class="ui {% if address.is_default %}active {% endif %}segment" id="{{ address._id }}" data-id="{{ address._id }}">
				<h4 class="ui dividing header">
					<i class="map marker icon"></i> <span class="name">{{ address.name }}</span>
				</h4>
				<p>{{ address.phone }}</p>
				<p>{{ address.area_province.city}} {{ address.area_district.city }}<br /> {{ address.address }} <span>({{ address.zip }})</span></p>
				
				<div class="actions">
					<a class="ui small gray icon edit button" data-id="{{ address._id }}">
						<i class="edit icon"></i>
					</a>
					<a class="ui small gray icon remove button" data-id="{{ address._id }}">
						<i class="remove icon"></i>
					</a>
				</div>
		  	</div>
			{% endfor %}
			<div class="ui center aligned segment" id="create-new-address" data-id="0">
				<a class="ui magenta addbook add button" href="javascript:void(0);">
					<i class="edit icon"></i> 添加新地址
				</a>
			</div>
		</div>
	</div>-->
</div>

<!--弹出地址框-->
<div class="ui small addbook add modal" id="addbook-form-box">
  	<i class="close icon"></i>
	<div class="ui header">
    	使用新地址
  	</div>
	<div class="container">
		<form action="{{ app_url_wap }}/app/site/address/ajax_address" class="ui form" method="post" id="addbook-form">
		  	<div class="content">
				<input type="hidden" name="_id" />
				<input type="hidden" name="plat" value="{{ plat }}" />
				
				<div class="two fields">
					<div class="field">
						<label>收货人姓名</label>
				  		<input type="text" name="name" />
					</div>
				</div>
				
				<div class="two fields">
					<div class="field">
						<label>联系电话</label>
					  	<input type="text" name="phone" placeholder="11位手机号码" />
					</div>
				</div>
				
				<div class="field">
					<label>地址</label>
					<div class="ui selection province dropdown">
						<input type="hidden" name="province" value="{{ addbook.province }}" />
		
					    <div class="default text">省份/自治区</div>
					    <i class="angle dropdown icon"></i>
					    <div class="menu">
							{% for province in provinces %}
					        <div data-value="{{ province._id }}" class="item">{{ province.city }}</div>
							{% endfor %}
					    </div>
					</div>
	
					<div class="ui selection district dropdown" id="district-menu" style="float:right;">
						<input type="hidden" name="city" value="{{ addbook.city }}" />
					    <div class="default text">地区区域</div>
					    <i class="angle dropdown icon"></i>
					    <div class="menu">
							{% for district in districts %}
					        <div data-value="{{ district._id }}" class="item">{{ district.city }}</div>
							{% endfor %}
					    </div>
					</div>
				</div>
				
				<div class="field">
					<textarea name="address" class="small">{{ addbook.address }}</textarea>
				</div>
		
				<div class="two fields">
					<div class="field">
						<label>邮政编码</label>
					  	<input type="text" name="zip" />
					</div>
				</div>

        		<div class="inline field">
					<div class="ui checkbox">
						<input name="is_default" type="checkbox" checked="checked" value="1">
						<label>设为默认地址</label>
				    </div>
				</div>

				<div class="field">
					<div class="ui active magenta submit button">确定</div>
			        <div class="ui gray close-btn black button">取消</div>
				</div>
				
			</div>				
		</form>
	</div>
</div>

{% endblock %}
