{%extends 'layout/mobile.html'%}
{% block title %}{% endblock %}
{% block page_css %}
<style type="text/css">
#mfrbird {
  margin: 0em 0 1em;
}
.tries{
  background:url('http://frstatic.qiniudn.com/images/triesbj.jpg') no-repeat center center /cover;
  padding: 4% 0;
}
.tries .content{
  color:#fff !important;
}
.tries .content .sub.header{
  color:#fff !important;
}
.detext{
  float:right;
  height:100%;
  vertical-align:middle;
  display:inline-block;
  padding: 3px 10px;
  position:relative;
  text-align:center;
  color:#fff;
}
.detext p{
  margin:5px 0;
}
.ui.detext.fans:before {
  background:rgba(255,255,255,0.8);
  height: 70%;
  width: 1px;
  position: absolute;
  content: '';
  top: 15%;
  right: 0;
}
.trycon .ui.segment:first-child .image{
  position:relative;
}
.trycon .ui.segment:first-child .image img{
  border-top-left-radius: .3125em;
  border-top-right-radius: .3125em;
}
.trycon .ui.segment .image .potext{
  position:absolute;
  bottom:4px;
  left:0;
  width:100%;
  height:auto;
  background:rgba(0,0,0,0.3);
  color:#fff;
}
.trycon .ui.segment .image .potext p{
  text-align: left;
  text-overflow: ellipsis;
  white-space: nowrap;
  overflow: hidden;
  margin: 10px;
}
.trycon .ui.segment{
  box-shadow: 0 0px 0px 0 rgba(34,36,38,.15); 
  border: 0px solid rgba(34,36,38,.15);
}
.trycon .cont{
  padding:0px 15px 15px;
}
.user-list .ui.image{
  width:50px;
  height:50px;
  border:2px solid #f5f5f5;
  display:inline-block;
  margin: 3px;
  border-radius:50%;
}
.user-list{
  padding:15px 0;
}
.user-list .userid{
  height: 50px;
  width: 50px;
  border-radius: 50%;
  border: 2px solid #f5f5f5;
  display: inline-block;
  background-size:100%;
  margin:3px;
}

@media only screen and (max-width: 320px){
  .user-list .userid{
    margin:0px !important;
    height: 40px !important;
    width: 40px !important;
  }
}
.barrer {
  background: rgba(0,0,0,0.7);
  position: fixed;
  bottom: 0;
  width: 100%;
  z-index: 12;
}
.subbtn {
  border: 0 none;
  padding: 0;
  display: -moz-box;
  display: -webkit-box;
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
}
.barrer {
  margin: 0;
  height: 72px;
  line-height: 72px;
}
.frideshare {
  background: rgba(0,0,0,0.5);
  position: fixed;
  bottom: 0;
  width: 100%;
  height: 100%;
  z-index: 13;
}
.subbtn .play {
  background: #f36;
}
.barrer a {
  float: right;
  margin: 13px 15px 0 17px;
  color: #fff;
  text-decoration: none;
}
.subbtn a {
  text-align: center;
  height: 46px;
  line-height: 46px;
  color: #fff;
  background: #fe5341;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  -ms-border-radius: 5px;
  -o-border-radius: 5px;
  border-radius: 5px;
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  -ms-flex: 1;
  -moz-flex: 1;
  -o-flex: 1;
  flex: 1;
  display: block;
  font-size: 20px;
}
.barrer a {
  height: 46px;
  line-height: 46px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  -ms-border-radius: 10px;
  -o-border-radius: 10px;
  border-radius: 10px;
}
.subbtn a {
  position: relative;
}
.barrer a {
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  -ms-border-radius: 5px;
  -o-border-radius: 5px;
  border-radius: 5px;
}
.tries .ui.ten.wide .header .content{
  vertical-align: middle;
  white-space: nowrap;
  overflow: hidden;
  width: 60%;
}
#scrollUp{
  display:none !important;
}
</style>
{% endblock %}

{% block layout_js %}
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
    {% if is_69 %}
    var m_name = '急需支持! 我正在申请太火鸟价值4969元宇宙独家首发免费试用,就差你的一票了~';
    {%else%}
    var m_name = '我正在申请【{{ try.short_title }}】免费试用,大家来支持我吧!';
    {%endif%}

    {% if try.cover %}
      {% if is_69 %}
        var img_url = '{{ app_url_packaged }}/images/tushare.jpg';
      {%else%}
        var img_url = '{{ try.cover.thumbnails.resp.view_url }}';
      {%endif%}
    {%else%}
      var img_url = 'http://frstatic.qiniudn.com/images/logo/logo.png';
    {%endif%}
    var link = '{{ app_url_wap }}/try/apply_success?apply_id={{ apply._id }}';
    var descritc_str = '跪求支持!!!';

    wx.config({
        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: '{{ app_id }}', // 必填，公众号的唯一标识
        timestamp: {{ timestamp }}, // 必填，生成签名的时间戳
        nonceStr: '{{ wxnonceStr }}', // 必填，生成签名的随机串
        signature: '{{ wxSha1 }}',// 必填，签名，见附录1
        jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'onMenuShareQQ', 'onMenuShareWeibo', 'hideMenuItems'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });

  wx.ready(function(){
    // 2.1 监听“分享给朋友”，按钮点击、自定义分享内容及分享结果接口
     wx.onMenuShareAppMessage({
      title: m_name,
      desc: descritc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });      

    // 2.2 监听“分享到朋友圈”按钮点击、自定义分享内容及分享结果接口
    wx.onMenuShareTimeline({
      title: m_name,
      desc: descritc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });

    // 2.3 监听“分享到QQ”按钮点击、自定义分享内容及分享结果接口
    wx.onMenuShareQQ({
      title: m_name,
      desc: descritc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });

    // 2.4 监听“分享到微博”按钮点击、自定义分享内容及分享结果接口
    wx.onMenuShareWeibo({
      title: m_name,
      desc: descritc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });
  });

  //记录分享数/同时送积分
  function record_share_num(){
    $('#mask').css('display','none');
  }

  //支持排行
  function fetch_rank(){
    var url = "{{ app_url_wap }}/try/ajax_fetch_rank";
    var apply_id = "{{ apply._id }}";
    $.get(url, {apply_id:apply_id, type:1});
  }

</script>
{% endblock %}

{% block jquery %}

  //弹出登录框
	phenix.wap_show_sign_box('', 1);

$('.showdiv').click(function(){
    $('#mask').css('display','');
});
$('#mask').click(function(){
    $('#mask').css('display','none');
});


$('[data-countdown]').each(function() {
	var $this = $(this), finalDate = $(this).data('countdown');
	$this.countdown(finalDate, function(event) {
		$this.html(event.strftime('%D天%H时%M分钟'));
	});
});

//我要支持
$('.support-btn').click(function(){
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
      phenix.redirect("{{ app_url_wap }}/auth/login_signup");
			return false;
		}
    var url = "{{ app_url_wap }}/try/ajax_support";
    var apply_id = "{{ apply._id }}";
    $.post(url, {apply_id:apply_id, type:1 });
});

//获取支持排行
fetch_rank();

{% endblock %}
{% block content %}
<img src="{{ try.cover.thumbnails.resp.view_url }}" style="display:none;">
<div id="try-success">
  <div class="tries">
    <div class="ui responsive grid">
      <div class="row">
        <div class="ui ten wide column">
          <h3 class="ui header" style="margin-top:0;">
            <img class="ui small avatar image" src="{{ apply.user.big_avatar_url }}" style="width:4em !important;height:4em !important;margin-top:0.25em;">
            <div class="content">{{ apply.user.nickname }}
              <div class="sub header">
                {{ apply.user.ext_state.user_rank.title|default '鸟列兵' }}
              </div>
            </div>
          </h3>
        </div>
        <div class="ui six wide column">
          <div class="ui detext report">
            <p>{{ apply.user.follow_count|default 0 }}</p>
            <p>关注</p>
          </div>
          <div class="ui detext fans">  
            <p>{{ apply.user.fans_count|default 0 }}</p>
            <p>粉丝</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="ui responsive grid trycon">
    <div class="row">
      <div class="column">
        <div class="ui segment" style="padding:0;">
          <div class="image">
            {% if is_69 %}
              <a href="{{ try.wap_view_url }}"><img src="{{ app_url_packaged }}/images/tushare.jpg" width="100%"></a>
            {%else%}
              <a href="{{ try.wap_view_url }}"><img src="{{ try.cover.thumbnails.resp.view_url }}" width="100%"></a>
            {%endif%}
            <div class="potext">
              <p>
                {% if is_69 %}
                  【宇宙独家首发】超级神秘新品
                {%else%}
                  {{ try.title }}
                {%endif%}
              </p>
            </div>
          </div>
          <div class="cont">
            {% if is_69 %}
              <p style="margin-top:6px;">{% if !try.is_end %}Hi，亲爱的小伙伴们！这款太火鸟【宇宙独家首发】的超级神秘新品正在免费试用中，我已申请，离支持结束还有
              <span style="color:#f36;font-weight:700;" data-countdown="{{ try.end_time|date 'Y/m/d H:i:s' }}"></span>，急需你的帮助！互相支持中签机率更加倍哟~ {% else %}支持已结束！{% endif %}
              </p>
            {%else%}
              <p style="margin-top:6px;">{% if !try.is_end %}Hi，亲爱的小伙伴们！{{ try.title }}正在太火鸟免费试用中，我已申请，离支持结束还有
              <span style="color:#f36;font-weight:700;" data-countdown="{{ try.end_time|date 'Y/m/d H:i:s' }}"></span>，急需你的帮助！互相支持中签机率更加倍哟~ {% else %}支持已结束！{% endif %}

        		</p>
            {%endif%}
            {% if !try.step_stat==0 %}
            <label class="ui magenta inverted active button label" style="min-width: 74px;">免费试用</label> &nbsp;  <label class="ui magenta inverted active button label">数量{{ try.try_count }} 个</label>&nbsp; <label class="ui magenta inverted active button label">{{ try.apply_count }} 人申请</label>
            {%endif%}
          </div>
        </div>
        
        <div class="ui segment">
          
          <div class="trypeo" id="rank-box">
            <!--ajax fetch rank-->
          </div>
          
        </div>
        
        
      </div>
    </div>
  </div>
</div>


{% if !try.is_end %}
  {% if is_current_user %}
    <div class="barrer subbtn showdiv"><a class="play">求支持</a></div>
  {%else%}
    {% if is_support %}
      <div class="barrer subbtn"><a href="{{ try.wap_view_url }}" class="play">我要试用</a></div>
    {%else%}
      <div class="barrer subbtn"><a href="javascript:void(0);" class="play support-btn">我要支持</a></div>
    {%endif%}
  {%endif%}
{%endif%}
<div id="mask" style="position: fixed; width: 100%; height: 100%; z-index: 100; top: 0px; opacity: 0.9; display: none; background: rgb(0, 0, 0);" align="center">
  <div class="frideshare">
	<img src="{{ app_url_packaged }}/images/fenxiang.png" width="100%" >
  </div>
</div>
{% include "mm/loginbox.html" %}
{% endblock %}
