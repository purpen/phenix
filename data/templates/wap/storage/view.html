{%extends 'layout/shop.html'%}
{% block title%}{% endblock %}
{% block page_css %}
<style type="text/css">
	.sfooter.nav-menu{
		display: none;
		visibility: hidden;
	}
	#slider.flexslider .slides li,#slider.flexslider .slides,#slider {
    	max-height: none;
    }
    .storimg{
    	width: 75px;
    	height: 75px;
    	margin: 0 auto;
    	border-radius: 50%;
    	border: 1px solid #ccc;
    }
    h3.title{
    	font-size: 17px;
    	color: #222;
    	padding:10px 0 5px;
    }
    .ui.star.rating .active.icon{
    	color: #be8914 !important;
    	text-shadow: none !important;
    }
    .maypay{
    	font-size: 12px;
    	color: #666;
    	margin-bottom: 5px;
    }
    .bound{
    	color: #be8914;
    	font-size: 14px;
    }
    .bound img{
    	width: 20px;
    	vertical-align: top;
    	margin: 2px 6px 0 0;
    }
    .row.des p{
    	font-size: 14px;
    	line-height: 24px;
    	margin-bottom: 20px;
    	color: #222;
    }
    .storage{
    	background: #fff;
    }
    .row.des p.show-more{
    	text-align: center;
    }
    .row.des p.show-more img{
    	width: 16px;
    	display: inline-block;
    	vertical-align: baseline;
    }
    .row.des p img{
    	vertical-align: top;
    	display: block;
    	width: 100%;
    }
	.row.des .line{
		background: #E5E5E5;
		height: 1px;
		text-align: center;
		width: 100%;
	}
	h4.title{
		color: #666;
		font-size: 14px;
		text-align: center;
	}
	.row.spot p{
    	font-size: 12px;
    	line-height: 20px;
    	margin-bottom: 16px;
    	color: #666;
    }
    .row.spot p img{
    	vertical-align: top;
    	display: block;
    	width: 100%;
    }
    .row.spot a.link-more{
    	text-align: center;
    	display: block;
    	color: #222;
    }
    .row.spot a.link-more img{
    	width: 16px;
    	display: inline-block;
    	vertical-align: baseline;
    }
    .moredes{
    	background: #fff;
    	margin:10px 0;
    }
    .moredes p{
    	padding: 10px 0;
    	margin:0;
    	font-size: 12px;
    }
    .moredes p+p{
    	border-top: 1px solid #E5E5E5;
    }
    #shop_guess_wap_list {
	    margin-top: 20px;
	    position: relative;
	    padding: 0 16px;
	    margin-bottom: 10px;
	    padding-bottom: 50px;
	}
	.guess.title{
		color: #666;
		font-size: 14px;
	}
	.fixbto{
		background: #222;
	    color: #fff;
	    text-align: center;
	    height: 44px;
	    position: fixed;
	    width: 100%;
	    left: 50%;
	    bottom: 0;
	    max-width: 767px;
	    -webkit-transform: translateX(-50%);
	    transform: translateX(-50%);
	    line-height: 44px;
	}
	.fixbto img{
		width: 22px;
		vertical-align: middle;
		margin-right: 10px;
	}
	.pagecount{
		background:rgba(0,0,0,0.6);
		color: #fff;
		font-size: 14px;
		position: absolute;
		right: 40px;
		bottom: 30px;
		border-radius: 4px;
		z-index: 2;
		padding: 5px 0;
	    width: 50px;
	    text-align: center;
	}
	.ui.brand.list #mpresale .recom-item .recom-cell .desc{
		background: #222;
		border-top: 1px solid #222;
	}
	.ui.brand.list #mpresale .recom-item .recom-cell .desc h2 {
	    color: #fff;
	    text-align: center;
	}
	.ui.brand.list #mpresale .recom-item .recom-cell .desc .cats{
		text-align: center;
	}
	.ui.fiushop .ui.sheader{
		position: absolute;
	    top: 0;
	    left: 0;
	    width: 100%;
	    z-index: 4;
	    background: rgba(255,255,255,0.5);
	    -webkit-box-shadow: none;
	    box-shadow: none;
	    height: 50px;
	}
	.ui.fiushop .ui.sheader p{
		margin: 0;
	}
	.acacartlogin {
	    right: 14px;
	    top: 50%;
	    transform: translateY(-50%);
	    width: 34px;
	    height: 50px;
	    -webkit-transform: translateY(-50%);
	    -moz-transform: translateY(-50%);
	    -ms-transform: translateY(-50%);
	    position: absolute;
	}
	.acacartlogin .caputcart {
	    background: url({{app_url_packaged}}/images/icon/shouc.png);
	    width: 20px;
	    height: 20px;
	    background-repeat: no-repeat;
    	background-size: 40px 20px;
	    margin: 15px 4px;
	    background-position: 0 0;
	}
	.acacartlogin.active .caputcart{
		background-position: -20px 0;
	}
</style>
{% endblock %}

{% block layout_js %}
  <script src="{{ app_url_packaged }}/javascript/lightbox.min.js" type="text/javascript"></script>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
  <script type="text/javascript" >

      wx.ready(function(){
        // 2.1 监听“分享给朋友”，按钮点击、自定义分享内容及分享结果接口
         wx.onMenuShareAppMessage({
          title: m_name,
          desc: desc_str,
          link: link,
          imgUrl: img_url,
          success: function (res) {
            record_share_num();
            $('#mask').css('display','none');
          }
        });      

        // 2.2 监听“分享到朋友圈”按钮点击、自定义分享内容及分享结果接口
        wx.onMenuShareTimeline({
          title: m_name,
          desc: desc_str,
          link: link,
          imgUrl: img_url,
          success: function (res) {
            record_share_num();
            $('#mask').css('display','none');
          }
        });

        // 2.3 监听“分享到QQ”按钮点击、自定义分享内容及分享结果接口
        wx.onMenuShareQQ({
          title: m_name,
          desc: desc_str,
          link: link,
          imgUrl: img_url,
          success: function (res) {
            record_share_num();
            $('#mask').css('display','none');
          }
        });

        // 2.4 监听“分享到微博”按钮点击、自定义分享内容及分享结果接口
        wx.onMenuShareWeibo({
          title: m_name,
          desc: desc_str,
          link: link,
          imgUrl: img_url,
          success: function (res) {
            record_share_num();
            $('#mask').css('display','none');
          }
        });
      });

      //记录分享数
      function record_share_num(){

      };

      // 加载产品相关推荐
      function ajax_load_product(id){
          //防止频繁请求(在没加载完成时只允许请求一次)
          var url = '{{ app_url_wap }}/app/site/storage/ajax_fetch_storage_product';
          $.get(url, {page:1, size: 30, scene_id:id }, function(rs){

              var rendered = phenix.ajax_render_result('#fetch_more_products_tpl', rs.data);
                $('#shop_guess_wap_list .recom-item').html(rendered);

 			  $("img.lazy").lazyload({
 			     effect : "show"
 			  });
          }, 'json');
      }

  </script>
{% endblock %}

{% block jquery %}
	$('#slider').flexslider({
        animation: "fade",
        directionNav: false, 
        controlNav: true,
        animationLoop: true,
        slideshow: true,
        slideshowSpeed: 5000,
        animationDuration: 300,
        animationSpeed: 300,
        startAt:1,
        start: function (slider){
        	$('.current').html(slider.currentSlide);
        	$('.allpage').html(slider.count)
        },
        before: function (slider) {
        	$('.current').html(slider.currentSlide + 1);
        	$('.allpage').html(slider.count)
        }, 
    });
    var flexheight = $('body').width()+'px';
	$('#slider,#slider.flexslider .slides,#slider.flexslider .slides li,#slider.flexslider .slides li a').css('height',flexheight);
	$('.show-more').click(function(){
		$('.more').fadeIn();
		$(this).hide();
	})
	$('.acacartlogin').click(function(){

	})

    // 加载相关商品
    ajax_load_product('{{ scene._id }}');


    var descrite = '{{ scene.des }}';
    var m_name = '{{ scene.title }}';
    var link = '{{ scene.wap_view_url }}';
    var img_url = '{{ scene.avatar.thumbnails.apc.view_url }}';
    var desc_str = '眼见三月八日又来了，雷锋小编不光教学，还要送大礼啦！';
	
    wx.config({
        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: '{{ wx_share.app_id }}', // 必填，公众号的唯一标识
        timestamp: {{ wx_share.timestamp }}, // 必填，生成签名的时间戳
        nonceStr: '{{ wx_share.wxnonceStr }}', // 必填，生成签名的随机串
        signature: '{{ wx_share.wxSha1 }}',// 必填，签名，见附录1
        jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'onMenuShareQQ', 'onMenuShareWeibo', 'hideMenuItems'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });


	/* 登录用户行为 */
	{% if visitor.is_login %}
		// 初始化互动，是否收藏、点赞
		$.get('{{ app_url_wap }}/app/site/favorite/ajax_done', {id: {{scene._id}},type:11,event:1}, function(result){
			if (result.success) {
				// 验证收藏
				if (result.data.favorited) {
					$('.ui.favorite')
						.data('content', '取消')
						.data('mark', 'y')
						.addClass('active');
				}
			}
		}, 'json');

		/* 登录用户行为 */
	{% endif %}

	// 收藏
	$('.ui.favorite').bind('click', function(){
		var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
            phenix.redirect("{{ app_url_wap }}/auth/login_signup");
			return false;
		}
		if (mark == 'n') {
			$.post('{{ app_url_wap }}/app/site/favorite/ajax_favorite', {id: id, type:11}, function(result){
				if (result.success) {
					$btn
						.data('content', '取消收藏')
						.data('mark', 'y')
						.addClass('active')									
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		} else {
			$.post('{{ app_url_wap }}/app/site/favorite/ajax_cancel_favorite', {id: id, type:11}, function(result){
				if (result.success) {
					$btn
						.data('content', '收藏')
						.data('mark', 'n')
						.removeClass('active')
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		}
	});



{% endblock %}
{% block content %}
<div id="slider" class="flexslider flex-single">
	<div class="ui fiushop pb-0">
	    <div class="ui sheader">
	        <a class="return" href=""><i class="angle float left icon"></i></a>
	        <p></p>
            <div class="acacartlogin ui favorite" data-id="{{ scene._id }}" data-mark="n" data-content="收藏">
	        	<div class="caputcart"></div>
	        </div>
	    </div>
	</div>
	<ul class="slides">
	{% asset_list var:'assets' parent_id:scene._id size:30 asset_type:101 %}
	{% for asset in assets.rows %}
	    <li style="background-image: url('{{ asset.thumbnails.apc.view_url }}');">
	    	
	    </li>
	{% endfor %}
	<div class="pagecount"> 
		<span class="current"></span> /
		<span class="allpage"></span>
	</div>
	</ul>  
</div>
<div class="storage">
	<div class="ui responsive grid">
		<div class="row pt-4r">
			<div class="ui center aligned column">
                <img class="storimg" src="{{ scene.avatar.thumbnails.apc.view_url }}">
                <h3 class="mtb-0 title">{{ scene.title }}</h3>
				<div class="pb-r">
					<span class="ui star rating">
						<i class="icon active"></i>
						<i class="icon active"></i>
						<i class="icon active"></i>
						<i class="icon active"></i>
						<i class="icon "></i>
					</span>
				</div>
                <!--
				<p class="maypay">人均消费￥2500</p>
				<p class="bound"><img src="{{ app_url_packaged }}/images/icon/youh.png">领取10元优惠券</p>
                -->
			</div>
		</div>

		<div class="row des">
			<div class="column">
                <p>{{ scene.des }}</p>
                <!--
				<div class="more" style="display: none">
					<p>{{ scene.des }}</p>
				</div>
				<p class="show-more">查看更多 <img src="{{ app_url_packaged }}/images/icon/icon_back.png"></p>
                -->
				<div class="line"></div>
			</div>
		</div>

		<div class="row spot">
            {% if scene.brights %}
			<div class="column">
				<h4 class="title">亮点</h4>

                {% for d in scene.brights %}
                    {% if loop.counter <= 2 %}
                        {% if d.type==1 %}
                            <p>{{ d.content }}</p>
                        {%endif%}
                        {% if d.type==2 %}
                            <p> <img src="{{ d.content }}"></p>
                        {%endif%}
                    {%endif%}
                {%endfor%}
                <p class="more" style="display: none">
                 {% for d in scene.brights %}
                    {% if loop.counter > 2 %}
                        {% if d.type==1 %}
                            <p>{{ d.content }}</p>
                        {%endif%}
                        {% if d.type==2 %}
                            <p> <img src="{{ d.content }}"></p>
                        {%endif%}
                    {%endif%}
                {%endfor%}               
                </p>

                {% if scene.bright_count > 2 %}
				    <a href="" class="show-more">查看更多 <img src="{{ app_url_packaged }}/images/icon/icon_back.png"></a>
                {% endif %}
			</div>
            {% endif %}
		</div>
	</div>
</div>
<div class="moredes">
	<div class="ui responsive grid">
		<div class="row ptb-0">
			<div class="column">
                {% if scene.extra.shop_hours %}<p>营业时间：{{ scene.extra.shop_hours }}</p>{%endif%}
                {% if scene.extra.tel %}<p>电话：{{ scene.extra.tel }}</p>{%endif%}
                {% if scene.tags_s %}<p>标签：{{ scene.tags_s }}</p>{%endif%}
			</div>
		</div>
	</div>
</div>

<!-- 相关推荐 -->
<div id="shop_guess_wap_list" class="ui brand list">
        <!-- 加载相关推荐 -->
    <div class="guess title">
        相关产品
    </div>
    <div class="row" id="mpresale">
        <div class="column">
            <div class="recom-item three"><!--ajax list--></div>
        </div>
    </div>
</div>
<!--<div class="fixbto"><img src="{{app_url_packaged}}/images/icon/phone.png"/>咨询电话：{{ scene.extra.tel }}</div>-->

{% endblock %}

{% block templates %}
    {% mustache id:'fetch_more_products_tpl' tpl:'mustache_m/stick_products.mustache' %}
{% endblock %}
