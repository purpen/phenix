{%extends 'layout/shop.html'%}
{% block title%}购物车-Fiu{% endblock %}
{% block page_css %}
<style type="text/css">
#mfrbird{
	margin-top:0;
}
#mmfoot{
  display:none;
}
.cartmain{
	display:block;
	margin-top:15px;
	padding:0;
	padding-bottom: 55px;
}
.cartitem{
	display: flex;
    display: -ms-flexbox;
    display: -webkit-flex;
    display: -webkit-box;
    align-items: center;
    -webkit-box-align: center;
	background:#fff;
	margin-bottom:10px;
	padding: 10px;
}
.cartitem .cartinfo{
	-webkit-box-flex: 1;
    -webkit-flex: 1;
    -ms-flex: 1;
    flex: 1;
    -webkit-flex-basis: 0;
    -ms-flex-preferred-size: 0;
    flex-basis: 0;
    flex-grow: 1;
    position: relative;
	margin-right:10px;
	margin-left:10px;
}
.cartitem .cartinfo h3.title{
    font-size: 12px;
    margin-bottom: 5px;
    max-height: 34px;
    overflow: hidden;
    font-weight: 400;
    color:#000 !important;
}
.cartitem .cartinfo p.checkt{
    font-size: 12px;
    margin-bottom: 8px;
    color:#666;
}
.cartitem .cartinfo p.price{
	color:#BE8914;
    margin-bottom: 8px;
}
.cartitem .remove_cart{
	width:20px;
	height:20px;
	position:relative;
	background:rgba(0,0,0,0.5);
	border-radius:50%;
}
.cartitem .remove_cart img{
    width: 6px;
    height: 6px;
    margin: 7px;
}
.cartitem .img img{
	width:92px;
	height:69px;
	position:relative;
    border: 1px solid #eee;
}
.cartadd{
	padding: 0;
    margin: 0;
    display: -webkit-box;
    display: -webkit-flex;
    display: -ms-flexbox;
    display: flex;
    -webkit-flex-wrap: wrap;
    -ms-flex-wrap: wrap;
    flex-wrap: wrap;
    position: fixed;
    bottom: 0;
    left: 50%;
    width: 100%;
    height: 50px;
    z-index: 3;
    max-width: 767px;
    -webkit-transform: translateX(-50%);
    transform: translateX(-50%);
}
.cardsum{
	-webkit-box-flex: 1;
    -webkit-flex: 1;
    -ms-flex: 1;
    flex: 1;
    width: 0;
    -webkit-flex-basis: 0;
    -ms-flex-preferred-size: 0;
    flex-basis: 0;
    max-width: 100%;
    display: block;
    padding: 0;
    position: relative;
	height:50px;
	text-align:center;
	font-size:14px;
    background: #fff;
    line-height: 50px;
}
.cardsum span{
	color:#BE8914;
	position:relative;
}
.cardsum span span{
	margin-left:12px;
}
.cardsum span .rmb.icon{
	position:absolute;
}
.cardsum span .rmb.icon,.cartitem .cartinfo p.price .rmb.icon{
    font-size: 14px;
    font-weight: 400;
    margin: 0;
    padding: 0;
    width: auto;
}
.cardcheck{
    -webkit-box-flex: 1;
    -webkit-flex: 1;
    -ms-flex: 1;
    flex: 1;
    width: 0;
    -webkit-flex-basis: 0;
    -ms-flex-preferred-size: 0;
    flex-basis: 0;
    max-width: 100%;
    display: block;
    padding: 0;
    position: relative;
    height: 50px;
    text-align: center;
    line-height: 50px;
    background: #c1c1c1;
    color: #fff !important;
	background:#be8914;
}
.sfooter.nav-menu{
    display: none;
    visibility: hidden;
}
.color-be{
    color: #BE8914 !important;
}
.cartitem .ui.checkbox{
    display: block;
}
.ui.radio.checkbox input[type=checkbox]:checked~.box:after, .ui.radio.checkbox input[type=checkbox]:checked~label:after {
    background-color: rgba(190,137,20,.95);
}
.quantity {
    font-size: 0;
    border: 1px solid rgba(0,0,0,0.1);
    position: absolute;
    bottom: 4px;
    right: 10px;
    height: 26px;
}
.quantity .ui.mini.gray.icon.button:first-child {
    border-right: 1px solid rgba(0,0,0,0.1) !important;
}
.quantity .ui.mini.gray.icon.button:last-child {
    border-left: 1px solid rgba(0,0,0,0.1) !important;
}
.quantity .ui.mini.gray.icon.button {
    background-color: rgba(200,200,200,0.1);
    color: rgba(0,0,0,0.5);
    padding: 0.5rem 0.4rem;
    margin-top: 9pt;
    border-radius: 0;
    margin: 0;
    height: 24px;
}
.quantity .ui.mini.gray.icon.button.disabled{
    opacity: 1 !important;
    background: #eee !important;
}
.quantity input {
    width: 40px;
    text-align: center;
    margin: 0;
    height: 24px;
    vertical-align: top;
    line-height: 24px;
    font-size: 12px;
    background-color: #FFF;
    border-radius: 0 !important;
    border: none !important;
    outline: 0;
    color: rgba(0,0,0,1);
}
.ui.master.radio.checkbox{
    -webkit-box-flex: 1;
    -webkit-flex: 1;
    -ms-flex: 1;
    flex: 1;
    width: 0;
    -webkit-flex-basis: 0;
    -ms-flex-preferred-size: 0;
    flex-basis: 0;
    max-width: 100%;
    display: block;
    padding: 0;
    position: relative;
    text-align: center;
    font-size: 14px;
    background: #fff;
}
.ui.master.radio.checkbox label{
    text-align: left;
    vertical-align: middle;
    margin-left: 15px;
    transform: translateY(-50%);
    position: absolute;
    top: 50%;
}
.disabled.cardcheck{
    background: #c1c1c1;
}
#shop_guess_wap_list{
    margin-top: 30px;
    position: relative;
    padding: 0 16px;
    margin-bottom: 10px;
}
#shop_guess_wap_list .guess.title{
    padding:15px 10px 10px;
    font-weight: 400;
    font-size: 14px;
    text-align: center;
    position: relative;
}
#shop_guess_wap_list .guess.title .left{
    width: 35%;
    height: 1px;
    background: rgba(0,0,0,0.1);
    position: absolute;
    z-index: -2;
    top: 50%;
    left: 0;
    margin-top: 2px;
}
#shop_guess_wap_list .guess.title .right{
    width: 35%;
    height: 1px;
    background: rgba(0,0,0,0.1);
    position: absolute;
    z-index: -2;
    top: 50%;
    right: 0;
    margin-top: 2px;
}
#shop_guess_wap_list .recom-item.three{
    padding:0 3px;
}
#shop_guess_wap_list .recom-item.three .recom-cell.three {
    width: 50%;
    height: 100%;
    display: block;
    float: left;
    padding: 0 6px;
    margin: 4px 0;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
    margin-right: 0px;
}
#shop_guess_wap_list .recom-item.three .recom-cell.three a{
    padding-top:100%;
}
#shop_guess_wap_list .recom-item.three .recom-cell.three a img{
    border: 1px solid rgba(0,0,0,0.1);
    top: 0;
    bottom: auto;
    height:auto;
}
#shop_guess_wap_list .recom-item.three .recom-cell.three .desc{
    position:relative;
    background:#fff;
    padding: 8px 0 0;
    text-align: left;
    height: auto;
}
#shop_guess_wap_list .recom-item.three .recom-cell.three .desc h2{
    height:34px;
    color: #222;
    font-size: 14px;
    overflow:hidden;
    font-weight:400;
    white-space: normal;
    margin-bottom: 5px;
}
#shop_guess_wap_list .recom-item.three .recom-cell.three .desc .cats{
    font-size: 12px;
    height: 30px;
    padding: 0;
    text-transform: uppercase;
    color: #BE8914;
    line-height:20px;
}
#shop_guess_wap_list.ui.brand #mpresale .recom-item .recom-cell {
    padding-left: 0;
    padding-right: 8px;
    margin: 8px 0 8px;
}
#shop_guess_wap_list.ui.brand #mpresale .recom-item .recom-cell:nth-child(2n) {
    padding-left: 8px;
    padding-right: 0;
}


.mask {
    height: 100%;
    width: 100%;
    position: fixed;
    background: rgba(0,0,0,0.4);
    z-index: 9;
    top: 0;
    left: 0;
}
.nextbu{
    width:calc(100% - 100px);
    margin: 0 50px;
    background:#fff;
    position:fixed;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    -webkit-transform: translateY(-50%);
    z-index: 10;
    border-radius: 8px;
}
.nextbu .content{
    padding:20px 10px;
    text-align: center;
    font-size: 14px;
    color:#666;
}
.btnmake{
    font-size: 0;
    position: relative;
    display: block;
    border-top: 1px solid #eee;
}
.btnmake .cancle{
    width: 50%;
    font-size: 14px;
    color: #666;
    text-align: center;
    line-height: 44px;
    display: inline-block;
    border-right: 1px solid #eee;
}
.btnmake .caok{
    width: 50%;
    font-size: 14px;
    color: #be8914;
    text-align: center;
    line-height: 40px;
    display: inline-block;
}  

</style>
{% endblock %}

{% block layout_js %}
  <script type="text/javascript" >
      var page = 1;
      var size = 4;
      var category_id = '';
      var sort = 4;
      var type = 2;
      var category_tag = '';

    // 更新购物车数量
    function update_cart_num(target_id, type, n){
        var url = "{{ app_url_wap }}/app/site/cart/edit_cart";
        $.post(url, {target_id:target_id, type:type, n:n}, function(result){
            if(result.success){
                var obj = $("#cart-product-"+target_id+"");
                obj.find('[name=product-qty]').val(result.data.n);
                obj.find('[name=product-price]').val(result.data.total_price);
                obj.find('.price_box').text(result.data.total_price);
                obj.find('.count_num').text(result.data.n);

                // 统计选中价格
                stat_total_price();
            }else{
                
            }
        }, 'json');
        
    }

    // 统计总金额
    function stat_total_price(){
        var total_price = 0;
        $('#buy_target_ids').val('');
        $(".cartitem [name='radio']:checked").each(function(i){
            var target_id = $(this).data('target_id');
            var obj = $("#cart-product-"+target_id+"");
            var price = parseFloat(obj.find('[name=product-price]').val());
            total_price += price;

            // 统计选中ID
            phenix.record_asset_id('buy_target_ids', target_id);
        })

        if(parseFloat(total_price)==0){
            $('#do_check_btn').addClass('disabled');
        }else{
            $('#do_check_btn').removeClass('disabled');       
        }
        $('#total_price_text').text(total_price.toFixed(2));
    }

  
      // 加载产品列表
      function ajax_load_more(category_id, category_tag, type, sort, page, size){
          //防止频繁请求(在没加载完成时只允许请求一次)
          var url = '{{ app_url_wap }}/shop/ajax_load_list';
          $.get(url, { category_id:category_id, category_tags:category_tag, sort:sort, page:page, type:type, size:size }, function(rs){

              var rendered = phenix.ajax_render_result('#fetch_more_products_tpl', rs.data);
              if(page==1){
                $('#shop_guess_wap_list .recom-item').html(rendered);
              }else{
                $('#shop_guess_wap_list .recom-item').append(rendered);
              }
 			  $("img.lazy").lazyload({
 			     effect : "show"
 			  });
          }, 'json');
      }

  </script>
{% endblock %}

{% block jquery %}

    // 初始化统计金额
    stat_total_price();

  // 移除购物车商品 
  $('.remove_cart').click(function(){
    var target_id = $(this).data('target_id');
    var type = $(this).data('type');
    var price = parseFloat($(this).data('price'));
    var total_price = parseFloat($('#total_price_text').text());
    var array = target_id+"|"+type;

    $('.nextbu,.mask').show();
    $('.cancle').on('click',function(){
        $('.nextbu,.mask').hide();
    });
    $('.caok').on('click',function(){
        $.post("{{ app_url_wap }}/app/site/cart/ajax_remove_cart", {array: array}, function(result){
          if(result.success){
            $('#cart-product-'+target_id).remove();
            // 统计选中价格
            stat_total_price();
            // ajax加载购物车数量
            $.get('{{ app_url_wap }}/app/site/cart/ajax_fetch_count', {}, function(result){
                if(result.success){
                  $('#wap_cart_num').show().text(result.data.count);
                }else{
                  $('#wap_cart_num').hide().text('');
                }
            }, 'json');
          }else{
            phenix_show_error_note(result.message, 3000);
          }
        }, 'json')
        $('.nextbu,.mask').hide();
    });
  });

  // 全选＼取消全选
  $('.master.checkbox')
    .checkbox({
        onChecked: function() {
            var $childCheckbox  = $(this).closest('.checkbox').parent().siblings('.cartitem').find('.checkbox');
            $childCheckbox.checkbox('check');
            $('.cartitem [name=radio]').prop('checked', true);
            // 统计选中价格
            stat_total_price();

        },
        onUnchecked: function() {
            var $childCheckbox  = $(this).closest('.checkbox').parent().siblings('.cartitem').find('.checkbox');
            $childCheckbox.checkbox('uncheck');
            $('.cartitem [name=radio]').prop('checked', false);
            // 统计选中价格
            stat_total_price();
        }

    })

  $('.single.checkbox')
    .checkbox({
        onChecked: function() {
            $(this).checkbox('check');
            $(this).find('[name=radio]').prop('checked', true);
            // 统计选中价格
            stat_total_price();

        },
        onUnchecked: function() {
            $(this).checkbox('uncheck');
            $(this).find('[name=radio]').prop('checked', false);
            // 统计选中价格
            stat_total_price();
        }

    })

    // 减少数量
    $('.dec-qty').click(function(){
        var target_id = $(this).data('target_id');
        var type = $(this).data('type');
        var n = parseInt($(this).parent().find('[name=product-qty]').val());
        $(this).parent().find('.inc-qty').removeClass('disabled');
        n--;
        if(n<1){
            $(this).addClass('disabled');
            return;
        }
        update_cart_num(target_id, type, n);
    
    });

    // 增加数量
    $('.inc-qty').click(function(){
        var target_id = $(this).data('target_id');
        var type = $(this).data('type');
        var n = parseInt($(this).parent().find('[name=product-qty]').val());
        $(this).parent().find('.dec-qty').removeClass('disabled');
        n++;
        if(n>50){
            $(this).addClass('disabled');
            return;
        }
        $(this).removeClass('disabled');
        update_cart_num(target_id, type, n);

    });


    // 去结算 
    $('#do_check_btn').click(function(){

        var target_ids = $('#buy_target_ids').val();
        var url = "{{ app_url_wap }}/shop/checkout?target_ids="+target_ids;
        var total_price = parseFloat($('#total_price_text').text());
        if(total_price==0){
            //phenix.show_error_note('请选择购物车产品!', 2000);
            return false;
        }
        phenix.redirect(url);
    });

	// 初始加载商品列表
    ajax_load_more(category_id, category_tag, type, sort, page, size);
{% endblock %}

{% block content %}
<div class="ui fiushop pb-0">
    <div class="ui sheader">
        <a class="return" href="{{ back_url }}"><i class="angle float left icon"></i></a>
        <p>购物车</p>
    </div>
</div>
<div id="cartpage">
	{% if products %}
	<div class="cartmain">
		{% for product in products %}
		<div class="cartitem plr-14" id="cart-product-{{ product.target_id }}">
            <div class="ui radio single checkbox">
                <input type="checkbox" name="radio" data-target_id="{{ product.target_id }}" checked="checked">
            </div>
			<a href="{{ product.wap_view_url }}" class="img"> <img class="lazy" src="{{ product.cover }}" alt="{{ product.title }}" ></a>
			<div class="cartinfo">
				<a class="ui link" href="{{ product.wap_view_url }}"><h3 class="title">{{ product.title }}</h3></a>
                <p class="checkt">颜色／分类：{% if product.sku_mode %}{{ product.sku_mode }}{%else%}默认{%endif%}  &nbsp;&nbsp;数量＊<span class="count_num">{{ product.n }}</span></p>
        <p class="price"><i class="rmb icon"></i>  <span class="price_box">{{ product.total_price }}</span></p>
			    <div class="quantity">
                    <button class="ui mini gray dec-qty icon button {% if product.n==1 %}disabled{%endif%}" data-target_id="{{ product.target_id }}" data-type="{{ product.type }}" data-count="1">
                        <i class="minus icon"></i>
                    </button>
                    <input type="text" name="product-qty"  value="{{ product.n }}" autocomplete="off">
                    <input type="hidden" name="product-price"  value="{{ product.total_price }}">
                    <button class="ui mini gray inc-qty icon button" data-target_id="{{ product.target_id }}" data-type="{{ product.type }}" data-count="">
                        <i class="add icon"></i>
                    </button>
                </div>
			</div>
			<div class="remove_cart"  data-target_id="{{ product.target_id }}" data-type="{{ product.type }}" data-price="{{ product.total_price }}">
				<img src="{{ app_url_packaged }}/images/icon/close.png">
			</div>
		</div>
		{% endfor %}
		<div class="cartadd">
            <div class="ui master radio checkbox">
                <input type="checkbox" name="vegetables" checked="checked" tabindex="0" class="hidden">
                <label>全选</label>
            </div>
			<div class="cardsum">
                <input type="hidden" name="buy_target_ids" id="buy_target_ids" value="" />
        合计: <span><i class="rmb icon"></i><span id="total_price_text">{{ total_money }}</span></span>
			</div>
			<a href="javascript:void(0);" id="do_check_btn" class="cardcheck ui link">
				去结算
			</a>
		</div>

        <!-- 相关推荐 -->
        <div id="shop_guess_wap_list" class="ui brand list">
                <!-- 加载相关推荐 -->
            <div class="guess title">
                为你优选好货
                <div class="left"></div>
                <div class="right"></div>
            </div>
            <div class="row" id="mpresale">
                <div class="column">
                    <div class="recom-item">

                    </div>
                </div>
            </div>
        </div>
	</div>
	{%else%}
	<div class="ui responsive grid" style="padding-top:10px;">
		<div class="row">
			<div class="column plr-14" id="cart-body-content">
				<div class="ui empty message">
					<h1 class="ui big header">
						<i class="cart icon" style="font-size:1em !important;vertical-align: top;padding-top:0;"></i>
						<div class="content" style="display:inline-block;">
							<div class="sub header">还没选中产品？<a href="{{ app_url_wap }}/shop" class="ui color-be link">赶快去选购吧</a></div>
						</div>
					</h1>
				</div>
			</div>
		</div>
	</div>

	<!-- 相关推荐 -->
    <div id="shop_guess_wap_list" class="ui brand list">
            <!-- 加载相关推荐 -->
        <div class="guess title">
            为你优选好货
            <div class="left"></div>
            <div class="right"></div>
        </div>
        <div class="row" id="mpresale">
            <div class="column">
                <div class="recom-item">

                </div>
            </div>
        </div>
    </div>
	{%endif%}
    
</div>

<div class="ui nextbu hide">
    <div class="content">
        <p>确认将这个商品删除 ？</p>
    </div>
    <div class="btnmake">
        <div class="cancle">
            取消
        </div>
        <div class="caok">
            确认
        </div>
    </div>
</div>
<div class="ui mask hide"></div>
{% endblock %}

{% block templates %}
    {% mustache id:'fetch_more_products_tpl' tpl:'mustache_m/fetch_more_products.mustache' %}
{% endblock %}
