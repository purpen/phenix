{%extends 'layout/mobile.html'%}
{% block title%}{{ product.title }}-{% endblock %}
{% block page_css %}
<style type="text/css">
.ui.money.list .item .content {
	margin-left: 0%;
}
.ui.one.levels {
	margin: 0;
}
.ui.one.levels > .level {
	width: 100%;
	margin-bottom: 1rem;
}

#frslide{
	max-height:216px !important;
}

.ui.basic.table tbody tr {
border-bottom: 0px solid rgba(0,0,0,0) !important;
}
.ui.buy.action.table td {
padding: .25em 0;
box-shadow: 0 0px 0 0 rgba(0,0,0,0)!important;
}
.product.attrs {
display: inline-block;
margin-top: 5px;
}
#gritter-notice-wrapper {
position: fixed !important;
}
.six.wide .price .ui.magenta.text{
	font-size:20px !important;
}
.product.snatched {
	margin:10px 0;
}
.product.snatched span.count {
	color: #f36;
	font-weight: 700;
}
.product.snatched + .ui.labeled.icon.button{
	padding-left: 1.4em!important;
}
</style>
{% endblock %}

{% block layout_js %}
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">

    var m_name = '{{ product.title }}';
    {% if product.cover %}
      var img_url = '{{ product.cover.thumbnails.big.view_url }}';
    {%else%}
      var img_url = 'http://frstatic.qiniudn.com/images/logo/logo.png';
    {%endif%}
    var link = '{{ product.wap_view_url }}';
    var desc_str = '太火鸟科技 Taihuoniao.com 是中国最火爆的智能硬件孵化平台。太火鸟致力于建设重构产品研发创新流程，努力帮助设计师和创意者实现商业价值，从广泛的创意中寻找具有「创新价值」且可以被称为「性感设计」的产品，开启一个全新的众包设计时代。太火鸟孵化的团队将从商品定义、投资融资、硬件品控、软件体验、推广营销、渠道建设等每个环节全程全力支持，真正做到一条龙服务式的智能硬件孵化平台；全力打造一个完美的创意生态系统。';

    wx.config({
        debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: '{{ app_id }}', // 必填，公众号的唯一标识
        timestamp: {{ timestamp }}, // 必填，生成签名的时间戳
        nonceStr: '{{ wxnonceStr }}', // 必填，生成签名的随机串
        signature: '{{ wxSha1 }}',// 必填，签名，见附录1
        jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'onMenuShareQQ', 'onMenuShareWeibo', 'hideMenuItems'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });

  wx.ready(function(){
    // 2.1 监听“分享给朋友”，按钮点击、自定义分享内容及分享结果接口
     wx.onMenuShareAppMessage({
      title: m_name,
      desc: desc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });      

    // 2.2 监听“分享到朋友圈”按钮点击、自定义分享内容及分享结果接口
    wx.onMenuShareTimeline({
      title: m_name,
      desc: desc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });

    // 2.3 监听“分享到QQ”按钮点击、自定义分享内容及分享结果接口
    wx.onMenuShareQQ({
      title: m_name,
      desc: desc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });

    // 2.4 监听“分享到微博”按钮点击、自定义分享内容及分享结果接口
    wx.onMenuShareWeibo({
      title: m_name,
      desc: desc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });
  });

  //记录分享数/同时添加鸟币
  function record_share_num(){
    var url = '{{ app_url_wap }}/app/site/redis/incr';
    //$.get(url, { key: 'china_design_share_num' });
  }

</script>
{% endblock %}

{% block jquery %}
	var s=e('#frslide').width();
	e("#frslide > .ui.slide > .item").width(s);
	
	var $frame = $('#frslide');
	// Call Sly on frame
	$frame.sly({
		horizontal: 1,
		itemNav: 'basic',
		smart: 1,
		activateMiddle: 1,
		activateOn: 'click',
		mouseDragging: 1,
		touchDragging: 1,
		releaseSwing: 1,
		startAt: 0,
		pagesBar: $frame.find('.pages'),
		pageItem: 'pages',
		activatePageOn: 'click',
		pageBuilder: function (index) {
			return '<a href="javascript:void(0);">' + (index + 1) + '</a>';
		},
		speed: 300,
		elasticBounds: 1,
		easing: 'easeOutExpo',
		
		// Automated cycling
		//cycleBy: "items",
		//cycleInterval: 3000,
		//pauseOnHover:1,
		
		dragHandle: 1,
		dynamicHandle: 1,
		clickBar: 1,
	});
	
	$(window).resize(function() {
		var s=$('#frslide').width();
		e("#frslide > .ui.slide > .item").width(s);
		
		$frame.sly('reload');
	});
	
	phenix.bind_share_list();
	// 分享
	$('.ui.share.button').bind('click', function(){
		$('.ui.share.modal').modal('show');
	});
	
	// 如果仅一个sku,则设置默认值
	{% if skus_count %}
		var choosed_sku = 0;
	{% else %}
		var choosed_sku = {{ product._id }};
	{% endif %}
	
	// 选择sku
	$('.attrs .ui.att.button').click(function(){
		choosed_sku = $(this).data('id');
		$('.attrs .ui.att.active.button').removeClass('active');
		$(this).addClass('active');
		{% if !product.snatched %}
		  $('#current-price').html('<small>￥</small>'+$(this).data('price'));
		{%endif%}		

		return false;
	});
	
	// 立即购买
  $('.ui.nowbuy.button').livequery(function(){
    $(this).click(function(){
      // 所有ajax请求，验证是否登录
      if (!phenix.visitor.is_login){
        phenix.redirect('{{ app_url_wap }}/auth/login');
        return false;
      }
      if (choosed_sku){
        phenix.redirect('{{ app_url_wap }}/shop/nowbuy?sku='+choosed_sku, 0);
      } else {
        phenix.show_error_note('请选择一个型号或颜色', 2000);
      }
    });
  });
	
	// 预定
	$('.ui.booked.button').click(function(){
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.redirect('{{ app_url_wap }}/auth/login');
			return false;
		}
		var r_id = $(this).data('id');
		phenix.redirect('{{ app_url_wap }}/shop/nowbuy?sku='+r_id);
	});

	{% if is_snatch %}
    var times = {{ snatch_time }} ;
    var SysSecond;
    var InterValObj;
    //倒计时
    //SysSecond = parseInt($("#remainSeconds").html()); //这里获取倒计时的起始时间
    SysSecond = parseInt(times);
    InterValObj = window.setInterval(SetRemainTime, 1000); //间隔函数，1秒执行

    //将时间减去1秒，计算天、时、分、秒
    function SetRemainTime() {
    if (SysSecond > 0) {
      SysSecond = SysSecond - 1;
      var second = Math.floor(SysSecond % 60);             // 计算秒
      var minite = Math.floor((SysSecond / 60) % 60);      //计算分
      var hour = Math.floor((SysSecond / 3600) % 24);      //计算小时
      var day = Math.floor((SysSecond / 3600) / 24);        //计算天

      var time_show = ''
        + '<span class="count">'+ day +'</span> 天 '
        + '<span class="count">'+ hour +'</span> 时 '
        + '<span class="count">'+ minite +'</span> 分 '
        + '<span class="count">'+ second +'</span> 秒';
      $("#clock").html(time_show);
    } else {
      //剩余时间小于或等于0的时候，就停止间隔函数
      window.clearInterval(InterValObj);
      //这里可以添加倒计时时间为0后需要执行的事件
          var product_id = {{ product._id }};
          $.get('{{ app_url_wap }}/app/site/shop/check_snatch_expire', { product_id: product_id, type:1 }, function(r){
            var r = $.parseJSON(r);
            if(r.success){
              $('.tobuy').html('立即抢购').addClass('nowbuy');
              $('.snatched').html('<span class="ui black text">正在抢购中...</span>');
            }else{
              window.location.reload();
            }
          });

      }
    }

	{% endif %}
	
{% endblock %}

{% block content %}
<div class="ui responsive grid" id="mshoppage">
	<div class="row">
		<div class="column">
			<div class="ui breadcrumb">
			  	<a class="section" href="{{ app_url_wap }}">
					<i class="home icon"></i>首页
				</a>
			  	<div class="divider"> / </div>
				{% if product.stage == 9 %}
			  	<a class="section" href="{{ app_url_wap }}/shop">商品</a>
				{% endif %}
				{% if product.stage == 5 %}
			  	<a class="section" href="{{ app_url_wap }}/shop/presale">预售</a>
				{% endif %}
				{% if product.stage == 12 %}
			  	<a class="section" href="{{ app_url_wap }}/shop/exchange">积分兑换</a>
				{% endif %}
			  	<div class="divider"> / </div>
			  	<div class="active section">{{ product.title|truncate 12 }}</div>
			</div>
		</div>
	</div>
</div>

<!--产品图片-->
<div class="ui responsive grid">
	<div class="row">
		<div class="column">
			{% asset_list var:'assets' parent_id:product._id size:10 asset_type:10 %}
			<div id="frslide" class="frame">
				<div class="ui slide">
					<div class="item">
						<img src="{{ product.cover.thumbnails.big.view_url }}"  alt="{{ product.title }}" class="ui image" />
					</div>
					{% for asset in assets.rows %}
						{% if asset._id != product.cover_id %}
						<div class="item">
							<img src="{{ asset.thumbnails.big.view_url }}"  alt="{{ product.title }}" class="ui image"  />
						</div>
						{% endif %}
					{% endfor %}
				</div>
				<div class="pages"></div>
			</div>
		</div>
	</div>
</div>

<!--产品内容-->
<div class="ui responsive presale grid">			
	<div class="row">
		<div class="column">
            <div class="ui segment">
    			<h4 class="ui dividing header">
    				{{ product.title }}
    			</h4>
                
                {% if product.stage == 9 %}
                    {% if skus %}
            			<table class="ui basic buy action table">
            				<tr>
            					<td>
            						<div class="product attrs">
            							{% for m in skus %}
            							<span class="ui small magenta att button" data-id="{{ m._id }}" data-price="{{ m.price }}">{{ m.mode }}</span>		
            							{% endfor %}
            						</div>
            					</td>
            				</tr>
            			</table>
                    {% endif %}
                    <div class="ui grid">			
                    	<div class="row">
                    		<div class="six wide column">
                    			<label class="price">
                    				<span id="current-price" class="ui magenta text">
                                        <small>￥</small>{% if product.snatched %}{{ product.snatched_price }}{%else%}{{ product.sale_price }}{%endif%}
                                    </span>
                    			</label>
                    		</div>
                    		<div class="right aligned ten wide column">
                    			<div class="ui small star rating hover">
                    			  	<i class="icon active"></i>
                    			  	<i class="icon"></i>
                    			  	<i class="icon"></i>
                    			  	<i class="icon"></i>
                    			  	<i class="icon"></i>
                    			</div>
                    			<small><span class="ui magenta text">{{ product.comment_count }}</span> 条评价</small>
                    		</div>
                        </div>
                        <div class="row">
                            <div class="center aligned column">
                                <!--购买动作-->
                                {% if product.snatched %}
                    
                                    {% if !product.snatched_start %}
                                        <div class="product snatched">
                                            <span class="ui text">倒计时：<span id="clock"></span></span>
                                        </div>
                                        <div class="ui active magenta labeled tobuy icon button">
                                            准备开抢
                                        </div>
                                    {% else %}
                                        {% if product.can_saled %}
                                            <div class="ui active green labeled tobuy nowbuy icon button">
                                                立即抢购
                                            </div>
                                        {%else%}
                                            <div class="ui active black labeled icon button">
                                                已抢完
                                            </div>
                                        {%endif%}
                                    {% endif %}
                        
                                {% else %}
                                    {% if product.is_try %}
                                        <div class="ui danger message">
                                            此产品为试用商品，不可销售!
                                        </div>
                                    {%else%}
                                        {% if product.can_saled %}
                                            <div class="ui active magenta labeled icon nowbuy button">
                                                <i class="cart icon"></i>立即购买
                                            </div>
                                        {%else%}
                                            <div class="ui active gray inverted button">
                                                <i class="cart icon"></i> 已售罄
                                            </div>
                                        {%endif%}
                                    {%endif%}
                                {%endif%}
                    
                    			<div class="ui active green icon share button">
                    				<i class="share icon"></i>
                    			</div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                {% if product.stage == 5 %}
    				<div class="ui very relaxed divided money selection list">
    					<div class="item">
    						<div class="right floated">
    							<span class="ui magenta text"><small>￥</small>{{ product.presale_count|default 0 }}</span>
    						</div>
    						<div class="content">
    							<div class="header">预定人数</div>
    						</div>
    					</div>
    					<div class="item">
    						<div class="right floated">
    							<span class="ui magenta text"><small>￥</small>{{ product.presale_money|default 0 }}</span>
    						</div>
    						<div class="content">
    							<div class="header">完成金额</div>
    						</div>
    					</div>
    					<div class="item">
    						<div class="right floated">
    							<span class="ui magenta text">{{ product.presale_percent }}<small>%</small></span>
    						</div>
    						<div class="content">
    							<div class="header">达成率</div>
    						</div>
    					</div>
    				</div>
        			{% sku_list var:'presales' product_id:product._id stage:5 %}
        			<div class="ui one levels">
        				{% for presale in presales.rows %}
        				<div class="ui level">
        					<h3 class="ui header">{{ presale.name }}</h3>
        					<div class="content">
        						<p class="time">
        							{% if presale.mode %}
        								{{ presale.mode }}
        							{% endif %}
        							{% if presale.limited_count %}
        								, 限量{{ presale.limited_count }}个
        							{% endif %}
        						</p>
        						<p class="time">
        							{{ presale.summary }}
        						</p>
        						<div class="price">
        							￥ {{ presale.price }}
        						</div>
        					</div>
        					<div class="actions">
        						{% if !product.presale_finished %}
        							{% if presale.quantity %}
        								<div class="ui magenta booked button" data-id="{{ presale._id }}" data-pid="{{ product._id }}">
        									现在预定
        								</div>
        							{% else %}
        								<div class="ui disabled active gray button">
        									已抢完
        								</div>
        							{% endif %}
        						{% else %}
        							{% if presale.quantity %}
        								<div class="ui disabled button">
        									预售结束
        								</div>
        							{% else %}
        								<div class="ui disabled active gray button">
        									已抢完
        								</div>
        							{% endif %}
        						{% endif %}
        						<p class="small">已有{{ presale.sold }}位预定者</p>
        					</div>
        				</div>
        				{% endfor %}
        			</div>
                {% endif %}
            </div>
			
		</div>
	</div>
</div>

<!--商品介绍-->
<div class="ui responsive grid">
	<div class="row">
		<div class="column">
			<div class="ui segment">
				<h4 class="ui dividing header">
					产品详情
				</h4>
				<div class="product content froala-element">
					{{ product.content }}
				</div>
			</div>
		</div>
	</div>
	{% if product.stage == 9 %}
    {% if product.comment_count %}
    <!--商品评价-->
    <div class="row">
      <div class="column">
        <div class="ui reply segment">
          <h4 class="ui dividing header">
            用户评价 {% if product.comment_count %}<small>（{{ product.comment_count }}）</small>{% endif %}
          </h4>
          <div class="ui threaded minimal comments">
            {% comment_list var:'comments' page:page target_id:product._id %}
            {% for comment in comments.rows %}
            <div class="comment" id="{{ comment._id }}">
              <a class="avatar" href="{{ comment.user.home_url }}">
                <img src="{{ comment.user.small_avatar_url }}" alt="{{ comment.user.nickname }}" />
              </a>
              <div class="content">
                <a class="author ui magenta link" href="{{ comment.user.home_url }}">{{ comment.user.nickname }}</a>
                <div class="metadata">
                  <div class="date">{{ comment.created_on }}</div>
                  {% include "block/star.html" %}
                </div>
                
                <div class="text">
                  {{ comment.content }}
                </div>
                {% if visitor.is_login %}
                <div class="actions">
                  <a class="reply showbox" href="#reply_{{ comment._id }}">回复</a>
                  <a class="delete confirm-request" href="{{ app_url_comment }}/delete?id={{ comment._id }}">删除</a>
                </div>
                <form class="ui reply hide form" action="{{ app_url_comment }}/ajax_reply" method="post" id="reply_{{ comment._id }}">
                  <input type="hidden" name="type" value="2" />
                  <input type="hidden" name="comment_id" value="{{ comment._id }}" />
                  <input type="hidden" name="target_id" value="{{ topic._id }}" />
                  <div class="field">
                    <textarea name="content" class="reply-content"></textarea>
                  </div>
                  <div class="ui active button magenta submit labeled icon">
                    <i class="icon location"></i> 回复
                  </div>
                </form>
                {% endif %}
              </div>
          
              {% if comment.reply %}
              <div class="comments">
                {% for reply in comment.reply %}
                  <div class="comment">
                    <a class="avatar" href="{{ reply.user.home_url }}" title="{{ reply.user.nickname }}">
                      <img src="{{ reply.user.small_avatar_url }}" alt="{{ reply.user.nickname }}" />
                    </a>
                    <div class="content">
                      <a class="author">{{ reply.user.nickname }}</a>
                      <div class="metadata">
                        <div class="date">{{ reply.replied_on }}</div>
                      </div>
                      <div class="text">
                        {{ reply.content }}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
              {% endif %}
          
            </div>
            {% endfor %}
          </div>
          
        </div>
      </div>
    </div>
    {% endif %}<!--if product.comment_count-->
  {% endif %}<!--if stage==9-->
</div>
{% include "block/sharebox.html" %}
{% endblock %}
