{%extends 'layout/mobile.html'%}
{% block title%}填写订单信息-{% endblock %}
{% block page_css %}
<style type="text/css">
	
</style>
{% endblock %}

{% block jquery %}
	$('#checkout-form').form({
		addbook_id: {
			identifier  : 'addbook_id',
			rules: [
				{
					type   : 'empty',
					prompt : '收货地址不能为空'
				}
			]
		},
	}, {
		inline : false,
	    error: {
	      method : function(message){
		      phenix.show_error_note(message, 5000);
		  }
	    },
		onSuccess: function(event){
			event.preventDefault();
			$(this).ajaxSubmit({
				dataType: 'json',
				beforeSubmit: function(){
					phenix.before_submit();
				},
				success: function(result){
					phenix.after_submit();
					if(result.is_error){
						phenix.show_error_note(result.message, 5000);
					}else{						
						phenix.redirect(result.redirect_url, 0);
					}
				}
			});
		}
	});
	// 选择填写红包
	$('#submit-bonus').click(function(){
		var bonus_code = $('#bonus-code').val();
    var gift_val =  $('#gift-code').val();
    if(gift_val){
 			phenix.show_error_note('礼品码和红包不能同时使用!', 3000);  
    }
		if(bonus_code){
			$.post('{{ app_url_wap }}/shop/ajax_bonus', {rid: '{{ order_info.rid }}', code: bonus_code}, function(result){
				if(result.success){
					$('#order-discount-money').text(result.data.discount_money);
					$('#order-pay-money').text(result.data.pay_money);
				}else{
					phenix.show_error_note(result.message, 3000);
				}
			}, 'json');
		}else{
			phenix.show_error_note('请输入红包码', 3000);
		}
	});
	// 选择使用红包
	$('.inbonus').change(function(){
		var code = $('.inbonus:checked').val();
		$.post('{{ app_url_wap }}/shop/ajax_bonus', {rid: '{{ order_info.rid }}', code: code}, function(result){
			if(result.success){
				$('#order-discount-money').text(result.data.discount_money);
				$('#order-pay-money').text(result.data.pay_money);
			}else{
				phenix.show_error_note(result.message, 3000);
			}
		}, 'json');
	});

  //插入已存在的红包
  $('.code-select').click(function(){
    var code = $(this).attr('code');
    $("input[name='bonus_code']").val(code);
  });
	
	// 选择填写礼品码
	$('#submit-gift').click(function(){
		var gift_code = $('#gift-code').val();
		var bonus_val = $('#bonus-code').val();
    if(bonus_val){
 			phenix.show_error_note('礼品码和红包不能同时使用!', 3000);  
    }
		if(gift_code){
			$.post('{{ app_url_wap }}/shop/ajax_gift', {rid: '{{ order_info.rid }}', code: gift_code}, function(result){
				if(result.success){
					alert(result.message);
					//phenix.show_ok_note('已成功使用礼品码！', 2000);
					$('#order-discount-money').text(result.data.discount_money);
					$('#order-pay-money').text(result.data.pay_money);
				}else{
					phenix.show_error_note(result.message, 3000);
				}
			}, 'json');
		}else{
			alert('请输入礼品码');
			//phenix.show_error_note('请输入礼品码', 3000);
		}
	});
	
{% endblock %}

{% block content %}
<div class="checkout page">
	<form action="{{ app_url_wap }}/shop/confirm" method="post" id="checkout-form" class="ui form">
		<input type="hidden" name="rrid" value="{{ order_info.rid }}" />
		<input type="hidden" name="event_type" value="{{ data.event_type }}" />
		<input type="hidden" name="addbook_id" value="{{ default_addbook._id }}" />
		
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<h5 class="ui dividing header">确认订单信息</h5>
					<div class="ui segment">
						<div class="ui very relaxed divided address list">
							<div class="item">
								<div class="right floated">
									<a href="{{ app_url_wap }}/shop/address?rrid={{ order_info.rid }}&addrid={{ default_addbook._id }}" class="ui magenta icon link">
										<i class="circle right icon"></i>
									</a>
								</div>
								<div class="content" style="max-width: 196px;">
									{% if default_addbook %}
									<div class="header">{{ default_addbook.name }} ({{ default_addbook.phone }})</div>
									{{ default_addbook.area_province.city}} {{ default_addbook.area_district.city }} {{ default_addbook.address }} ({{ default_addbook.zip }})
									{% else %}
									<div class="header">请选择送货地址</div>
									{% endif %}
								</div>
							</div>
						</div>
					</div>
				
					<div class="ui segment">
						<div class="ui very relaxed divided list">
							<div class="item">
								<label>支付方式：</label> <span class="ui magenta text">在线支付</span>
							</div>
							<div class="item">
								配送方式： <span class="ui magenta text">免费配送</span>
							</div>
							<div class="item">
								送货时间：
							</div>
							<div class="item">
								<div class="ui radio checkbox">
									<input name="transfer_time" type="radio" value="a" checked="checked" />
									<label><span class="ui text">不限送货时间</span></label>
								</div>
							</div>
							<div class="item">
								<div class="ui radio checkbox">
									<input name="transfer_time" type="radio" value="b" />
									<label><span class="ui text">星期一至星期五</span></label>
								</div>
							</div>
							<div class="item">
								<div class="ui radio checkbox">
									<input name="transfer_time" type="radio" value="c" />
									<label><span class="ui text">星期六、日</span></label>
								</div>
							</div>
						</div>
					</div>

					<div class="ui segment">
						<label>备注信息:</label>
						<div class="field">
							<textarea name="summary" class="mini" maxlength="140"></textarea>
						</div>
					</div>
				
					<div class="ui segment">
						<label>商品清单：<small>共<b id="cart-items-count" class="money">{{ data.items_count }}</b>件商品</small></label>
						<div class="ui celled goods list">
							{% for product in data.items %}
							<div class="item" id="product_{{ product.sku }}">
						    	<img class="ui mini image" src="{{ product.cover }}" />
						    	<div class="content">
						      		<div class="header">
										<a href="{{ product.view_url }}" class="ui link">{{ product.title }}</a>
									</div>
						      	  	<small class="ui gray text">价格：￥{{ product.sale_price }} </small> <small class="ui gray text">数量：{{ product.quantity }}个</small>
						    	</div>
						  	</div>
							{% endfor %}
						</div>
					</div>
					
					<div class="ui styled fluid accordion">
						<div class="active title">
							<i class="dropdown icon"></i>
							使用红包
						</div>
						<div class="active content">
							<p></p>
							{% bonus_list var:'bonus' page:1 size:10 user_id:visitor.id used:1 not_expired:1 %}
							{% for b in bonus.rows %}
							<div class="bonus item">
								<div class="field">
									<div class="ui radio checkbox">
                    <!--<input name="bonus" type="radio" value="{{ b.code }}" class="inbonus" />-->
                    <label>
                      <span class="ui magenta text">{{ b.amount }}元</span> <small>{{ b.expired_label }} </small>
                      <a href="javascript:void(0);" class="code-select" code="{{ b.code }}"> 插入</a>
                    </label>
									</div>
								</div>
							</div>
							{% endfor %}
							
							<div class="ui fluid action input">
							  <input placeholder="输入红包码..." name="bonus_code" type="text" id="bonus-code" />
							  <div class="ui active magenta button" id="submit-bonus">确定</div>
							</div>
					    </div>
						
						<div class="title">
							<i class="dropdown icon"></i>
							使用礼品码
						</div>
						<div class="content">
							<div class="ui fluid action input">
							  <input placeholder="输入礼品码..." name="gift_code" type="text" id="gift-code" />
							  <div class="ui active magenta button" id="submit-gift">确定</div>
							</div>
					    </div>
						
					</div>
			
				
					<div class="ui segment">
						<div class="ui very relaxed divided money list">
							<div class="item">
								<div class="right floated">
									<small>￥</small>{{ data.total_money }}
								</div>
								<div class="content">
									<div class="header">商品金额：</div>
								</div>
							</div>
							<div class="item">
								<div class="right floated">
									<small>￥</small>{{ data.freight }}
								</div>
								<div class="content">
									<div class="header">运费：</div>
								</div>
							</div>
							<div class="item">
								<div class="right floated">
									<small>￥</small><span class="ui text" id="order-discount-money">{{ data.discount|default 0 }}</span>
								</div>
								<div class="content">
									<div class="header">优惠金额：</div>
								</div>
							</div>	
							<div class="item">
								<div class="right floated">
									<small>￥</small><span class="ui magenta text" id="order-pay-money">{{ pay_money }}</span>
								</div>
								<div class="content">
									<div class="header">订单金额：</div>
								</div>
							</div>
						</div>
					</div>
				
					<div class="ui active fluid magenta submit button">
						去结算
					</div>
				</div>
			</div>
		</div>
	</form>
</div>
{% endblock %}
