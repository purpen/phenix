{%extends 'layout/mobile.html'%}
{% block title %}{{ topic.title }}-{% endblock %}
{% block page_css %}
<style type="text/css">
  #comment-list{
    font-size:16px !important;
  }
</style>
{% endblock %}

{% block layout_js %}
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">

  var per_page = 10;
  function fetch_comment(current_page, per_page){
    var url = '{{ app_url_wap }}/app/site/comment/ajax_fetch_comment_wap';
    $.get(url, {target_id: {{ topic._id }}, type: 2, page: current_page, per_page: per_page});
  }

    var m_name = '{{ topic.title }}';
    {% if topic.cover %}
      var img_url = '{{ topic.cover.thumbnails.big.view_url }}';
    {%else%}
      var img_url = 'http://frstatic.qiniudn.com/images/logo/logo.png';
    {%endif%}
    var link = '{{ topic.wap_view_url }}';
    var desc_str = '太火鸟科技 Taihuoniao.com 是中国最火爆的智能硬件孵化平台。太火鸟致力于建设重构产品研发创新流程，努力帮助设计师和创意者实现商业价值，从广泛的创意中寻找具有「创新价值」且可以被称为「性感设计」的产品，开启一个全新的众包设计时代。太火鸟孵化的团队将从商品定义、投资融资、硬件品控、软件体验、推广营销、渠道建设等每个环节全程全力支持，真正做到一条龙服务式的智能硬件孵化平台；全力打造一个完美的创意生态系统。';

    wx.config({
        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: '{{ app_id }}', // 必填，公众号的唯一标识
        timestamp: {{ timestamp }}, // 必填，生成签名的时间戳
        nonceStr: '{{ wxnonceStr }}', // 必填，生成签名的随机串
        signature: '{{ wxSha1 }}',// 必填，签名，见附录1
        jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'onMenuShareQQ', 'onMenuShareWeibo', 'hideMenuItems'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });

  wx.ready(function(){
    // 2.1 监听“分享给朋友”，按钮点击、自定义分享内容及分享结果接口
     wx.onMenuShareAppMessage({
      title: m_name,
      desc: desc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });      

    // 2.2 监听“分享到朋友圈”按钮点击、自定义分享内容及分享结果接口
    wx.onMenuShareTimeline({
      title: m_name,
      desc: desc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });

    // 2.3 监听“分享到QQ”按钮点击、自定义分享内容及分享结果接口
    wx.onMenuShareQQ({
      title: m_name,
      desc: desc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });

    // 2.4 监听“分享到微博”按钮点击、自定义分享内容及分享结果接口
    wx.onMenuShareWeibo({
      title: m_name,
      desc: desc_str,
      link: link,
      imgUrl: img_url,
      success: function (res) {
        record_share_num();
      }
    });
  });

  //记录分享数/同时送积分
  function record_share_num(){
    var url = '{{ app_url_wap }}/app/site/promo/ajax_stat_sum_record';
    $.get(url, { target_id: '{{ topic._id }}', count_name:'count', type: 3, kind:1 });
		// 验证是否登录,同时送积分
		if (phenix.visitor.is_login){
      $.get('{{ app_url_wap }}/app/site/my/give_point', { evt: 1, type: 1 });
		}

  }

	//编辑器指定插入位置
  (function($){
      $.fn.extend({
          insertAtCaret: function(myValue){
              var $t=$(this)[0];
              if (document.selection) {
                  this.focus();
                  sel = document.selection.createRange();
                  sel.text = myValue;
                  this.focus();
              }
              else
                  if ($t.selectionStart || $t.selectionStart == '0') {
                      var startPos = $t.selectionStart;
                      var endPos = $t.selectionEnd;
                      var scrollTop = $t.scrollTop;
                      $t.value = $t.value.substring(0, startPos) + myValue + $t.value.substring(endPos, $t.value.length);
                      this.focus();
                      $t.selectionStart = startPos + myValue.length;
                      $t.selectionEnd = startPos + myValue.length;
                      $t.scrollTop = scrollTop;
                  }
                  else {
                      this.value += myValue;
                      this.focus();
                  }
          }
      })  
  })(jQuery);

  $(function(){

    //图片上传方式切换
    $('.img-url-btn').click(function(){
      $('#img-link-box').show();
      $('#img-upload-box').hide();
      $(':input[name=img-type]').val(1);
    });
    $('.img-upload-btn').click(function(){
      $('#img-upload-box').show();
      $('#img-link-box').hide();
      $(':input[name=img-type]').val(2);
    });

    //图片上传弹出按钮
    $('.comment-upload-btn').click(function(){
			log();
			alert(123);
      $('.comment-insert-img').modal('show');
      return false; 
    });
    
    //插入链接弹出按钮
    $('.comment-link-btn').click(function(){
      $('.comment-insert-link').modal('show');
      return false; 
    });


    //取消插入弹出框
    $('.ui.deny.button').click(function(){
      $('.comment-insert-img').modal('hide');
      $('.comment-insert-link').modal('hide');
    });


		//插入图片到编辑器
    $('.ui.comment-submit.img').on('click', function(){
      var img_type = $(':input[name=img-type]').val();
      if(img_type==1){
        var img_url = $(":input[name='comment-img-url']").val();
        var img_title = $(":input[name='comment-img-title']").val();
        if(img_url != ''){
          var img_info = "[i:"+img_url+"::"+img_title+":]";
          $('#comment-area').insertAtCaret(img_info);   
        }
      }else{
        var i = 0;
        var img_descs = $(":input[name='comment-asset-desc']");
        $(":input[name='comment-asset']").each(function(){
          var img_url = $(this).attr('img_url');
          var img_desc = $(img_descs[i]).val();
          var img_info = "[i:"+img_url+"::"+img_desc+":]";
          $('#comment-area').insertAtCaret(img_info);
          i++;
        });
        $('#asset-list').html('');     
      }
			$('.comment-insert-img').modal('hide');
        
    });

		//插入链接到编辑器
    $('.ui.comment-submit.url').on('click', function(){
      var link_url = $(":input[name='comment-link-url']").val();
      var link_title = $(":input[name='comment-link-title']").val();
      if(link_url != '' || link_title != ''){
        var link_info = "[l:"+link_url+"::"+link_title+":]";
        $('#comment-area').insertAtCaret(link_info);     
      }
      $('.comment-insert-link').modal('hide');
    });


    var comment_file_count = 1;
    var comment_ord = function(){
      return comment_file_count++;
    };
    //评论图片上传
    $('#phenix-comment-uploader').fineUploader({
      debug: true,
          request: {
        inputName:'file',
        params: {'token': '{{ comment_token }}','x:pid': '{{ comment_pid }}', 'x:domain': '{{ comment_domain }}', 'x:ord': comment_ord, 'x:user_id': {{ visitor._id }},'x:asset_type': {{ comment_asset_type }},'x:parent_id': '{{ comment_pid }}','file_id': '{{ comment_pid }}' },
            endpoint: '{{ app_url_upload }}/comment'
          },
      text: {
              uploadButton: '<a class="ui active magenta labeled icon button" href="javascript:void(0);"><i class="cloud upload icon"></i>选择图片</a>'
      },
      template: '<div class="qq-uploader">' +
            '<pre class="qq-upload-drop-area"><span>{dragZoneText}</span></pre>' +
            '<div class="qq-upload-button">{uploadButtonText}</div>' +
            '<span class="qq-drop-processing"><span>{dropProcessingText}</span><span class="qq-drop-processing-spinner"></span></span>' +
            '<ul class="qq-upload-list clearfix" style="margin-top: 5px; text-align: center;"></ul>' +
            '</div>',
      validation: {
            allowedExtensions: ['jpeg', 'jpg', 'png'],
            sizeLimit: 3145728 // 3M = 3 * 1024 * 1024 bytes
        }
      }).on('complete', function (event, id, name, result) {
      if(result.is_error){
        phenix.show_error_note(result.message);
      }else{
        $('.qq-upload-list').children().eq(id).fadeOut();
        
        $.get('{{ app_url_action_base }}/uploader/check_upload_assets', {'assets': result.data.ids, 'asset_type': {{ comment_asset_type||default 0 }}, 'asset_domain':'{{ comment_domain }}'});
      }
    });

      
  });
</script>
{% endblock %}

{% block jquery %}
	phenix.hook_comment_page();

  //ajax加载评论
  fetch_comment(1, per_page);

	/* 登录用户行为 */
	{% if visitor.is_login %}
		// 初始化互动，是否收藏、点赞
		$.get('{{ app_url_wap }}/app/site/favorite/ajax_done', {id: {{topic._id}},type:2,event:1}, function(result){
			if (result.success) {
				// 验证收藏
				if (result.data.favorited) {
					$('.ui.favorite.button')
						.data('content', '取消')
						.data('mark', 'y')
						.addClass('active');
				}
			}
		}, 'json');
		
		// 验证点赞
		$.get('{{ app_url_wap }}/app/site/favorite/ajax_done', {id: {{topic._id}},type:2,event:2}, function(result){
			if (result.success) {
				if (result.data.loved) {
					$('.ui.support.button')
						.data('content', '取消支持')
						.data('mark', 'y')
						.addClass('active');
				}
			}
		}, 'json');

		/* 登录用户行为 */
	{% endif %}

	// 喜欢
	$('.ui.support.button').bind('click', function(){
		var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
      phenix.show_error_note('请先登录!');
			phenix.show_login_box();
			return false;
		}
		if (mark == 'n') {
			$.post('{{ app_url_wap }}/app/site/favorite/ajax_laud', {id: id, type:2}, function(result){
				if (result.success) {
					$btn
						.data('content', '取消赞')
						.data('mark', 'y')
						.addClass('active')									
						.html('<i class="thumbs outline up icon"></i> <div class="love count">'+ result.data.love_count +'</div>');
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		} else {
			$.post('{{ app_url_wap }}/app/site/favorite/ajax_cancel_laud', {id: id, type:2}, function(result){
				if (result.success) {
					$btn
						.data('content', '点赞')
						.data('mark', 'n')
						.removeClass('active')
						.html('<i class="thumbs outline up icon"></i> <div class="love count">'+ result.data.love_count +'</div>');
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		}
	});

{% endblock %}
{% block content %}
<div id="postpage">
	<section class="ui big block">
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<div class="ui breadcrumb">
					  	<a class="section" href="{{ app_url_wap }}">
							<i class="icon home"></i>首页
						</a>
					  	<div class="divider"> / </div>
					  	<a class="section" href="{{ app_url_wap }}/social">社区</a>
					  	<div class="divider"> / </div>
					  	<a class="section" href="{{ app_url_wap }}/social/c{{ topic.category._id }}">{{ topic.category.title }}</a>
					  	<div class="divider"> / </div>
					  	<div class="active section">{{ topic.title|truncate 30 }}</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="column">
						<div class="ui big topic segment">
							<div class="ui header">
								<div class="content">
									{{ topic.title }}
									<div class="sub header attribute">
										<span class="category"><a href="{{ app_url_topic }}/c{{ topic.category._id }}" class="ui magenta link">{{ topic.category.title }}</a></span> | 
										<span class="date">{{ topic.user.nickname }} 发表于 {{ topic.created_on|relative_datetime }}</span> | 
										<span class="count">浏览数: {{ topic.view_count }}</span>
									</div>
								</div>
							</div>
					
							{% if is_match_idea %}
							<div class="post">
								<div class="ui contest">
									<a href="{{ app_url_wap }}/dream" class="ui magenta link">太火鸟-十万火计产品创意与创新想法征集活动</a> 参赛作品
								</div>
							</div>
							{% endif %}
					
							<div class="post froala-element clearfix">
								{{ topic.description }}
							</div>
					
							{% if topic.tags %}
							<div class="tags">
								{% for tag in topic.tags %}
									{% if tag %}
									<a href="{{ app_url_domain }}/tag/{{ tag }}" class="ui icon link">
										<i class="tag icon"></i>{{ tag }}
									</a>
									{% endif %}
								{% endfor %}
							</div>
							{% endif %}
						</div>

          <div class="ui grid" style="margin-bottom:10px;">
						<div class="row">
							<div class="center aligned column">
								<div class="ui pop icon support inverted magenta button" data-content="点赞" data-variation="inverted" data-id="{{ topic._id }}" data-mark="n">
								  	<i class="thumbs outline up icon"></i>
									<div class="love count">
										{{ topic.love_count|default 0 }}
									</div>
								</div>
							</div>
						</div>
          </div>
				
            <div class="ui big reply segment">
              <!--ajax comment-->
              <div id="comment-list"></div>
              {% include "block/comment_box_wap.html" %}
            </div>

					</div>
				</div>
		</div>
	</section>

</div>
<div class="ui comment-insert-img small modal transition">
  	<i class="flat close icon"></i>
	<div class="header">
	    插入图片
	</div>
	<div class="container">
    <div class="img-tab"><a href="javascript:void(0);" class="img-url-btn">链接地址</a>|<a href="javascript:void(0);" class="img-upload-btn">本地上传</a></div>
		<form action="" class="ui form" method="post" id="comment-upload-form">
		  	<div class="content">
        <input type="hidden" name="img-type" value="1" />
				<div class="ui signup-box" id="img-link-box">
          <div class="field">
            <label>图片地址</label>
            <input type="text" name="comment-img-url" value="" placeholder="http://" />
          </div>
          <div class="field">
            <label>图片描述</label>
            <input type="text" name="comment-img-title" value="" />
          </div>
				</div>

				<div class="ui signup-box" id="img-upload-box" style="display:none;">
							<div id="phenix-comment-uploader"></div>
							<div id="asset-list" class="ui four items"></div>
				</div>

		  	</div>
			<div class="right aligned action">
			    <div class="ui gray deny inverted button">
					取消
			    </div>
			    <div class="ui magenta comment-submit img inverted button">
					插入
			    </div>
			</div>
		</form>
	</div>
</div>

<div class="ui comment-insert-link small modal transition">
  	<i class="flat close icon"></i>
	<div class="header">
	    插入链接
	</div>
	<div class="container">
		<form action="" class="ui form" method="post" id="comment-link-form">
		  	<div class="content">

				<div class="ui signup-box">
          <div class="field">
            <label>链接地址</label>
            <input type="text" name="comment-link-url" value="" placeholder="http://" />
          </div>
          <div class="field">
            <label>链接名称</label>
            <input type="text" name="comment-link-title" value="" />
          </div>
				</div>
		  	</div>
			<div class="right aligned action">
			    <div class="ui gray deny inverted button">
					取消
			    </div>
			    <div class="ui magenta comment-submit url inverted button">
					插入
			    </div>
			</div>
		</form>
	</div>
</div>
{% endblock %}
