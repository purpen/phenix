{%extends 'layout/mobile.html'%}
{% block title%}{% endblock %}
{% block page_css %}
<style type="text/css">
  #mfrbird{
  	margin-top:0;
  	margin-bottom:2em;
  }
  #tmenu{
  	width: 100%;
  	height: 42px;
  	overflow: hidden;
  }
  #tmenu .swiper-slide {
  	padding: 0 20px;
  	width:auto;
  	line-height: 43px;
  }
  #tmenu .swiper-slide a{
  	color: #5d6266;
  	text-decoration: none;
    font-weight: 700;
  	padding: 10px 0;
  }
  .swiper-slide a.ui.active.item {
    color: #f36 !important;
    border-bottom: 3px solid #f36;
  }
  .recommend-topic{
  	width: 100%;
      height: 100%;
      overflow: hidden;
      font-size: 0;
  	position:relative;
  	padding-top: 4px;
  }
  .recom-item{
  	width: 100%;
      font-size: 0;
      overflow: hidden;
  	padding: 0;
  	margin:0;
  	height: 100%;
  	position: relative;
  }
  .recom-cell{
  	width:50%;
  	height: 100%;
  	display: inline-block;
  	padding-right: 4px;
  	margin: 4px 0;
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box; 
  }
  .recom-cell:nth-child(2n){
  	padding-left:4px;
  	padding-right:0;
  }
  .recom-cell a{
  	text-decoration: none;
  	position:relative;
  	display: block;
  	clear: both;
  	height: 100%;
  }
  .recom-cell a img{
      width: 100%;
      height: auto;
      overflow: hidden;
      vertical-align: bottom;
  }
  .recom-cell a .desc,a.trycell .desc{
      background: -moz-linear-gradient(top,rgba(0,0,0,0.0),rgba(0,0,0,0.7));
      background: -webkit-gradient(linear, 0% 0%, 0% 100%,from(rgba(0,0,0,0.0)), to(rgba(0,0,0,0.7)));
      background: -webkit-linear-gradient(top, rgba(0,0,0,0.0), rgba(0,0,0,0.7));
      background: -o-linear-gradient(top, rgba(0,0,0,0.0), rgba(0,0,0,0.7));
      width: 100%;
      height: 60px;
      line-height: 95px;
      position: absolute;
      bottom: 0;
      left: 0;
      font-size: 12px;
      color: #fff;
      text-align: center;
      padding: 0 5px;
  	white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
  }
  h4 a.seemore{
      font-size: 12px;
      display: inline-block;
      float: right;
  }
  #triespage h4.ui.header,#mpresale h4.ui.header{
  	margin-bottom:10px;
  }
  #triespage .recom-cell a .desc{
  	position:relative;
      background: #fff;
      padding: 6px 5px 0;
  	height:auto;
  }
  #triespage .recom-cell a .desc h2{
      font-weight: 500;
      overflow: hidden;
      text-align: left;
      margin: 0;
      text-overflow: ellipsis;
      white-space: nowrap;
  	color: rgba(112,123,135,.91);
      font-size: 13px;
  }
  #triespage .recom-cell a .desc .excerpt{
      color: rgba(146,147,163,.9);
      font-size: 12px;
      letter-spacing: .1px;
      overflow: hidden;
      text-align: left;
  	padding: 4px 0 5px;
  }
  #triespage .recom-cell a .desc .excerpt .count{
  	margin-right:3px;
  }
  .pb-0{
  	padding-bottom:0 !important;
  }
  #mpresale .recom-cell a .desc{
      padding: 15px 5px 0;
  	line-height: inherit;
  	background: -moz-linear-gradient(top,rgba(255,255,255,0.1),rgba(255,255,255,0.8));
      background: -webkit-gradient(linear, 0% 0%, 0% 100%,from(rgba(255,255,255,0.1)), to(rgba(255,255,255,0.8)));
      background: -webkit-linear-gradient(top, rgba(255,255,255,0.1), rgba(255,255,255,0.8));
      background: -o-linear-gradient(top, rgba(255,255,255,0.1), rgba(255,255,255,0.8));
  }
  #mpresale .recom-cell a .desc h2{
  	line-height: 22px;
      height: 22px;
      font-weight: 700;
      overflow: hidden;
      text-align: left;
      margin: 0;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: rgba(0,0,0,0.6);
      font-size: 13px;
  }
  #mpresale .recom-cell a .desc .cats{
  	font-size:12px;
      font-weight: 400;
      overflow: hidden;
      padding: 0;
      text-align: left;
      text-overflow: ellipsis;
      text-transform: uppercase;
      white-space: nowrap;
      color: #f36;
  }
  #mpresale .recom-cell a .desc .counter {
      font-size: 12px;
      position: absolute;
      right: 10px;
      bottom: 3px;
      color: #5d6266;
  }
</style>
{% endblock %}

{% block layout_js %}
  <script type="text/javascript" >
      function ajax_load_more(category_id, type, sort, page, size){
          //防止频繁请求(在没加载完成时只允许请求一次)
          $('#product-more').show().attr('status', 1);
          var url = '{{ app_url_wap }}/shop/ajax_load_list';
          $.get(url, { category_id:category_id, sort:sort, page:page, type:type, size:size }, function(rs){
              // console.log('total page: '+ rs.data.results.total_page + ' page: '+ rs.data.results.current_page);
              if(rs.data.results.total_page > rs.data.results.current_page){
                  $('#product-more')
                      .hide()
                      .attr({'status': 0, 'page': rs.data.page, category_id: rs.data.category_id});
              }else{
                  $('#product-more').html('没有更多');
              }
              var rendered = phenix.ajax_render_result('#fetch_more_products_tpl', rs.data);
              $('.item-box').append(rendered);
          }, 'json');
      }
  </script>
{% endblock %}

{% block jquery %}
  //预售结束时间
	$('[data-countdown]').each(function() {
		var $this = $(this), finalDate = $(this).data('countdown');
		$this.countdown(finalDate, function(event) {
			$this.html(event.strftime('%-D'));
		});
	});
	
	window.onload = function() {
		var mySwiper2 = new Swiper('#tmenu',{
		  freeMode : true,
		  slidesPerView : 'auto',
	  });
	}

  //ajax加载更多(滚动条接近底部加载)
  $(window).scroll(function(){
　　var scrollTop = $(this).scrollTop();
　　var scrollHeight = $(document).height();
　　var windowHeight = $(this).height();
　　if(scrollTop + windowHeight > scrollHeight-100){
      var stat = $('#product-more').attr('status');
      var page = parseInt($('#product-more').attr('page')) + 1;
      var category_id = $('#product-more').attr('category_id');

      if(stat==0){
        ajax_load_more(category_id, 0, 4, page, 12);
      }
　　}
  });

  ajax_load_more('{{cid}}', 0, 4, 1, 12);

  $('.category-btn').click(function(){
    $('.category-btn').removeClass('active');
    $(this).addClass('active');
    var category_id = $(this).attr('category_id');
    $('#product-more').attr('category_id', category_id);
    $('#mproducts .item-box').html('');
    ajax_load_more(category_id, 0, 4, 1, 12);
  });
  
{% endblock %}

{% block content %}
	
<div id="tmenu">
	<div class="swiper-wrapper">
		{% category_list var:'category' only_open:1 domain:1 show_all:0 current:cid sort_field:'total_desc' %}
		{% for cat in category.rows %}
      {% if cat.sub_count>0 %}
        <div class="swiper-slide">
          <a class="ui {{ cat.active }} item category-btn" category_id="{{ cat._id }}" href="javascript:void(0);">{{ cat.title }}</a>
        </div>
      {%endif%}
		{% endfor %}
	</div>
</div>
	
<!--商店商品-->
<div class="ui responsive grid" id="mpresale" style="border-top: 1px solid rgba(34,36,38,.15);">
	<div class="row">
		<div class="recom-item">
			
		</div>
	</div>

  <!--ajax load-->
  <div id="product-more" class="topic-box-list" style="display:none;" category_id="{{ cid }}" page="1" status="0">
    <div style="text-align:center;margin:10px auto;">
      <img src="{{ app_url_packaged }}/images/loading03.gif" alt="loading" width="30" height="30">
    </div>
  </div>

</div>

{% endblock %}

{% block templates %}
{% mustache id:'fetch_more_products_tpl' tpl:'mustache_m/fetch_more_products.mustache' %}
{% endblock %}
