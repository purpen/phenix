{%extends 'layout/mobile.html'%}
{% block title%}{% endblock %}
{% block page_css %}
<link rel="stylesheet" href="http://frstatic.qiniudn.com/wechat/js/swiper.min.css">
<style type="text/css">
  #mfrbird{
  	margin-top:0;
  	margin-bottom:2em;
  }
  #tmenu{
  	width: 100%;
  	height: 42px;
  	overflow: hidden;
  }
  #tmenu .swiper-slide {
  	padding: 0 20px;
  	width:auto;
  	line-height: 43px;
  }
  #tmenu .swiper-slide a{
  	color: #5d6266;
  	text-decoration: none;
    font-weight: 700;
  	padding: 10px 0;
  }
  .swiper-slide a.ui.active.item {
    color: #f36 !important;
    border-bottom: 3px solid #f36;
  }
</style>
{% endblock %}

{% block layout_js %}
	<script src="http://frstatic.qiniudn.com/wechat/js/swiper.min-1.js" type="text/javascript"></script>
  <script type="text/javascript" >
      function ajax_load_more(category_id, type, sort, page, size){
          //防止频繁请求(在没加载完成时只允许请求一次)
          $('#product-more').show().attr('status', 1);
          var url = '{{ app_url_wap }}/shop/ajax_load_list';
          $.get(url, { category_id:category_id, sort:sort, page:page, type:type, size:size }, function(rs){
              // console.log('total page: '+ rs.data.results.total_page + ' page: '+ rs.data.results.current_page);
              if(rs.data.results.total_page > rs.data.results.current_page){
                  $('#product-more')
                      .hide()
                      .attr({'status': 0, 'page': rs.data.page, category_id: rs.data.category_id});
              }else{
                  $('#product-more').html('没有更多');
              }
              var rendered = phenix.ajax_render_result('#fetch_more_products_tpl', rs.data);
              $('.item-box').append(rendered);
          }, 'json');
      }
  </script>
{% endblock %}

{% block jquery %}
  //预售结束时间
	$('[data-countdown]').each(function() {
		var $this = $(this), finalDate = $(this).data('countdown');
		$this.countdown(finalDate, function(event) {
			$this.html(event.strftime('%-D'));
		});
	});
	
	window.onload = function() {
		var mySwiper2 = new Swiper('#tmenu',{
		  freeMode : true,
		  slidesPerView : 'auto',
	  });
	}

  //ajax加载更多(滚动条接近底部加载)
  $(window).scroll(function(){
　　var scrollTop = $(this).scrollTop();
　　var scrollHeight = $(document).height();
　　var windowHeight = $(this).height();
　　if(scrollTop + windowHeight > scrollHeight-100){
      var stat = $('#product-more').attr('status');
      var page = parseInt($('#product-more').attr('page')) + 1;
      var category_id = $('#product-more').attr('category_id');

      if(stat==0){
        ajax_load_more(category_id, 0, 4, page, 12);
      }
　　}
  });

  ajax_load_more('{{cid}}', 0, 4, 1, 12);

  $('.category-btn').click(function(){
    $('.category-btn').removeClass('active');
    $(this).addClass('active');
    var category_id = $(this).attr('category_id');
    $('#product-more').attr('category_id', category_id);
    $('#mproducts .item-box').html('');
    ajax_load_more(category_id, 0, 4, 1, 12);
  });
  
{% endblock %}

{% block content %}
	
<div id="tmenu">
	<div class="swiper-wrapper">
		{% category_list var:'category' only_open:only_open domain:1 show_all:0 current:cid sort_field:'total_desc' %}
		{% for cat in category.rows %}
			<div class="swiper-slide">
        <a class="ui {{ cat.active }} item category-btn" category_id="{{ cat._id }}" href="javascript:void(0);">{{ cat.title }}</a>
			</div>
		{% endfor %}
	</div>
</div>
	
<!--商店商品-->
<div class="ui responsive grid" id="mproducts" style="border-top: 1px solid rgba(34,36,38,.15);">
	<div class="row">
		<div class="column">
			<div class="ui two products cards item-box">

			</div>
		</div>
	</div>

  <!--ajax load-->
  <div id="product-more" class="topic-box-list" style="display:none;" category_id="{{ cid }}" page="1" status="0">
    <div style="text-align:center;margin:10px auto;">
      <img src="{{ app_url_packaged }}/images/loading03.gif" alt="loading" width="30" height="30">
    </div>
  </div>

</div>

{% endblock %}

{% block templates %}
{% mustache id:'fetch_more_products_tpl' tpl:'mustache_m/fetch_more_products.mustache' %}
{% endblock %}
