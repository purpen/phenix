{%extends 'layout/admin.html'%}
{% block page_css %}
{% endblock %}

{% block jquery %}
	// 发布上架
	$('.item.publish-onsale').bind('click', function(){
		var selected_ids = [];
		
		$('input.checkbox:checked').each(function(){
			var v = $(this).val();
			selected_ids.push(v);
		});
		
		if (!selected_ids.length){
			alert('请选择发布产品');
		}
		
		var url = $(this).attr('href');
		$.get(url, {id: selected_ids.join(',')});
		
		return false;
	});
	
	// 删除产品
	$('.item.ajax-delete').bind('click', function(){
		var selected_ids = [];
		
		$('input.checkbox:checked').each(function(){
			var v = $(this).val();
			selected_ids.push(v);
		});
		
		if (!selected_ids.length){
			alert('请选择想删除的产品');
		}
		
		var url = $(this).attr('href');
		$.get(url, {id: selected_ids.join(',')});
		
		return false;
	});
	
{% endblock %}
	
{% block content %}
	<h3 class="ui header">产品管理</h3>
	
	<div class="ui secondary pointing magenta menu">
		<a href="{{ app_url_admin_base }}/product" class="item">
			全部
		</a>
		<a href="{{ app_url_admin_base }}/product?stage=1" class="{% if stage == 1 %}active{%endif%} item">
			投票
		</a>
		<a href="{{ app_url_admin_base }}/product?stage=5" class="{% if stage == 5 %}active{%endif%} item">
			预售
		</a>
		<a href="{{ app_url_admin_base }}/product?stage=9" class="{% if stage == 9 %}active{%endif%} item">
			热售
		</a>
	  	<div class="right menu">
	    	<a href="{{ app_url_admin_base }}/product/update_onsale" class="item publish-onsale">
				发布上线
			</a>
			
			<a href="{{ app_url_admin_base }}/product/edit" class="item">
				新增产品
			</a>
			
			<a href="{{ app_url_admin }}/product/deleted" class="item ajax-delete">
				删除
			</a>
	    </div>
	</div>
	
	<div class="ui sub nav">
		<form action="{{ app_url_admin_base }}/product" method="post">
			<label>搜索：</label>
			<div class="ui icon input">
				<input placeholder="Search..." type="text" name="q">
				<i class="flat search link icon"></i>
			</div>
		</form>
	</div>
	
	<table class="ui small table segment">
		<thead>
			<tr>
				<th>
					<div class="ui checkbox">
					  	<input name="ids" type="checkbox" />
					  	<label></label>
					</div>
				</th>
				<th>缩略图</th>
				<th class="six wide">产品名称</th>
				<th>所属阶段</th>
				<th>状态</th>
				<th>管理操作</th>
			</tr>
		</thead>
		<tbody>
			{% product_list var:'list' page:page category_id:category_id stage:stage size:20  %}
			{% for product in list.rows %}
			<tr id="{{ product._id }}">
				<td>
					<div class="ui checkbox">
					  	<input name="ids" type="checkbox" value="{{ product._id }}" class="checkbox" />
					  	<label></label>
					</div>
				</td>
				<td>
					<div class="ui image">
						<img src="{{ product.cover.thumbnails.mini.view_url }}" width="80px" />
					</div>
				</td>
				<td>
		          	<div class="header">
						<a href="{{ product.view_url }}" class="ui link" target="_blank" title="{{ product.title }}">
							{{ product.title }}
						</a>
					</div>
		          	<p class="attribute">编号：{{ product._id }}</p>
					<p class="attribute">上架时间：{{ product.created_on|date 'Y-m-d H:i'}}</p>
				</td>
				<td>
					<label class="ui green label">{{ product.stage_label }}</label>
				</td>
				<td>					
					{% if product.stage == 5 %}
						{% if product.approved %}
							<label class="ui green label">已审核</label>
						{% else %}
							<label class="ui orange label">待审核</label>
						{% endif %}
					{% endif %}
					
					{% if product.stage == 9 %}
						{% if product.published %}
							<label class="ui green label">已上架</label>
						{% else %}
							<label class="ui orange label">仓库中</label>
						{% endif %}
					{% endif %}
				</td>
				<td>
					<div class="ui divided horizontal small list">
						<a href="{{ app_url_admin_base }}/product/edit?id={{ product._id }}" class="ui link item">编辑</a>
						{% if product.stage == 1 %}
							<a href="{{ app_url_fever }}/ajax_approved?id={{ product._id }}" class="ui link item ajax">通过审核</a>
							{% if product.approved == 1%}
							<a href="{{ app_url_admin_base }}/product/update_presale?id={{ product._id }}" class="ui link item">预售设置</a>
							{% endif %}
						{% endif %}
						
						{% if product.stage == 5 %}
							<a href="{{ app_url_action_base }}/product/setting_presale?id={{ product._id }}" class="ui link item">预售设置</a>
							{% if product.published == 1%}
							<a href="{{ app_url_admin_base }}/product/update_shop?id={{ product._id }}" class="ui link item">热售设置</a>
							{% endif %}
							
						{% endif %}
						
			          	<a href="{{ app_url_admin }}/product/deleted?id={{ product._id }}" class="ui confirm-request link item">
							删除
						</a>
					</div>
				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
	
	{% if list.rows %}
	<div class="ui pagination">
		{% pager url:pager_url,total_rows:list.total_rows,total_page:list.total_page,current_page:page,var:'pager',pager_size:9 %}
		{%include 'block/pager.html'%}
	</div>
	{% endif %}
{% endblock %}