{%extends 'layout/column.html'%}
{% block title %}{{ product.title }}-{% endblock %}
{% block page_css %}
<style type="text/css">	
	.product.guess {
		padding-top: 1rem;
	}
</style>
{% endblock %}
{% block js %}
{% endblock %}

{% block layout_js %}
<script type="text/javascript">
    var per_page = 10;
	function fetch_comment(current_page, per_page){
        var total_count = {{ product.comment_count }};
        var total_page = Math.ceil(total_count/per_page);
        var url = '{{ app_url_base }}/app/site/shop/ajax_fetch_comment';
        $.get(url, {target_id: {{ product._id }}, page: current_page, per_page: per_page, total_page: total_page});
    }
</script>
{% endblock %}

{% block jquery %}
	phenix.bind_share_list();
	// 生成二维码
	$('#qrcode').qrcode({width: 256, height: 256, text: '{{ product.wap_view_url }}'});
	
	// 如果仅一个sku,则设置默认值
	{% if skus_count %}
		var choosed_sku = 0;
	{% else %}
		var choosed_sku = {{ product._id }};
	{% endif %}
	

	// 选择sku
	$('.attrs .ui.att.button').click(function(){
		choosed_sku = $(this).data('id');
		$('.attrs .ui.att.active.button').removeClass('active');
		$(this).addClass('active');
    //抢购商品sku价格均为抢购价
    {% if !product.snatched %}
		  $('#current-price').html('<span class="unit">￥</span>'+$(this).data('price'));
		{%endif%}		
		return false;
	});

	
	// 现在预约
  	$('.appoint.btn').click(function(){
    	//phenix.redirect('{{ app_url_base }}/promo/dreamk', 0);
  	});
	
	// 加入购物车
	$('.ui.buy.btn').click(function(){
		if (choosed_sku){
			$.post('{{ app_url_cart_buy }}', {sku: choosed_sku});
		} else {
			phenix.show_error_note('请选择一个型号或颜色', 3000);
		}
	});
	
	// 立即购买
	$('.ui.nowbuy.btn').click(function(){
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.show_login_box();
			return false;
		}
		if (choosed_sku){
			phenix.redirect('{{ app_url_cart_nowbuy }}?sku='+choosed_sku, 0);
		} else {
			phenix.show_error_note('请选择一个型号或颜色', 3000);
		}
	});
	
	/* 登录用户行为 */
	{% if visitor.is_login %}
		// 初始化互动，是否收藏、点赞
		$.get('{{ app_url_favorite }}/ajax_done', {id: {{product._id}},type:1,event:1}, function(result){
			if (result.success) {
				// 验证收藏
				if (result.data.favorited) {
					$('.ui.favorite.btn')
						.data('content', '取消')
						.data('mark', 'y')
						.addClass('active');
				}
			}
		}, 'json');
		
		// 验证点赞
		$.get('{{ app_url_favorite }}/ajax_done', {id: {{product._id}},type:1,event:2}, function(result){
			if (result.success) {
				if (result.data.loved) {
					$('.ui.love.btn')
						.data('content', '取消')
						.data('mark', 'y')
						.addClass('active');
				}
			}
		}, 'json');
	{% endif %}
	
	// 收藏
	$('.ui.favorite.btn').bind('click', function(){
		var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.show_login_box();
			return false;
		}
		if (mark == 'n') {
			$.post('{{ app_url_favorite }}/ajax_favorite', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('content', '取消')
						.data('mark', 'y')
						.addClass('active');
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		} else {
			$.post('{{ app_url_favorite }}/ajax_cancel_favorite', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('content', '收藏')
						.data('mark', 'n')
						.removeClass('active');
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		}
	});
	
	// 喜欢
	$('.ui.love.btn').bind('click', function(){
		var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.show_login_box();
			return false;
		}
		var count = parseInt($('#product-love-count').text());
		if (mark == 'n') {
			$.post('{{ app_url_favorite }}/ajax_laud', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('content', '取消')
						.data('mark', 'y')
						.addClass('active');
					count += 1;
					$('#product-love-count').text(count);
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		} else {
			$.post('{{ app_url_favorite }}/ajax_cancel_laud', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('content', '点赞')
						.data('mark', 'n')
						.removeClass('active');
					count -= 1;	
					$('#product-love-count').text(count);
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		}
	});
	
	var $frame = $('#procover');
	var $wrap = $frame.parent();
	$frame.sly({
		horizontal: 1,
		itemNav: 'forceCentered',
		smart: 1,
		activateMiddle: 1,
		mouseDragging: 1,
		touchDragging: 1,
		releaseSwing: 1,
		startAt: 0,
		pagesBar: $wrap.find('.pages'),
		pageItem: 'custom',
		activatePageOn: 'click',
		speed: 300,
		elasticBounds: 1,
		easing: 'easeOutExpo',
		dragHandle: 1,
		dynamicHandle: 1,
		clickBar: 1,
		// Buttons
		prev: $wrap.find('.prev'),
		next: $wrap.find('.next')
	});
	
    $('.ui.tabox').smint({
    	'scrollSpeed' : 1000
    });
	
	// 分享
	$('.ui.share.btn').bind('click', function(){
		$('.ui.share.modal').modal('show');
	});

	{% if product.snatched %}
		$('#clock').countdown('{{ product.snatched_time|date 'Y/m/d H:i:s' }}').on('update.countdown', function(event){
			var $this = $(this).html(event.strftime(''
			+ '<span class="count">%D</span> 天 '
			+ '<span class="count">%H</span> 时 '
			+ '<span class="count">%M</span> 分 '
			+ '<span class="count">%S</span> 秒'));
		});
	{% endif %}
	
  	// ajax加载评论
  	fetch_comment(1, per_page);
	
	// 加载推荐商品 
	$.get('{{ app_url_shop }}/ajax_guess_product', {sword: '{{ product.tags_s }}', size: 3});
	
{% endblock %}

{% block content %}
<div class="shop submenu">
	<div class="ui responsive grid">
		<div class="row">
			<div class="column">
				{% category_list var:'category' only_open:1 domain:domain current:product.category._id show_all:0 %}
				<div class="ui horizontal list">
					<div class="item">
						<a class="ui link" href="{{ app_url_shop }}/c0">全部</a>
					</div>
					{% for cat in category.rows %}
				  	<div class="item">
						<a class="ui {{ cat.active }} link" href="{{ cat.view_url }}">{{ cat.title }}</a>
					</div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
</div>

<div class="ui shop show" id="shoppage">
	<div class="product cover">
		<div class="ui responsive grid">
			<div class="center aligned row">
				<div class="column">
					<div class="slidebox">
						{% asset_list var:'assets' parent_id:product._id size:10 asset_type:10 %}
					
						<div id="procover" class="frame">
							<ul class="clearfix">
								<li class="active">
									<img src="{{ product.cover.thumbnails.big.view_url }}" alt="{{ product.title }}" />
								</li>
								{% for asset in assets.rows %}
									{% if asset._id != product.cover_id %}
									<li>
										<img src="{{ asset.thumbnails.big.view_url }}" alt="{{ product.title }}" />
									</li>
									{% endif %}
								{% endfor %}
							</ul>
						</div>
						<button class="ui magenta btn prev">
							<i class="icon angle left"></i>
						</button>
						<button class="ui magenta btn next" disabled="">
							<i class="icon angle right"></i>
						</button>
					
						<div class="thumb wrap">
							<!--展示图片-->
							<div class="ui mini pages images">
								<div class="active image">
									<img src="{{ product.cover.thumbnails.tiny.view_url }}" alt="{{ product.title }}" />
								</div>
								{% for asset in assets.rows %}
									{% if asset._id != product.cover_id %}
									<div class="image">
								  		<img src="{{ asset.thumbnails.tiny.view_url }}" alt="{{ product.title }}" />
									</div>
									{% endif %}
								{% endfor %}
							</div>
						</div>
						
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="product promotion">
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<div class="ui gray message">
						<i class="flat close icon"></i>
						<div class="ui header">
							<div class="picicon">
								<i class="gift icon"></i>
							</div>
							<div class="content">
								分享赢好礼！
								<p class="sub header">
									邀请一个朋友加入并30天内购买一个太火鸟产品，你将获得15元优惠券； 
								</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="buy box">
		<div class="ui responsive grid">
			<div class="row">
				<div class="seven wide column">
					<h3 class="ui dark header">
						<div class="content">
							{{ product.title }}
							<div class="sub header">
								<a href="{{ product.designer.home_url }}" class="ui magenta link" title="设计师">
									{{ product.designer.nickname }}
								</a>
								<i class="map marker icon"></i>{{ product.designer.city }} {{ product.designer.profile.job }}
							</div>
						</div>
					</h3>
					<div class="attributes">
						<p class="item">
							<div class="ui small star rating hover">
							  	<i class="icon active"></i>
							  	<i class="icon"></i>
							  	<i class="icon"></i>
							  	<i class="icon"></i>
							  	<i class="icon"></i>
							</div>
							<small><span class="count">{{ product.comment_count }}</span>条评价 | <span class="count" id="product-love-count">{{ product.love_count }}</span>人点赞</small>
						</p>
						<div class="item">
							<div class="ui black btn-4 btn-4c icon-arrow-right pop favorite btn" data-content="收藏一下" data-variation="inverted" data-id="{{ product._id }}" data-mark="n">
								收藏
							</div>
							<div class="ui magenta btn-4 btn-4c pop love icon btn" data-content="点赞" data-variation="inverted" data-id="{{ product._id }}" data-mark="n">
								<i class="heart empty icon"></i>
							</div>
							<div class="ui magenta btn-4 btn-4c pop share icon btn" data-content="分享" data-variation="inverted">
								<i class="share icon"></i>
							</div>
							{% if product.process_presaled %}
							<a class="ui magenta btn-4 btn-4c pop icon btn" data-content="查看预售结果" data-variation="inverted" href="{{ app_url_domain }}/sale/{{ product._id }}.html">
								<i class="time icon"></i>
							</a>
							{% endif %}
						</div>
					</div>
				</div>	
				<div class="right aligned nine wide column">
					<table class="ui basic buy action table">
						<tr>
							<td>
								{% if product.snatched %}
									{% if !product.snatched_start %}
									<div class="product snatched">
										<span class="ui text">已 <span class="count">{{ product.appoint_count|default 0}}</span>人预约，</span>
										<span class="ui text">倒计时：<span id="clock"></span></span>
									</div>
									{% else %}
									<div class="product snatched">
										{% if product.can_saled %}
											<span class="ui black text">正在抢购中...</span>
										{% endif %}
									</div>
									{% endif %}
								{% endif %}
								<div class="product attrs">
									{% for m in skus %}
									<span class="ui small magenta att button" data-id="{{ m._id }}" data-price="{{ m.price }}">{{ m.mode }}</span>
									{% endfor %}
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<span class="old price">
									<span class="unit">￥</span>{{ product.market_price }}
								</span>
								<span class="price" id="current-price">
                  {% if product.snatched %}
									  <span class="unit">￥</span>{{ product.snatched_price }}
                  {%else%}
									  <span class="unit">￥</span>{{ product.sale_price }}
                  {%endif%}

								</span>
								{% if product.snatched %}
									{% if !product.snatched_start %}
									<div class="ui active magenta btn-4 btn-4c icon-arrow-right tobuy appoint btn">
										<i class="ticket icon"></i>准备抢购
									</div>
									{% else %}
										{% if product.can_saled %}
										<div class="ui active magenta btn-4 btn-4c icon-arrow-right tobuy nowbuy btn">
											<i class="flat shopping57 icon"></i>立即抢购
										</div>
										{% else %}
										<div class="ui active gray btn-4 btn-4c locknotice btn">
											已抢完
										</div>
										{% endif %}
									{% endif %}
									
								{% else %}
								
                  {% if !product.is_try %}
                    {% if product.can_saled %}
                    <div class="ui active magenta btn-4 btn-4c icon-arrow-right tobuy buy btn">
                      <i class="flat shopping57 icon"></i>加入购物车
                    </div>
                    {% else %}
                    <div class="ui active gray btn-4 btn-4c locknotice btn" data-id="{{ product._id }}">
                      暂时缺货
                    </div>
                    {% endif %}
									{% endif %}				
								{% endif %}
							</td>
						</td>
						<tr>
							<td>
								{% if !product.snatched %}
                  {% if !product.is_try %}
                    {% if product.can_saled %}
                    <div class="ui black btn-4 btn-4c icon-arrow-right tobuy nowbuy btn">
                      立即购买
                    </div>
                    {% endif %}
                  {%else%}
                    <div class="">
                      此产品为试用商品，不可销售
                    </div>
                  {% endif %}
								{% endif %}
							</td>
						</tr>
					</table>
				</div>
			</div>
		</div>
	</div>

	<div class="ui tabox">
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<div class="ui four tabs">
					  	<a class="active tab" href="#overview">产品详情</a>
					  	<a class="tab" href="#inventor">设计者</a>
						<a class="tab" href="#reviews">用户评价{% if product.comment_count %}<small>（{{ product.comment_count }}）</small>{% endif %}</a>
						<a class="tab" href="#service">售后服务</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="product overview">
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<div class="product content froala-element">
						{{ product.content }}
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="product inventor">
		<div class="ui responsive grid">
			<div class="row">
				<div class="nine wide column">
					<div class="inventor info">
						<h3 class="ui header">
							设计者
						</h3>
						<h4 class="ui header">
							<div class="content">
								{{ product.designer.nickname }}
								<div class="sub header">
									{{ product.designer.city }} {{ product.designer.profile.job }}
								</div>
							</div>
						</h4>
						<div class="summary">
							{{ product.designer.summary }}
						</div>
					</div>
				</div>
				<div class="one wide column"></div>
				<div class="six wide center aligned column">
					<div class="inventor avatar">
						<a href="{{ product.user.home_url }}" class="ui huge avatar image" >
							<img src="{{ product.user.big_avatar_url }}" alt="{{ product.user.nickname }}" />
						</a>
						<div class="actions">
							<button class="ui small white button">
								关注 
							</button>
							<button class="ui small white button">
								私信 
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="product reviews">
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<h3 class="ui dividing header">
						用户评价 {% if product.comment_count %}<small>（{{ product.comment_count }}）</small>{% endif %}
					</h3>
          		  	<!--ajax comment-->
					<div class="ui big reply segment" id="comment-list"></div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="product service">
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<h3 class="ui dividing header">
						售后服务及常见问题
					</h3>
				</div>
			</div>
			<div class="two column row">
				<div class="column">
					<div class="ui segment">
						<h4 class="ui header">售后服务</h4>
						<div class="ui selection list">
							<div class="item">
								客服热线：010- 8459 9327 / 8459 9323
							</div>
							<div class="item">
								QQ客服：211470932
							</div>
							<div class="item">
								客服邮箱：service#taihuoniao.com(#换成@)
							</div>
						</div>
					</div>
				</div>
				<div class="column">
					<div class="ui segment">
						<h4 class="ui header">常见问题</h4>
						<div class="ui selection list">
							<div class="item">
								<h4 class="ui gray header">收藏商品功能</h4>
								<p>点击“收藏按钮”后，按钮中的填实黑色,代表收藏成功，再次点击取消收藏。您可在“个人中心”中的我的收藏查看所有收藏商品。</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!--你可能喜欢的产品-->
	<div id="product_guess_list"><!--ajax fetch--></div>

</div>

<div class="section breadcrumb">
	<div class="ui responsive grid">
		<div class="row">
			<div class="column">
				<div class="ui medium breadcrumb">
				  	<a class="ui section link" href="{{ app_url_domain }}">
						<i class="home icon"></i> 首页
					</a>
				  	<i class="angle right icon divider"></i>
				  	<a class="ui section link" href="{{ app_url_shop }}">商店</a>
				  	<i class="angle right icon divider"></i>
				  	<a class="ui section link" href="{{ app_url_domain }}/shop/c{{ product.category._id }}">{{ product.category.title }}</a>
				  	<i class="angle right icon divider"></i>
				  	<div class="active section">{{ product.title }}</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% include "block/sharebox.html" %}
{% include "block/qrcode.html" %}
{% endblock %}
