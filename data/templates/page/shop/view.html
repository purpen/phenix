{%extends 'layout/column.html'%}
{% block title %}{% endblock %}
{% block page_css %}
<link rel="stylesheet" href="http://frstatic.qiniudn.com/wechat/js/swiper.min.css">
<style type="text/css">
	.ui.view-top{
		background: url({{ app_url_packaged }}/images/topicbg/crowdfunding-product.jpg) no-repeat scroll center center / cover #0daa7f;
		color:#fff;	
	}
	.ui.view-top .container{
		margin:80px 0 40px;
		color: #fff;
	}
	.ui.view-top .container h1 {
	  color: #fff;
	  font-size: 2rem;
	  margin: .5rem 0 .8rem;
	}
	.ui.view-top .container .ui.rating.hover .active.icon {
	  opacity: 1;
	}
	.ui.view-top .container .ui.rating .active.icon {
	  color: #f36 !important;
	}
	.ui.view-top .container .ui.rating .icon {
	  color: #fff !important;
		opacity: 0.8;
	}
	.ui.view-top .container .count{
		color: #f36;
		font-size: 22px;
	}
	.ui.view-top .container small+p{
		margin-bottom:8px;
	}
	.ui.view-top .container p+p{
		margin-top:8px;
	}
	#shoppage .product.cover .thumb.wrap{
		text-align:center;
		white-space: nowrap;
		overflow: hidden;
		padding: 20px 0;
		margin-top:0;
		background: rgba(0,0,0,0.1);
	}
	#shoppage .product.cover .thumb.wrap .image{
		cursor:pointer;
	}
	#shoppage{
		background:#f1f1f1;
	}
	#shoppage .slidebox .frame {
	  height: 450px;
	  line-height: 450px;
	}
	#shoppage .slidebox .ui.btn{
		top:195px;
	}
	#shoppage .slidebox .frame ul li{
		width:800px;
	}
	#shoppage .slidebox .frame ul li img {
		width:100%;
	}
	@media only screen and (min-width: 1750px){
		#shoppage .slidebox .frame ul li{
			width:955px;
		}
	}
	.product.content.froala-element{
		margin:0 -1em;
	}
	.product.content.froala-element p{
		margin:0;
	}
	#shoppage .bar{
		background: #f1f1f1;
	  height: 15px;
	  margin: 0 -1em;
	}
	#shoppage .ui.segment{
		-webkit-box-shadow: 0 0 0 0px rgba(0,0,0,.1); 
		box-shadow: 0 0 0 0px rgba(0,0,0,.1); 
		border-radius: 0;
	}
	#shoppage .product.overview .ui.zanl{
		padding:20px 0;
	}
	#shoppage .product.overview .ui.zanl .ui.button{
		width: 120px;
	}
	#shoppage .product.evaluating,#shoppage .product.reviews{
		padding:1em 0;
	}
	#shoppage .product.evaluating > .ui.center.aligned{
		margin: 3em 0 1em;
	}
	.post.comment{
		margin-left:0;
	}
	#shoppage .buy.box{
		background:#fff;
	}
	#shoppage .buy.box .price{
		display:block;
	}
	.rbtn.buy .ui.button{
		margin: 10px 0;
		padding: 0.8em 1em;
		font-size: 14px;
		float:left;
	}
</style>
{% endblock %}
<script type="text/javascript">
    var per_page = 10;
	function fetch_comment(current_page, per_page){
        var total_count = {{ product.comment_count }};
        var total_page = Math.ceil(total_count/per_page);
        var url = '{{ app_url_base }}/app/site/shop/ajax_fetch_comment';
        $.get(url, {target_id: {{ product._id }}, page: current_page, per_page: per_page, total_page: total_page});
    }
</script>
{% block layout_js %}
	
{% endblock %}
{% block jquery %}
	var $frame = $('#procover');
	var $wrap = $frame.parent();
	$frame.sly({
		horizontal: 1,
		itemNav: 'forceCentered',
		smart: 1,
		activateMiddle: 1,
		mouseDragging: 1,
		touchDragging: 1,
		releaseSwing: 1,
		startAt: 0,
		pagesBar: $wrap.find('.pages'),
		pageItem: 'custom',
		activatePageOn: 'click',
		speed: 300,
		elasticBounds: 1,
		easing: 'easeOutExpo',
		dragHandle: 1,
		dynamicHandle: 1,
		clickBar: 1,
		// Buttons
		prev: $wrap.find('.prev'),
		next: $wrap.find('.next')
	});
	phenix.bind_share_list();
	// 生成二维码
	$('#qrcode').qrcode({width: 256, height: 256, text: '{{ product.wap_view_url }}'});
	
	// 如果仅一个sku,则设置默认值
	{% if skus_count %}
		var choosed_sku = 0;
	{% else %}
		var choosed_sku = {{ product._id }};
	{% endif %}
	

	// 选择sku
	$('.attrs .ui.att.button').click(function(){
		choosed_sku = $(this).data('id');
		$('.attrs .ui.att.active.button').removeClass('active');
		$(this).addClass('active');
    //抢购商品sku价格均为抢购价
    {% if !product.snatched %}
		  $('#current-price').html('<span class="unit">￥</span>'+$(this).data('price'));
		{%endif%}		
		return false;
	});

	
	// 现在预约
  	$('.appoint.button').click(function(){
    	//phenix.redirect('{{ app_url_base }}/promo/dreamk', 0);
  	});
	
	// 加入购物车
	$('.ui.buy.button').click(function(){
		if (choosed_sku){
			$.post('{{ app_url_cart_buy }}', {sku: choosed_sku});
		} else {
			phenix.show_error_note('请选择一个型号或颜色', 3000);
		}
	});
	
	// 立即购买
  $('.ui.nowbuy.button').livequery(function(){
     $(this).click(function(){
      // 所有ajax请求，验证是否登录
      if (!phenix.visitor.is_login){
        phenix.show_login_box();
        return false;
      }
      if (choosed_sku){
        phenix.redirect('{{ app_url_cart_nowbuy }}?sku='+choosed_sku, 0);
      } else {
        phenix.show_error_note('请选择一个型号或颜色', 3000);
      }
    }); 
  });
	
	/* 登录用户行为 */
	{% if visitor.is_login %}
		// 初始化互动，是否收藏、点赞
		$.get('{{ app_url_favorite }}/ajax_done', {id: {{product._id}},type:1,event:1}, function(result){
			if (result.success) {
				// 验证收藏
				if (result.data.favorited) {
					$('.ui.favorite.button')
						.data('content', '取消')
						.data('mark', 'y')
						.addClass('active');
				}
			}
		}, 'json');
		
		// 验证点赞
		$.get('{{ app_url_favorite }}/ajax_done', {id: {{product._id}},type:1,event:2}, function(result){
			if (result.success) {
				if (result.data.loved) {
					$('.ui.love.button')
						.data('content', '取消')
						.data('mark', 'y')
						.addClass('active');
				}
			}
		}, 'json');
	{% endif %}
	
	// 收藏
	$('.ui.favorite.button').bind('click', function(){
		var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.show_login_box();
			return false;
		}
		if (mark == 'n') {
			$.post('{{ app_url_favorite }}/ajax_favorite', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('content', '取消')
						.data('mark', 'y')
						.addClass('active');
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		} else {
			$.post('{{ app_url_favorite }}/ajax_cancel_favorite', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('content', '收藏')
						.data('mark', 'n')
						.removeClass('active');
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		}
	});
	
	// 喜欢
	$('.ui.love.button').bind('click', function(){
		var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.show_login_box();
			return false;
		}
		var count = parseInt($('#product-love-count').text());
		if (mark == 'n') {
			$.post('{{ app_url_favorite }}/ajax_laud', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('content', '取消')
						.data('mark', 'y')
						.addClass('active');
					count += 1;
					$('#product-love-count').text(count);
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		} else {
			$.post('{{ app_url_favorite }}/ajax_cancel_laud', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('content', '点赞')
						.data('mark', 'n')
						.removeClass('active');
					count -= 1;	
					$('#product-love-count').text(count);
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		}
	});
	
	// 分享
	$('.ui.share.button').bind('click', function(){
		$('.ui.share.modal').modal('show');
	});

	{% if is_snatch %}
    var times = {{ snatch_time }} ;
    var SysSecond;
    var InterValObj;
    //倒计时
    //SysSecond = parseInt($("#remainSeconds").html()); //这里获取倒计时的起始时间
    SysSecond = parseInt(times);
    InterValObj = window.setInterval(SetRemainTime, 1000); //间隔函数，1秒执行

    //将时间减去1秒，计算天、时、分、秒
    function SetRemainTime() {
    if (SysSecond > 0) {
      SysSecond = SysSecond - 1;
      var second = Math.floor(SysSecond % 60);             // 计算秒
      var minite = Math.floor((SysSecond / 60) % 60);      //计算分
      var hour = Math.floor((SysSecond / 3600) % 24);      //计算小时
      var day = Math.floor((SysSecond / 3600) / 24);        //计算天

      var time_show = ''
        + '<span class="count">'+ day +'</span> 天 '
        + '<span class="count">'+ hour +'</span> 时 '
        + '<span class="count">'+ minite +'</span> 分 '
        + '<span class="count">'+ second +'</span> 秒';
      $("#clock").html(time_show);
    } else {
      //剩余时间小于或等于0的时候，就停止间隔函数
      window.clearInterval(InterValObj);
      //这里可以添加倒计时时间为0后需要执行的事件
          var product_id = {{ product._id }};
          $.get('{{ app_url_shop }}/check_snatch_expire', { product_id: product_id, type:1 }, function(r){
            var r = $.parseJSON(r);
            if(r.success){
              $('.tobuy').html('立即抢购').addClass('nowbuy');
              $('.snatched').html('<span class="ui black text">正在抢购中...</span>');
            }else{
              //alert(r.message);
              window.location.reload();
            }
          });
      }
    }

	{% endif %}
	
  	// ajax加载评论
  	fetch_comment(1, per_page);
	
	// 加载推荐商品 
	$.get('{{ app_url_shop }}/ajax_guess_product', {sword: '{{ product.tags_s }}', size: 4, id: {{ product._id }} });
	
	// 显示私信框
	$('.ui.letter.button').bind('click', function(){
		$('.ui.letter.modal').modal('show');
	});
	// 隐藏私信框
	$('.ui.cancel.button').bind('click', function(){
		$('.ui.letter.modal').modal('hide');
	});
	
	$('#message-form').form({
		content: {
			identifier  : 'content',
			rules: [
				{
					type   : 'empty',
					prompt : '私信内容不能为空'
				},
				{
					type   : 'maxLength[140]',
					prompt : '私信内容不超过140字符'
				}
			]
		}
	}, {
		inline : true,
		onSuccess: function(event){
			event.preventDefault();
			$(event.target).ajaxSubmit();
		}
	});
{% endblock %}
{% block content %}
<!--<div class="ui responsive grid" style="height:600px;">
	<div class="row">
		<div class="ten wide column">
			<div class="swiper-container gallery-top">
				<div class="swiper-wrapper">
					<div class="swiper-slide" style="margin-right: 10px; background-image: url(http://www.swiper.com.cn/demo/img/nature1.jpg);">
					</div>
					<div class="swiper-slide" style="margin-right: 10px; background-image: url(http://www.swiper.com.cn/demo/img/nature2.jpg);">
				
					</div>
					<div class="swiper-slide" style="margin-right: 10px; background-image: url(http://www.swiper.com.cn/demo/img/nature3.jpg);">
				
					</div>
					<div class="swiper-slide" style="margin-right: 10px; background-image: url(http://www.swiper.com.cn/demo/img/nature4.jpg);">
				
					</div>
					<div class="swiper-slide" style="margin-right: 10px; background-image: url(http://www.swiper.com.cn/demo/img/nature5.jpg);">
				
					</div>
					
				
				</div>
				
				<div class="swiper-button-next swiper-button-white"></div>
				<div class="swiper-button-prev swiper-button-white"></div>
				
			</div>
			
			<div class="swiper-container gallery-thumbs">
				<div class="swiper-wrapper">
					<div class="swiper-slide" style="margin-right: 10px; background-image: url(http://www.swiper.com.cn/demo/img/nature1.jpg);"></div>
					<div class="swiper-slide" style="margin-right: 10px; background-image: url(http://www.swiper.com.cn/demo/img/nature2.jpg);"></div>
					<div class="swiper-slide" style="margin-right: 10px; background-image: url(http://www.swiper.com.cn/demo/img/nature3.jpg);"></div>
					<div class="swiper-slide" style="margin-right: 10px; background-image: url(http://www.swiper.com.cn/demo/img/nature4.jpg);"></div>
					<div class="swiper-slide" style="margin-right: 10px; background-image: url(http://www.swiper.com.cn/demo/img/nature5.jpg);"></div>
				
				
				</div>
			</div>
			
		</div>
		<div class="six wide column ui segment">

		</div>
	</div>
</div>-->

<div class="shop submenu">
	<div class="ui responsive grid">
		<div class="row">
			<div class="column">
				{% category_list var:'category' only_open:1 domain:domain current:product.category._id show_all:0 %}
				<div class="ui horizontal list">
					<div class="item">
						<a class="ui link" href="{{ app_url_shop }}/c0">全部</a>
					</div>
					{% for cat in category.rows %}
				  	<div class="item">
						<a class="ui {{ cat.active }} link" href="{{ cat.view_url }}">{{ cat.title }}</a>
					</div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
</div>

<div class="shop page">
	<div class="ui view-top">
		<div class="masthead">
			<div class="masthead-cover">
				<div class="ui responsive grid">
					<div class="row">
						<div class="column">
							<div class="container">
								<p><small>智能手表</small></p>
								<h1 class="block title">Elkfit Cycler C01智能骑行码表</h1>
								<div class="ui small star rating hover">
								  <i class="icon active"></i>
							  	<i class="icon active"></i>
							  	<i class="icon"></i>
							  	<i class="icon"></i>
							  	<i class="icon"></i>
								</div>
								<small><span class="count">7.3</span> ( <span  id="product-love-count">3</span>条评价 )</small>
								<p>@小李子  发表于 5小时, 32分钟 前</p>
								<p> 20人赞   10收藏    18条回应</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="ui shop view" id="shoppage">
		<div class="product cover">
			<div class="ui responsive grid">
				<div class="row">
					<div class="column">
						<div class="ui very compact grid">
							<div class="ui eleven wide column">
								<div class="ui active segment">
									<div class="slidebox" style="margin:-1em -1em 0;">
							
									{% asset_list var:'assets' parent_id:product._id size:10 asset_type:10 %}
										<div id="procover" class="frame">
											<ul class="clearfix">
											  <li class="active" style="background:url({{ product.cover.thumbnails.big.view_url }}) center center no-repeat;background-size:cover;">
									
											  </li>	
								
												{% for asset in assets.rows %}
													{% if asset._id != product.cover_id %}
														<li style="background:url({{ asset.thumbnails.big.view_url }}) center center no-repeat;background-size:cover;">	
													  </li>
													{% endif %}
												{% endfor %}
									
											</ul>
							
										</div>
										<button class="ui magenta btn prev disabled" disabled="">
											<i class="icon angle left"></i>
										</button>
										<button class="ui magenta btn next">
											<i class="icon angle right"></i>
										</button>
							
										<div class="thumb wrap">
											<!--展示图片-->
											<div class="ui mini pages images">
												<div class="image active">
													<img src="{{ product.cover.thumbnails.tiny.view_url }}" alt="{{ product.title }}">
												</div>
												{% for asset in assets.rows %}
													{% if asset._id != product.cover_id %}
													<div class="image">
												  		<img src="{{ asset.thumbnails.tiny.view_url }}" alt="{{ product.title }}" />
													</div>
													{% endif %}
												{% endfor %}
									
											</div>
										</div>
									</div>
								
									<div class="ui tabox">
										<div class="ui three tabs">
											<a href="#.overview" class="tab">产品详情</a>
											<a href="#.evaluating" class="tab">产品评测</a>
											<a href="#.reviews" class="tab">用户评价</a>
										</div>
									</div>
									<div class="product overview">
										<div class="product content froala-element">
											{{ product.content }}
										</div>
										<div class="ui center aligned zanl">
											<div class="ui green pop favorite inverted button" data-content="收藏一下" data-variation="inverted" data-id="{{ product._id }}" data-mark="n">
												收藏
											</div>
											<div class="ui magenta pop love icon inverted button" data-content="点赞" data-variation="inverted" data-id="{{ product._id }}" data-mark="n">
												<i class="heart empty icon"></i>
												赞
											</div>
											<div class="ui blue pop share icon inverted button" data-content="分享" data-variation="inverted">
												<i class="share icon"></i>
												分享
											</div>
										</div>
									</div>
									
									<div class="bar"></div>
								
									<div class="product evaluating">
										<h3 class="ui dividing header">
											产品评测 <small>（{{ product.topic_count }}）</small>
										</h3>
										
										<div class="ui center aligned">
										{% if product.topic_count == 0 %}
											<p>还没有人为 {{ product.title }} 时尚复古便携耳机 撰写评测，你想做第一个为它写评测的人么？</p>
											<a href="{{ product.subject_view_url }}&evaluating=1#newtopic" class="ui magenta inverted button" style="margin-top:2em;">
												<i class="edit icon"></i> 发表评测
											</a>
										{% else %}
											<a href="{{ product.subject_view_url }}&evaluating=1" class="ui black inverted button">
												<i class="search icon"></i> 查看更多
											</a>
											<a href="{{ product.subject_view_url }}&evaluating=1#newtopic" class="ui magenta inverted button">
												<i class="edit icon"></i> 发表评测
											</a>
											{% include "block/product_topic.html" %}
										{% endif %}
											
										</div>
									</div>
									
									{% if product.comment_count != 0 %}
									<div class="bar"></div>
									<div class="product reviews">
										<h3 class="ui dividing header">
											用户评价 {% if product.comment_count %}<small>（{{ product.comment_count }}）</small>{% endif %}
										</h3>
										
										<!--ajax comment-->
										<div class="ui big reply segment" id="comment-list"></div>
									</div>
									{% endif %}
									
								</div>
							</div>
							<div class="ui five wide column">
								<div class="ui segment">
									<div class="buy box">
										<span class="old price">
											<span class="unit">￥</span>{{ product.market_price }}12
										</span>
										<span class="price" id="current-price">
		                                    {% if product.snatched %}
											    <span class="unit">￥</span>{{ product.snatched_price }}23
		                                    {%else%}
											    <span class="unit">￥</span>{{ product.sale_price }}23
		                                    {%endif%}
										</span>
									</div>
									<div class="rbtn buy">
									{% if product.snatched %}
										{% if !product.snatched_start %}
										<div class="product snatched">
	                                        <!--<span class="ui text">已 <span class="count">{{ product.appoint_count|default 0}}</span>人预约，</span>-->
											<span class="ui text">倒计时：<span id="clock"></span></span>
										</div>
										{% else %}
										<div class="product snatched">
											{% if product.can_saled %}
												<span class="ui black text">正在抢购中...</span>
											{% endif %}
										</div>
										{% endif %}
									{% endif %}
	                                {% if skus %}
									<div class="product attrs">
										{% for m in skus %}
										<span class="ui small magenta att button" data-id="{{ m._id }}" data-price="{{ m.price }}">{{ m.mode }}</span>
										{% endfor %}
									</div>
	                                {% endif %}
	
																	{% if product.snatched %}

																		{% if !product.snatched_start %}
																		<div class="ui active magenta tobuy appoint button">
																			准备开抢
																		</div>
																		{% else %}
																			{% if product.can_saled %}
																			<div class="ui active magenta tobuy nowbuy inverted button">
																				立即抢购
																			</div>
																			{% else %}
																			<div class="ui active gray locknotice inverted button">
																				已抢完
																			</div>
																			{% endif %}
																		{% endif %}

																	{% else %}

									                                    <!--积分兑换商品不能加入购物车 -->
									                                    {% if item_stage == 'exchange' %}
									    									<div class="product snatched">
									    										<span class="ui gray text">商品积分兑换</span>
									    									</div>
									                                    {%endif%}

									                                    {% if item_stage=='shop' %}
									                                        {% if !product.is_try %}
									                                            {% if product.can_saled %}
									                                            <div class="ui active magenta tobuy buy inverted button">
									                                                <i class="cart icon"></i> 加入购物车
									                                            </div>
									                                            {% else %}
									                                            <div class="ui active gray locknotice inverted button" data-id="{{ product._id }}">
									                                                暂时缺货
									                                            </div>
									                                            {% endif %}
									                                        {% endif %}				
									                                    {% endif %}

									                                {%endif%}
									

												                            <!--商品 -->
												                            {% if item_stage == 'shop' %}
												                                {% if !product.snatched %}
												                                    {% if !product.is_try %}
												                                        {% if product.can_saled %}
												                                        <div class="ui black tobuy nowbuy inverted button"
											>
												                                            立即购买
												                                        </div>
												                                        {% endif %}
												                                    {%else%}
												                                    <div class="ui magenta text">
												                                        此产品为试用商品，不可销售
												                                    </div>
												                                    {% endif %}
												                                {% endif %}
												                            {%endif%}
																							</div>
										
										
										
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
</div>

{% include "block/sharebox.html" %}
{% include "block/qrcode.html" %}
{% endblock %}
