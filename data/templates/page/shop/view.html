{%extends 'layout/column.html'%}
{% block title %}{% endblock %}
{% block layout_css %}
	{% if css_use_bundle %}
        <link rel="stylesheet" href="{{ app_url_packaged }}/css/froala_editor.min.{{ css_bundle_version }}.css" type="text/css" />
	{% else %}
        <link rel="stylesheet" href="{{ app_url_packaged }}/css/froala_editor.min.css" type="text/css" />
	{% endif %}
{% endblock %}
{% block page_css %}
<style type="text/css">
    
</style>
{% endblock %}
{% block layout_js %}
<script type="text/javascript">

    // 评论参数
    var page = {{ page|default 1 }}, per_page = 10;
    var url = '{{ app_url_comment }}/ajax_fetch_comment?rand='+Math.random();
    var target_id = "{{ product._id }}";
    // 评论类型
    var type = 4;
    // 网页或手机
    var from_site = 'site';
    // 备用
    var evt = 1;

    // 是否是加载评分
    {% if product.stage == 15 %}
      var is_star = 0;
      var sort = 0;
    {%else%}
      var is_star = 1;
      var sort = 1;
    {%endif%}

    var comment_param = {
      target_id: target_id,
      page: page,
      per_page: per_page,
      sort: sort,
      url: url,
      type: type,
      from_site: from_site,
      evt: evt,
      is_star: is_star
    }

</script>
{% endblock %}

{% block jquery %}
	$('#carousel').flexslider({
        animation: "slide",
        controlNav: false,
        animationLoop: false,
        slideshow: false,
        itemWidth: 160,
        itemMargin: 15,
        asNavFor: '#slider'
    });
 
    $('#slider').flexslider({
        animation: "slide",
        controlNav: false,
        animationLoop: false,
        slideshow: false,
        sync: "#carousel"
    });
    
	// 分享
	$('.ui.share.button').bind('click', function(){
		$('.ui.share.modal').modal('show');
	});
	phenix.bind_share_list("{{ product.cover.thumbnails.hm.view_url }}");
	// 生成二维码
	$('#qrcode').qrcode({width: 256, height: 256, text: '{{ product.wap_view_url }}'});
	
	// 如果仅一个sku,则设置默认值
	{% if skus_count %}
		var choosed_sku = 0;
	{% else %}
		var choosed_sku = {{ product._id }};
	{% endif %}
    
	// 选择sku
	$('.attrs .ui.att.button').click(function(){
		choosed_sku = $(this).data('id');
		$('.attrs .ui.att.active.button').removeClass('active');
		$(this).addClass('active');
        // 抢购商品sku价格均为抢购价
        {% if !product.snatched %}
            $('#current-price').html('销售价：<small class="unit"><i class="yen icon"></i></small>'+$(this).data('price'));
        {% else %}
            $('#current-price').html('促销价：<small class="unit"><i class="yen icon"></i></small>'+$(this).data('price'));
		{%endif%}
		return false;
	});

	
	// 现在预约
  	$('.appoint.button').click(function(){
    	//phenix.redirect('{{ app_url_base }}/promo/dreamk', 0);
  	});
	
	// 加入购物车
	$('.ui.buy.button').click(function(){
		if (choosed_sku){
			$.post('{{ app_url_cart_buy }}', {sku: choosed_sku});
		} else {
			phenix.show_error_note('请选择一个型号或颜色', 3000);
		}
	});
	
	// 立即购买
  $('.ui.nowbuy.button').livequery(function(){
     $(this).click(function(){
      // 所有ajax请求，验证是否登录
      if (!phenix.visitor.is_login){
        phenix.show_login_box();
        return false;
      }
      if (choosed_sku){
        phenix.redirect('{{ app_url_cart_nowbuy }}?sku='+choosed_sku, 0);
      } else {
        phenix.show_error_note('请选择一个型号或颜色', 3000);
      }
    }); 
  });
	
	/* 登录用户行为 */
	{% if visitor.is_login %}
		// 初始化互动，是否关注、点赞
		$.get('{{ app_url_favorite }}/ajax_done', {id: {{product._id}},type:1,event:1}, function(result){
			if (result.success) {
				// 验证关注
				if (result.data.favorited) {
					$('.ui.favorite.button')
						.data('mark', 'y')
						.addClass('active')
                        .html('<i class="minus icon"></i> 已关注');
				}
			}
		}, 'json');
		
		// 验证点赞
		$.get('{{ app_url_favorite }}/ajax_done', {id: {{product._id}},type:1,event:2}, function(result){
			if (result.success) {
				if (result.data.loved) {
					$('.ui.love.button')
						.data('mark', 'y')
						.addClass('active')
                        .html('<i class="heart icon"></i> 赞了');
				}
			}
		}, 'json');

		// 编辑
		$('.ui.edit.button').bind('click', function(){
			var id = $(this).data('id');
			phenix.redirect('{{ app_url_shop }}/idea_edit?id='+id);
		});
	
		// 删除
		$('.ui.remove.button').bind('click', function(){
			var id = $(this).data('id');
			if(confirm('确认执行删除操作吗?')){
				$.post('{{ app_url_shop }}/deleted', {id:id });
			}
		});

		// 精选标记
		$('.ui.fine.button').bind('click', function(){
			var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
			if (mark == 'n') {
				$.post('{{ app_url_shop }}/mark_as_featured', {id: id}, function(result){
					if (result.success) {
						$btn
							.data('content', '取消精华')
							.data('mark', 'y')
							.addClass('active');
					} else {
						phenix.show_error_note(result.message);
					}
				}, 'json');
			} else {
				$.post('{{ app_url_shop }}/mark_cancel_featured', {id: id}, function(result){
					if (result.success) {
						$btn
							.data('content', '标记精华')
							.data('mark', 'n')
							.removeClass('active');
					} else {
						phenix.show_error_note(result.message);
					}
				}, 'json');
			}
		});
	
		// 编辑推荐
		$('.ui.stick.button').bind('click', function(){
			var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
			if (mark == 'n') {
				$.post('{{ app_url_shop }}/ajax_stick', {id: id}, function(result){
					if (result.success) {
						$btn
							.data('content', '取消推荐')
							.data('mark', 'y')
							.addClass('active');
					} else {
						phenix.show_error_note(result.message);
					}
				}, 'json');
			} else {
				$.post('{{ app_url_shop }}/ajax_cancel_stick', {id: id}, function(result){
					if (result.success) {
						$btn
							.data('content', '编辑推荐')
							.data('mark', 'n')
							.removeClass('active');
					} else {
						phenix.show_error_note(result.message);
					}
				}, 'json');
			}
		});

	{% endif %}
	
	// 关注
	$('.ui.favorite.button').bind('click', function(){
		var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.show_login_box();
			return false;
		}
		if (mark == 'n') {
			$.post('{{ app_url_favorite }}/ajax_favorite', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('mark', 'y')
						.addClass('active')
                        .html('<i class="minus icon"></i> 已关注');
                        
                    $('#target-favorite-count').text(result.data.favorite_count);
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		} else {
			$.post('{{ app_url_favorite }}/ajax_cancel_favorite', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('mark', 'n')
						.removeClass('active')
                        .html('<i class="plus icon"></i> 关注');
                        
                    $('#target-favorite-count').text(result.data.favorite_count);
                    
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		}
	});
	
	// 点赞
	$('.ui.love.button').bind('click', function(){
		var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.show_login_box();
			return false;
		}
		if (mark == 'n') {
			$.post('{{ app_url_favorite }}/ajax_laud', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('mark', 'y')
						.addClass('active')
                        .html('<i class="heart icon"></i> 赞了');
                    
					$('#target-love-count').text(result.data.love_count);
                    
                    if(result.data.newadd){
                        $('#target_'+ id +'_support')
                            .prepend('<a href=\"/user/'+ result.data.user_id +'\" target=\"_blank\" id=\"user-'+ result.data.user_id +'\" class=\"image\" data-variation=\"wide\" data-html=\"<div class=\'header\'>'+  result.data.nickname +'</div><div class=\'content\'>'+ result.data.city +' '+ result.data.job +'</div>\"><img src=\"'+ result.data.avatar +'\" /></a>');
                    }
                    
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		} else {
			$.post('{{ app_url_favorite }}/ajax_cancel_laud', {id: id, type:1}, function(result){
				if (result.success) {
					$btn
						.data('mark', 'n')
						.removeClass('active')
                        .html('<i class="heart empty icon"></i> 赞');
                    
					$('#target-love-count').text(result.data.love_count);
                    
                    $('#user-'+ result.data.user_id).remove();
                    
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		}
	});
	
	{% if is_snatch %}
    var times = {{ snatch_time }} ;
    var SysSecond;
    var InterValObj;
    //倒计时
    //SysSecond = parseInt($("#remainSeconds").html()); //这里获取倒计时的起始时间
    SysSecond = parseInt(times);
    InterValObj = window.setInterval(SetRemainTime, 1000); //间隔函数，1秒执行

    //将时间减去1秒，计算天、时、分、秒
    function SetRemainTime() {
    if (SysSecond > 0) {
      SysSecond = SysSecond - 1;
      var second = Math.floor(SysSecond % 60);             // 计算秒
      var minite = Math.floor((SysSecond / 60) % 60);      //计算分
      var hour = Math.floor((SysSecond / 3600) % 24);      //计算小时
      var day = Math.floor((SysSecond / 3600) / 24);        //计算天

      var time_show = ''
        + '<span class="count">'+ day +'</span> 天 '
        + '<span class="count">'+ hour +'</span> 时 '
        + '<span class="count">'+ minite +'</span> 分 '
        + '<span class="count">'+ second +'</span> 秒';
      $("#clock").html(time_show);
    } else {
      //剩余时间小于或等于0的时候，就停止间隔函数
      window.clearInterval(InterValObj);
      //这里可以添加倒计时时间为0后需要执行的事件
          var product_id = {{ product._id }};
          $.get('{{ app_url_shop }}/check_snatch_expire', { product_id: product_id, type:1 }, function(r){
            var r = $.parseJSON(r);
            if(r.success){
              $('.tobuy').html('立即抢购').addClass('nowbuy');
              $('.snatched').html('<span class="ui black text">正在抢购中...</span>');
            }else{
              //alert(r.message);
              window.location.reload();
            }
          });
      }
    }

	{% endif %}
	
	phenix.hook_comment_page();
    
    {% if product.stage == 15 %}
        // ajax加载评论
        phenix.fetch_comment(comment_param);

        // 加载所在专辑
        $.get('{{ app_url_shop }}/ajax_load_albums_list?rand='+Math.random(), { size: 8, pid: {{ product._id }} }, function(rs){
              if(rs.success){
                  if(rs.data.has_one){
                      $('#shop-albums-list').show();
                      var rendered = phenix.ajax_render_result('#get_shop_albums_tpl', rs.data);
                      $('.shop-albums').html(rendered);                          
                  }

              }else{
                  phenix.show_error_note(rs.message);
              }

          }, 'json');

    {%else%}
        // ajax加载评论
        phenix.fetch_comment(comment_param);
    {%endif%}
	
	// 加载推荐商品 
	$.get('{{ app_url_shop }}/ajax_guess_product?rand='+Math.random(), {sword: '{{ product.tags_s }}', size: 8, id: {{ product._id }} }, function(rs){
        var rendered = phenix.ajax_render_result('#guess_products_tpl', rs.data);
        $('#product_guess_list').html(rendered);
    }, 'json');
	
	// 显示私信框
	$('.ui.letter.button').bind('click', function(){
		$('.ui.letter.modal').modal('show');
	});
	
	// 隐藏私信框
	$('.ui.cancel.button').bind('click', function(){
		$('.ui.letter.modal').modal('hide');
	});
	
	// 显示专辑框
	$('.ui.albums.button').bind('click', function(){
		$('.ui.albums.modal').modal('show');
	});
	
	// 隐藏专辑框
	$('.ui.Cancel.button').bind('click', function(){
		$('.ui.albums.modal').modal('hide');
	});
	
	// 选择专辑分类
	$('.ui.options').on('click', '.option', function(){
		var id = $(this).attr('data-value');
		var pid = {{ product._id }};
		var url = "{{ app_url_album_shop }}/add?pid="+pid+"&dadid="+id;
		var albums_url = "{{ albums_url }}"+id;
		if ($(this).hasClass('active')){
			$(this)
				.removeClass('active');
			$('.ui.OK.button').attr('href',url);
		}else{
			$(this)
				.siblings('.ui.option').removeClass('active')
				.end()
				.addClass('active');
			$('.ui.OK.button').attr('href',url);
		}
		$('#albums').attr('href',albums_url);
		$('#albums').attr('style','display:block');
	});
	
	$('#message-form').form({
		content: {
			identifier  : 'content',
			rules: [
				{
					type   : 'empty',
					prompt : '私信内容不能为空'
				},
				{
					type   : 'maxLength[140]',
					prompt : '私信内容不超过140字符'
				}
			]
		}
	}, {
		inline : true,
		onSuccess: function(event){
			event.preventDefault();
			$(this).ajaxSubmit({
				dataType: 'json',
				beforeSubmit: function(){
					phenix.before_submit();
				},
				success: function(data){
					phenix.after_submit();
					
					if(data.is_error){
						$(event.target).addClass('error');
						phenix.show_error_note(data.message, event.target);
					}else{
            $('.ui.letter.modal').modal('hide');
            phenix.show_ok_note('私信发送成功!');
            $(':input[name=content]').val('');
            $(":input[name='users[]']").attr('checked', false);
					}
				}
			});
		}
	});
    
    $('.user.avatars .ui.images .image').livequery(function(){
        $(this).popup({
            hoverable: true,
            position : 'top center',
        });
    });
    
    $('.ui.sticky')
      .sticky({
          context: '.mainleft',
      });
      
{% endblock %}

{% block content %}
<div class="shop viewtop" style="background-image: url('{{ product.cover.thumbnails.big.view_url }}');">
	<div class="masthead">
		<div class="masthead-cover">
        	<div class="ui responsive grid">
        		<div class="row">
        			<div class="column">
        				<div class="container">
        					<p>
                                {{ product.category.title }}
                            </p>
        					<h1 class="block title">{{ product.title }}</h1>
                            {% if product.stage == 9 %}
                            <div class="product stars">
                                {% include "block/show_stars.html" %}
            					<small>
                                    <span class="count">{{ product.stars_value }}</span>  ( <span>{{ product.comment_count }}</span> 条评价 ) 
                                </small>
                            </div>
                            {% endif %}
                            {% if product.stage != 9 %}
        					<p>
                                <span class="clove">
                                    <span id="product-comment-count">{{ product.comment_count }}</span> 个评论
                                </span>
                            </p>
                            {% endif %}
                            
            				{% if product.tags %}
            				<div class="idea tags">
            					{% for tag in product.tags %}
            					{% if tag %}
            					<a href="{{ app_url_search }}?q={{ tag }}&evt=tag" class="ui small label">
            						{{ tag }}
            					</a>
            					{% endif %}
            					{% endfor %}
            				</div>
            				{% endif %}
        				</div>
        			</div>
        		</div>
        	</div>
        </div>
    </div>
</div>

<div class="mainwrap" id="shoppage">
    <div class="mainleftwrap">
        <div class="mainleft">
            <div class="slidebox">
                {% asset_list var:'assets' parent_id:product._id size:10 asset_type:10 %}
                <div id="slider" class="flexslider flex-single">
                    <ul class="slides">
                        <li style="background-image: url('{{ product.cover.thumbnails.huge.view_url }}');">
                            <a href="{{ product.cover.thumbnails.huge.view_url }}" title="{{ product.title }}" alt="{{ product.title }}">
                                <img src="{{ product.cover.thumbnails.huge.view_url }}" alt="{{ product.title }}" style="display: none;" />
                            </a>
                        </li>
		                {% for asset in assets.rows %}
                            {% if asset._id != product.cover_id %}
                                <li style="background-image: url('{{ asset.thumbnails.huge.view_url }}');">
                                    <a href="{{ asset.thumbnails.huge.view_url }}" title="{{ product.title }}" alt="{{ product.title }}">
                                        <img src="{{ asset.thumbnails.huge.view_url }}" alt="{{ product.title }}" style="display: none;" />
                                    </a>
                                </li>
							{% endif %}
						{% endfor %}
                        {% for v in product.video %}
                        <li>
                            <iframe height="530px" width="100%" src="{{ v }}" frameborder=0 allowfullscreen></iframe>
                        </li>
                        {% endfor %}
                      </ul>
                </div>
                
                <div id="carousel" class="flexslider flex-single-carousel">
                    <ul class="slides">
                        <li style="background-image: url('{{ product.cover.thumbnails.small.view_url }}');">
                            <a href="{{ product.cover.thumbnails.small.view_url }}" title="{{ product.title }}" alt="{{ product.title }}">
                                <img src="{{ product.cover.thumbnails.small.view_url }}" alt="{{ product.title }}" class="thumb" />
                            </a>
                        </li>
						{% for asset in assets.rows %}
                            {% if asset._id != product.cover_id %}
                            <li style="background-image: url('{{ asset.thumbnails.small.view_url }}');">
                                <a href="{{ asset.thumbnails.small.view_url }}" title="{{ product.title }}" alt="{{ product.title }}">
                                    <img src="{{ asset.thumbnails.small.view_url }}" alt="{{ product.title }}" class="thumb" />
                                </a>
                            </li>
							{% endif %}
						{% endfor %}
                        {% for v in product.video %}
                        <li class="viem thumbviem" style="width: 160px; float: left; display: block;"></li>
                        {% endfor %}
                    </ul>
                </div>
			</div>
            
            <div class="container">
				<div class="ui tabox">
					<div class="ui three tabs">
						<a href="#.overview" class="tab">产品详情</a>
						<a href="#.evaluating" class="tab">产品评测</a>
                        <a href="#comment_top" class="tab">{% if product.stage==15 %}用户评论{%else%}用户评价{%endif%}</a>
					</div>
				</div>
                
				<div class="product overview">
					<div class="product content froala-element">
						{{ product.content }}
					</div>
                </div> 
            </div>
            
            <div class="container">
				<div class="product evaluating">
					<div class="block title">
						产品评测 <small>（{{ product.topic_count }}）</small>
                    </div>
				    
					{% if product.topic_count == 0 %}
					<div class="ui center aligned resultbox">
						<p>还没有人为 <a href="{{ product.view_url }}" class="ui link">{{ product.title }}</a> 撰写评测，你想做第一个为它写评测的人么？</p>
						<a href="{{ product.subject_view_url }}&evaluating=1#newtopic" class="ui magenta inverted button" style="margin-top:1em;">
							<i class="edit icon"></i> 发表评测
						</a>
					</div>
					{% else %}
                        <div class="ui topics segment">
						    {% include "block/product_topic.html" %}
                        </div>
						<div class="ui center aligned">
							<a href="{{ product.subject_view_url }}&evaluating=1" class="ui grey inverted button">
								<i class="search icon"></i> 查看更多
							</a>
							<a href="{{ product.subject_view_url }}&evaluating=1#newtopic" class="ui magenta inverted button">
								<i class="edit icon"></i> 发表评测
							</a>
						</div>
					{% endif %}
				</div>
            </div>
            
            {% if product.stage == 15 %}
            <div class="container">    
                <div class="reviews">
                    <a name="comment_top"></a>
        			<div class="reply box">
          			    <!--ajax comment-->
        	  	        <div class="block title">
                            全部评论
                            <small>（{{ product.comment_count|default 0 }}）</small>
                        </div>
          		  	    <div id="comment-list">
                            <div class="ui threaded comments is-comment"></div>
                            <div class="ui pagination pagerbox"></div>
          		  	    </div>
          		  	    {% include "block/comment_box_site.html" %}
                    </div>
                </div>
            </div>
            {%else%}
                {% if product.comment_count != 0 %}
                <div class="container">
                    <a name="comment_top"></a>
                    <div class="product reviews">
                        <div class="block title">
                            用户评价 {% if product.comment_count %}<small>（{{ product.comment_count }}）</small>{% endif %}
                        </div>
                        <!--ajax comment-->
                        <div class="ui big reply segment" id="comment-list">
                            <div class="ui threaded comments is-comment"></div>
                            <div class="ui pagination pagerbox"></div>
                        </div>
                    </div>
                </div>
                {% endif %}
            {%endif%}
        </div>
    </div>
    <div class="mainright">
        <div class="ui sticky">
            {% if show_pay_btn %}
            <div class="sellwrap">
    			<div class="buy box">
    				<p>
    					市场价：<span class="old price"><small class="unit"><i class="yen icon"></i></small>{{ product.market_price }}</span>
                    </p>
    				<p>
                        <span class="price" id="current-price">
                        {% if product.snatched %}
    					    促销价：<small class="unit"><i class="yen icon"></i></small>{{ product.snatched_price }}
                        {%else%}
    					    销售价：<small class="unit"><i class="yen icon"></i></small>{{ product.sale_price }}
                        {%endif%}
                        </span>
    				</p>
    			</div>
            
    			<div class="rbtn buy">
                    <!--样式选项-->
                    {% if skus %}
                        <div class="product attrs">
                            {% for m in skus %}
                                <span class="ui inverted magenta att button" data-id="{{ m._id }}" data-price="{{ m.price }}">{{ m.mode }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                
                    <!--限时抢购-->
      				{% if product.snatched %}
                        {% if !product.snatched_start %}
                            <div class="product snatched">
                                <!--<span class="ui text">已 <span class="count">{{ product.appoint_count|default 0}}</span>人预约，</span>-->
                                <span class="ui text">倒计时：<span id="clock"></span></span>
                            </div>
                        {% else %}
                            <div class="product snatched">
                                {% if product.can_saled %}
                                <span class="ui black text">正在抢购中...</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                
                
                    {% if product.snatched %}
                
                        {% if !product.snatched_start %}
                            <div class="fluid ui active magenta tobuy appoint button">
                                准备开抢
                            </div>
                        {% else %}
                            {% if product.can_saled %}
                                <div class="fluid ui active magenta tobuy nowbuy inverted button">
                                    立即抢购
                                </div>
                            {% else %}
                                <div class="fluid ui active grey locknotice inverted button">
                                    已抢完
                                </div>
                            {% endif %}
                        {% endif %}

                    {% else %}
                        <!--积分兑换商品不能加入购物车 -->
                        {% if item_stage == 'exchange' %}
                            <div class="product snatched">
                                <span class="ui gray text">商品积分兑换</span>
                            </div>
                        
                            {% if product.can_saled %}
                                <span class="redemption">
                                    {% if product.exchange_price %}
                                        (兑换要求：<small>￥</small>{{ product.exchange_price }} + {{ product.max_bird_coin }}鸟币) 
                                    {%else%}
                                        (兑换要求：{{ product.max_bird_coin }}鸟币)
                                    {%endif%}
                                </span>
                                <div class="fluid ui active magenta tobuy nowbuy inverted button">
                                    <i class="exchange icon"></i> 立即兑换
                                </div>
                            {%else%}
                                <div class="fluid ui active grey locknotice inverted button" data-id="{{ product._id }}">
                                    暂时缺货
                                </div>
                            {%endif%}
                        {%endif%}
                    
                        <!--商品-->
                        {% if item_stage == 'shop' %}
                            {% if !product.snatched %}
                                {% if !product.is_try %}
                                    {% if product.can_saled %}
                                        <div class="ui red tobuy nowbuy inverted button">
                                            立即购买
                                        </div>
                                    {% endif %}
                                {%else%}
                                    <div class="ui magenta text">
                                        此产品为试用商品，不可销售
                                    </div>
                                {% endif %}
                            {% endif %}
                        {%endif%}
                        <!--可销售商品-->
                        {% if item_stage == 'shop' %}
                            {% if !product.is_try %}
                                {% if product.can_saled %}
                                    <div class="ui active magenta tobuy buy inverted button">
                                        <i class="cart icon"></i> 加入购物车
                                    </div>
                                {% else %}
                                    <div class="fluid ui active grey locknotice inverted button" data-id="{{ product._id }}">
                                        已售罄
                                    </div>
                                {% endif %}
                            {% endif %}				
                        {% endif %}

                    {%endif%}
                </div>
            </div>
            {% else %}
                {% if product.product_info.official_price %}
                <div class="sellwrap">
        			<div class="buy box">
        				<p>
        					指导价格：<span class="price"><span class="unit"><i class="yen icon"></i></span>{{ product.product_info.official_price }}</span>
                        </p>
                    
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
			
			{% if visitor.can_edit %}
			<div class="sellwrap">
			  <div class="user action">
				<div style="margin: 15px 0;">
				  <p>专辑分享产品</p>
				</div>
				<div class="ui magenta albums inverted button" data-title="加入专辑" data-content="加入到产品专辑中..." data-id="{{ product._id }}" data-mark="n">
					<i class="plus icon"></i> 加入专辑
				</div>
				
				<div class="ui albums modal">
				  <i class="close icon"></i>
				  <div class="header">
					将相应的产品加入专辑
				  </div>
				  <div class="ui options" style="margin:1em 50px 10px 50px">
					<input type="hidden" name="category_id" id="albums_category" />					
					{% for albums in albums %}
						<div class="ui magenta alt option" data-value="{{ albums._id }}">
							<i class="check circle outline icon"></i>
							{{ albums.title }}
						</div>
					{% endfor %}
					<div style="margin:10 50px 10px 50px">
					  <a id="albums" style="display: none" href="" class="ui blue button" target="_blank">去往专辑页</a>
					</div>
				  </div>
				  <div class="actions">
					<div class="ui albums Cancel button">取消</div>
					<a class="ui albums OK button ajax">提交</a>
					<!--<div class="ui albums OK button">提交</div>-->
				  </div>
				</div>
			  </div>
			</div>
			{% endif %}
			
            <div class="sellwrap">
                <div class="user action">
                    <p>关注&分享产品</p>
        			<div class="ui red pop love inverted button" data-id="{{ product._id }}" data-title="点赞支持" data-content="后续可以在‘我赞了的’中快捷查找" data-mark="n">
        				<i class="heart empty icon"></i> 赞
        			</div>
        			<div class="ui magenta pop favorite inverted button" data-title="关注一下" data-content="有关该产品动态及时通知你，后续可以在‘我关注的’中快捷查找" data-id="{{ product._id }}" data-mark="n">
        				<i class="plus icon"></i> 关注
        			</div>
                </div>
                <div class="user avatars">
              	  	<div class="ui images" id="target_{{ product._id }}_support">
                        {% if product.love_count %}
                            {% favorite_list var:'userlist' target_id:product._id event:2 type:1 size:50 %}
                            {% for target in userlist.rows %}
                            <a href="{{ target.user.home_url }}" target="_blank" id="user-{{ target.user._id }}" class="image" data-variation="wide" data-html="<div class='header'>{{ target.user.nickname }}</div><div class='content'>{{ target.user.city }} {{ target.user.profile.job }} </div>">
                  	  	        <img src="{{ target.user.mini_avatar_url }}" alt="{{ target.user.nickname }}" />
                            </a>
                            {% endfor %}
                        {% endif %}
              	  	</div>
                    <p>
                        已有 <span id="target-love-count">{{ product.love_count }}</span> 个人点赞, <span id="target-favorite-count">{{ product.favorite_count }}</span> 人关注
                    </p>                    
                </div>
                <div class="user share">
                	<span><i class="share alternate icon"></i>分享：</span>
                	<a href="javascript:void(0);" id="sina-share" title="新浪微博" class="ui red icon btn">
                		<i class="weibo icon large circular red inverted"></i>
                	</a>
                	<a href="javascript:void(0);" id="wechat-share" class="ui green icon btn" title="微信">
                		<i class="weixin icon large circular green inverted"></i>
                	</a>
                	<a href="javascript:void(0);" id="tencent-share" title="腾讯微博" class="ui blue icon btn">
                		<i class="tencent weibo icon large circular blue inverted"></i>
                	</a>
                	<a href="javascript:void(0);" id="renren-share" title="人人网" class="ui blue icon btn">
                		<i class="icon renren large circular blue inverted"></i>
                	</a>
                </div>
            </div>
       
        
        <!--品牌相关-->
        <div class="sellwrap">
			<div class="block title">
                {% if item_stage == 'idea' %}分享者{%else%}品牌{%endif%}
            </div>
            <div class="brand products">
                {% if product.designer %}
                <div class="author">
    				<a href="{{ product.designer.home_url }}" class="ui large avatar image" >
    					<img src="{{ product.designer.big_avatar_url }}" alt="{{ product.designer.nickname }}" />
    				</a>
                    <h4>
                        {{ product.designer.nickname }}
                    </h4>
                    {% if product.designer.city %}
                    <p class="info">{{ product.designer.city }} {{ product.designer.profile.job }}</p>
                    {% endif %}
                    <p class="desc">
                        {{ product.designer.summary }}
                    </p>
                </div>
                {% else %}
                <div class="author">
    				<a href="{{ product.user.home_url }}" class="ui large avatar image" >
    					<img src="{{ product.user.big_avatar_url }}" alt="{{ product.user.nickname }}" />
    				</a>
                    <h4>
                        {{ product.user.nickname }}
                    </h4>
                    {% if product.user.city %}
                    <p class="info">{{ product.user.city }} {{ product.user.profile.job }}</p>
                    {% endif %}
                    <p class="desc">
                        {{ product.user.summary }}
                    </p>
                </div>
                {% endif %}
                
                {% product_list var:'plist' page:1  only_onsale:1 size:4 user_id:product.user_id  %}
                <div class="ui two miniproducts blocks">
                    {% for product in plist.rows %}
                    <div class="block">
            			<div class="image" {% if product.cover %}style="background-image: url('{{ product.cover.thumbnails.hm.view_url }}');"{% endif %}>
                            <a class="transparent" href="{{ product.view_url }}" target="_blank"></a>
            			</div>
                     </div>    
                     {% endfor %}
                </div>
                {% if product.designer %}
    			<div class="more">
    				<a href="{{ app_url_user }}/{{ product.designer._id }}/submitted" class="ui link" target="_blank">
                        <i class="search icon"></i> 查看更多产品
                    </a>
                </div>
                {% endif %}
            </div>
			
        </div>

        <!--专辑-->
        <div class="sellwrap" id="shop-albums-list" style="display:none;">
			<div class="block title">
               产品所在专辑 
      </div>
            <div class="ui articles shop-albums list">

            </div>
    </div>
        
		{% ad_list var:'adslide2' page:1 size:2 state:2 name:'product_rightbar_stick' %}
        {% if adslide2.rows %}
        <div class="adstickwrap">
            <div class="ui one adverts cards">
                {% for ad in adslide2.rows %}
                <div class="card">
                    <div class="advblock">
                        <div class="image" style="background-image: url('{{ ad.cover.fileurl }}');padding:30% 0;">
                            <a href="{{ ad.view_url }}" title="{{ ad.title }}" target="_blank"></a>
                        </div>
                        <div class="desc">
                            <h2>
                                {{ ad.title }}
                            </h2>
                            <p>{{ ad.sub_title }}</p>
                        </div>
                        <a href="{{ ad.view_url }}" title="{{ ad.title }}" class="link wrap" target="_blank"></a>
                    </div>
                </div>
                {%endfor%}
            </div>
        </div>
        {%endif%}
        
        {% if visitor.can_edit %}
        <div class="sellwrap">
            管理：
            <div class="ui icon green editable inverted buttons">
                {% if product.featured %}
				<div class="ui pop fine active button" data-content="取消精选"  data-variation="inverted" data-mark="y" data-id="{{ product._id }}">
					<i class="star icon"></i>
				</div>
				{% else %}
				<div class="ui pop fine button" data-content="标记精选" data-variation="inverted" data-mark="n" data-id="{{ product._id }}">
					<i class="star empty icon"></i>
				</div>
				{% endif %}
				{% if product.stick %}
				<div class="ui pop stick active button" data-content="取消推荐"  data-variation="inverted" data-mark="y" data-id="{{ product._id }}">
					<i class="flag icon"></i>
				</div>
				{% else %}
				<div class="ui pop stick button" data-content="编辑推荐" data-variation="inverted" data-mark="n" data-id="{{ product._id }}">
					<i class="flag outline icon"></i>
				</div>
				{% endif %}
        		{% if editable %}
                    {% if product.stage == 15 %}
                      <div class="ui pop edit button" data-content="编辑" data-variation="inverted" data-id="{{ product._id }}">
                          <i class="edit icon"></i>
                      </div>
                      <div class="ui pop remove button" data-content="删除" data-variation="inverted" data-id="{{ product._id }}">
                          <i class="remove icon"></i>
                      </div>
                    {%endif%}
        		{% endif %}
    		</div>
        </div>
        {%endif%}
    </div>
</div>
<div id="product_guess_list" class="product white guess"></div>
{% include "block/sharebox.html" %}
{% include "block/qrcode.html" %}
{% endblock %}

{% block templates %}

  {% if product.stage == 15 %}
    {% mustache id:'get_comments_tpl' tpl:'mustache/fetch_comments.mustache' %}
    {% mustache id:'get_shop_albums_tpl' tpl:'mustache/fetch_shop_albums.mustache' %}
  {%else%}
    {% mustache id:'get_comments_tpl' tpl:'mustache/fetch_shop_comments.mustache' %}
  {%endif%}
  {% mustache id:'pager_tpl' tpl:'mustache/pager.mustache' %}
  {% mustache id:'guess_products_tpl' tpl:'mustache/guess_products.mustache' %}
{% endblock %}
