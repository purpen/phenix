{%extends 'layout/wechat.html'%}
{% block title %}确认订单-{% endblock %}
{% block page_css %}
<style type="text/css">
	.fever-view .wide.cover.column {
		padding-right: 0;
	}
	.product.designer > .column {
		margin-bottom: 0rem;
		margin-top: 0rem;
	}
	.product .attributes {
		
	}
	.product .attributes .letter-spacing-two {
		letter-spacing: 2em;
	}
	.product .attributes .price {
		font-size: 1.5em;
		color: #F42156;
	}
	
	.cover-thumb {
		text-align: center;
	}
	.vote.timer .button {
		padding-left: 4em;
		padding-right: 4em;
	}
	.ui.inventor {
		background-color:rgba(255,51,102,1);
		color: #fff;
	}
	.inventor .inventor-info {
	    margin: 1em auto;
	    text-align: center;
	}
	.inventor .inventor-info .summary {
		margin: 1em auto;
		line-height: 24px;
	}
	.ui.list > .item {
		padding-left: 0em;
		padding-right: 0em;
	}
	.ui.list > .item > .mm-image,
	.ui.list > .item > .mm-content {
		float: left;
		margin-right: 1em;
	}
</style>
{% endblock %}
{% block js %}
{% endblock %}
{% block jquery %}

	// 获取共享地址
	alert('debug address');
	WeixinJSBridge.invoke('editAddress', { 
			"appId" : '{{ wxaddr_options.appId }}',
			"scope" : "jsapi_address",
			"signType" : "sha1",
			"addrSign" : "{{ wxaddr_options.addrSign }}", 
			"timeStamp" : "{{ wxaddr_options.timeStamp }}",
			"nonceStr" : "{{ wxaddr_options.nonceStr }}",
		}, function(res){
			//若res 中所带的返回值丌为空,则表示用户选择该返回值作为收货地址。否则若返回空,则表示用户取消了这一次编辑收货地址。
			alert('bird');
			alert(res);
			alert('bird2');
		});
		
	// 微信支付
	var wechat_pay = function() {
		// 传入公众号名称,时间戳,随机串,Package 扩展字段,签名方式和 PaySign 签名
		WeixinJSBridge.invoke('getBrandWCPayRequest', { 
			"appId" : "{{ wxoptions.appId }}", 
			"timeStamp" : "{{ wxoptions.timeStamp }}",
			"nonceStr" : "{{ wxoptions.nonceStr }}",
			"package" : "{{ wxoptions.package }}",
			"signType" : "SHA1",
			"paySign" : "{{ wxoptions.paySign }}"
			}, function(res){
				// 返回 res.err_msg,取值
				// get_brand_wcpay_request:cancel 用户取消 // get_brand_wcpay_request:fail 发送失败
				// get_brand_wcpay_request:ok 发送成功
				WeixinJSBridge.log(res.err_msg);
				alert(res.err_msg);
				// 支付成功
				if (res.err_msg == 'get_brand_wcpay_request:ok'){
					alert('支付成功！');
				} else if (res.err_msg == 'get_brand_wcpay_request:fail') { // 支付失败
					alert('支付失败！');
				} else if (res.err_msg == 'get_brand_wcpay_request:cancel') { // 支付失败
					alert('支付取消！');
				} else {
					alert('微信支付出现异常，请核对信息后重试！');
				}
		});
	};
	
	$('.ui.wxpay.button').bind('click', function(){
		// 更新订单
		$.post('{{ app_url_domain }}/wxpay/confirm', {rid: '{{ rid }}'}, function(res){
			if(res.success){
				wechat_pay();
			} else {
				alert(res.message);
			}
		},'json');
	});
	
{% endblock %}

{% block content %}
<div class="wechat checkout">
	<div class="ui responsive grid">		
		<div class="row">
			<div class="column">
				<h3 class="ui inverted green header">确认订单</h3>
				
				<h3 class="ui dividing header"></h3>
				<div class="ui pointing vertical fluid menu">
					<div class="item">
						<a href="{{ app_url_domain }}/wxpay/addr" class="ui address">请填写收货地址</a>
					</div>
				</div>
				<h3 class="ui header">订单信息</h3>
				<div class="ui segment">
					<div class="ui list">
						{% for product in data.items %}
						<div class="item" id="product_{{ product.sku }}">
							<div class="mm-image">
								<a href="{{ product.view_url }}" class="ui cover image">
						      		<img src="{{ product.cover }}">
								</a>
							</div>
							<div class="mm-content">
					          	<div class="header">
									<a href="{{ product.view_url }}" class="ui link">{{ product.title }}</a>
								</div>
					          	<p class="attribute">价格：￥{{ product.sale_price }}</p>
								<p class="attribute">数量：￥{{ product.quantity }}</p>
							</div>
						</div>
						{% endfor %}
						<div class="item">
							配送方式 （快递：免运费）</div>
					</div>
				</div>
				
				<button class="ui magenta fluid wxpay button">微信支付</button>
				
			</div>
		</div>
	</div>
	
</div>
{% endblock %}