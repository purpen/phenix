{%extends 'layout/wechat.html'%}
{% block title %}确认订单-{% endblock %}
{% block page_css %}
<style type="text/css">
	.fever-view .wide.cover.column {
		padding-right: 0;
	}
	.product.designer > .column {
		margin-bottom: 0rem;
		margin-top: 0rem;
	}
	.product .attributes {
		
	}
	.product .attributes .letter-spacing-two {
		letter-spacing: 2em;
	}
	.product .attributes .price {
		font-size: 1.5em;
		color: #F42156;
	}
	
	.cover-thumb {
		text-align: center;
	}
	.vote.timer .button {
		padding-left: 4em;
		padding-right: 4em;
	}
	.ui.inventor {
		background-color:rgba(255,51,102,1);
		color: #fff;
	}
	.inventor .inventor-info {
	    margin: 1em auto;
	    text-align: center;
	}
	.inventor .inventor-info .summary {
		margin: 1em auto;
		line-height: 24px;
	}
	.ui.list > .item {
		padding-left: 0em;
		padding-right: 0em;
	}
	.ui.list > .item > .mm-image,
	.ui.list > .item > .mm-content {
		float: left;
		margin-right: 1em;
	}
	
	.ui.vertical.address.menu .item {
		padding: 0.83em 2.05em 0.83em 0.95em;
		cursor: pointer;
	}
	.ui.vertical.address.menu .item p {
		margin: 0.5em 0;
	}
	.ui.vertical.menu .item > i.icon {
	    position: absolute;
	    right: 5px;
	    top: 45%;
	}
	
</style>
{% endblock %}

{% block page_js %}
<script type="text/javascript">
	function getaddr(){
		if (typeof WeixinJSBridge == 'undefined') {
			// alert('WeixinJSBridge undefined');
			// setTimeout('getaddr()', 10);
			return false;
		} else {
			WeixinJSBridge.invoke('editAddress', {
					"appId" : '{{ wxaddr_options.appId }}',
					"scope" : "jsapi_address",
					"signType" : "sha1",
					"addrSign" : "{{ wxaddr_options.addrSign }}", 
					"timeStamp" : "{{ wxaddr_options.timeStamp }}",
					"nonceStr" : "{{ wxaddr_options.nonceStr }}",
				},function(res) {
					if (res != '') {
						alert(res.err_msg);
						//已选择地址
						if(res.err_msg == 'edit_address:ok'){
							//获取成功
							var addr_html = new Array();
							
							addr_html.push('<p><b>送至：</b></p>');
							addr_html.push('<p>'+ res.proviceFirstStageName +','+ res.addressCitySecondStageName +','+ res.addressCountiesThirdStageName +','+ res.addressDetailInfo +'</p>');
							addr_html.push('<p>'+ res.userName+','+ res.telNumber +'</p>');
							alert(addr_html.join(''));
							$('#send-address').html(addr_html.join('')).show();
							
							$('#choose-address').hide();
						}else{
							// setTimeout('getaddr()', 100);
							//获取失败
							// alert(res.err_msg);
							$('#choose-address').show();
							$('#send-address').hide();
	        			}
	      		 	} else {
	      			  //未选择地址
					  window.location.href = '...';
	      			}
	    		});
		}
	}
</script>
{% endblock %}

{% block jquery %}
	// 微信支付
	var wechat_pay = function() {
		// 传入公众号名称,时间戳,随机串,Package 扩展字段,签名方式和 PaySign 签名
		WeixinJSBridge.invoke('getBrandWCPayRequest', { 
			"appId" : "{{ wxoptions.appId }}", 
			"timeStamp" : "{{ wxoptions.timeStamp }}",
			"nonceStr" : "{{ wxoptions.nonceStr }}",
			"package" : "{{ wxoptions.package }}",
			"signType" : "SHA1",
			"paySign" : "{{ wxoptions.paySign }}"
			}, function(res){
				// 返回 res.err_msg,取值
				// get_brand_wcpay_request:cancel 用户取消 // get_brand_wcpay_request:fail 发送失败
				// get_brand_wcpay_request:ok 发送成功
				WeixinJSBridge.log(res.err_msg);
				alert(res.err_msg);
				// 支付成功
				if (res.err_msg == 'get_brand_wcpay_request:ok'){
					alert('支付成功！');
				} else if (res.err_msg == 'get_brand_wcpay_request:fail') { // 支付失败
					alert('支付失败！');
				} else if (res.err_msg == 'get_brand_wcpay_request:cancel') { // 支付失败
					alert('支付取消！');
				} else {
					alert('微信支付出现异常，请核对信息后重试！');
				}
		});
	};
	
	$('.ui.wxpay.button').bind('click', function(){
		// 更新订单
		$.post('{{ app_url_domain }}/wxpay/confirm', {rid: '{{ rid }}'}, function(res){
			if(res.success){
				wechat_pay();
			} else {
				alert(res.message);
			}
		},'json');
	});
	
	// 获取共享地址
	$('.ui.address').bind('click', function() {
		getaddr();
	});
	
{% endblock %}

{% block content %}
<div class="wechat checkout">
	<div class="ui responsive grid">		
		<div class="row">
			<div class="column">
				<h3 class="ui inverted green header">确认订单</h3>
				
				<h3 class="ui dividing header"></h3>
				<div class="ui vertical fluid address menu">
					<div class="item ui address">
						<div id="choose-address">确认收货地址</div>
						<div id="send-address"></div>
						<i class="flat page_right icon"></i>
					</div>
				</div>
				
				<h3 class="ui header">订单信息</h3>
				<div class="ui segment">
					<div class="ui list">
						{% for product in data.items %}
						<div class="item" id="product_{{ product.sku }}">
							<div class="mm-image">
								<a href="{{ product.view_url }}" class="ui cover image">
						      		<img src="{{ product.cover }}">
								</a>
							</div>
							<div class="mm-content">
					          	<div class="header">
									<a href="{{ product.view_url }}" class="ui link">{{ product.title }}</a>
								</div>
					          	<p class="attribute">价格：￥{{ product.sale_price }}</p>
								<p class="attribute">数量：￥{{ product.quantity }}</p>
							</div>
						</div>
						{% endfor %}
						<div class="item">
							配送方式 （快递：免运费）</div>
					</div>
				</div>
				
				<button class="ui magenta fluid wxpay button">微信支付</button>
				
			</div>
		</div>
	</div>
	
</div>
{% endblock %}