{%extends 'layout/column.html'%}
{% block title %}{% endblock %}

{% block page_css %}
<style class="text/css">
	.try .masthead {
		{% if try.banner_id %}
		background: url("{{ try.banner.fileurl }}") no-repeat scroll center center / cover rgba(45, 53, 56, 1);
		{% else %}
	    background: no-repeat scroll center center / cover rgba(45, 53, 56, 1);
		{% endif %}
	}
	
	.try .masthead .ui.header {
		  margin-top: 0.6em;
	}
	.try .masthead .ui.header .sub.header{
		color: #fff;
		font-size: 1.5rem;
		margin-top: 0;
		line-height: 46px;
	}
	.try .masthead .ui.button{
		width:180px;
	}
	.try .masthead .ui.header .sub.header span{
		font-size: 18px;
	}
    
	.try .apply {
	  margin-top: 1.3em;
	  line-height: 28px;
	}
    
	.ui.horizontal.list>.item{
		margin-left: 1em !important;
		margin: 10px 0;
	}
	.product.overview{
		padding-bottom:1em;
	}
	
	.product.aption img,.product.aption p{
		margin:0 auto;
		display:block;
		text-align:center;
	}
	.product.aption p{
		margin-bottom: 1em;
	}
    .product.report {
        padding-bottom: 2rem;
    }

	.ui.lapiao{
	    border:0px solid #fff !important;
	}
    .ui.lapiao > .content{
	    background:url({{ app_url_packaged }}/images/trybox.jpg) no-repeat center center /cover;
	}
	#lapiao canvas{
	  width:100% !important;
	}
    
    p.contact {
        margin: 20px 0px 0px;
    }
</style>
{% endblock %}

{% block layout_js %}
<script type="text/javascript">
    var per_page = 10;
    function fetch_comment(current_page, per_page){
        var url = '{{ app_url_comment }}/ajax_fetch_comment_site';
        $.get(url, {target_id: {{ try._id }}, type: 3, page: current_page, per_page: per_page});
    }
</script>
{% endblock %}

{% block jquery %}
    //ajax加载评论
    fetch_comment(1, per_page);
	
	$('.ui.applytry.button').click(function(){
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.show_login_box();
			return false;
		}
		
		$('.ui.applytry.modal').modal('show');
		return false;
	});
	
	$('.ui.deny.button').click(function(){
		$('.ui.applytry.modal').modal('hide');
	});
	
	// 申请表地址信息
	$('.ui.district.dropdown').livequery(function(){
		$(this).dropdown();
	});
	
	$('.ui.province.dropdown').livequery(function(){
		$(this).dropdown({
			onChange : function(value, text){
				if (value) {
					$.get('{{ app_url_address }}/ajax_fetch_districts', {id: value});
				}
			}
		});
	});
	
	$('.ui.district.dropdown').livequery(function(){
		$(this).dropdown();
	});
	
	$('#apply-form').livequery(function(){
		$(this).form({
			name: {
				identifier  : 'name',
				rules: [
					{
						type   : 'empty',
						prompt : '姓名不能为空'
					}
				]
			},
			phone: {
				identifier  : 'password',
				rules: [
					{
						type   : 'empty',
						prompt : '电话不能为空'
					},
					{
						type   : 'length[11]',
						prompt : '电话必须11位字符'
					}
				]
			},
			address: {
				identifier  : 'address',
				rules: [
					{
						type   : 'empty',
						prompt : '地址区域不能为空'
					}
				]
			},
			zip: {
				identifier  : 'zip',
				rules: [
					{
						type   : 'empty',
						prompt : '邮编不能为空'
					}
				]
			},
			wx: {
				identifier  : 'wx',
				rules: [
					{
						type   : 'empty',
						prompt : '微信号不能为空'
					}
				]
			},
			qq: {
				identifier  : 'qq',
				rules: [
					{
						type   : 'empty',
						prompt : 'QQ号不能为空'
					}
				]
			},
			content: {
				identifier  : 'content',
				rules: [
					{
						type   : 'empty',
						prompt : '申请理由不能为空'
					}
				]
			}
		}, {
			inline : true,
			onSuccess: function(event){
				event.preventDefault();
				$(this).ajaxSubmit();
			}
		});
	});
	
	phenix.hook_comment_page();
	
	phenix.bind_share_list();
	// 生成二维码
	$('#qrcode').qrcode({width: 256, height: 256, text: '{{ try.wap_view_url }}'});

  {% if !try.is_end %}
    {% if is_applied %}
      // 生成支持二维码
      $('#lapiao').qrcode({width: 256, height: 256, text: '{{ app_url_wap }}/try/apply_success?apply_id={{ apply._id }}'});

      $('.lapiao-btn').click(function() {
        $('.ui.lapiao.modal').modal('show');
        return false;
      });

    {%endif%}
  {%endif%}
	// 分享
	$('.ui.share.button').bind('click', function(){
		$('.ui.share.modal').modal('show');
	});
	
	$('[data-countdown]').each(function() {
		var $this = $(this), finalDate = $(this).data('countdown');
		$this.countdown(finalDate, function(event) {
			$this.html(event.strftime('<div class="item"><div class="count">%D<span>&nbsp;天</span></div></div><div class="item"><div class="count">%H<span>&nbsp;时</span></div></div> <div class="item"><div class="count">%M<span>&nbsp;分</span></div></div><div class="magenta item"><div class="count">%S<span>&nbsp;秒</span></div></div>'));
		});
	});
	
    $('textarea.comment-textarea').maxlength({
        'feedback' : '.wordscount'
    });
	
{% endblock %}

{% block content %}
<div class="try">
	<div class="masthead">
		<div class="masthead-cover">
			<div class="ui responsive grid">
				<div class="column">
                    <div class="container">
    					<p>产品试用第{{ try.season }}期</p>
    					<h1 class="ui header">
    						<div class="content">
    							{{ try.title }}
    							<div class="sub header">
    								{{ try.description }}
    								<!--<br/>
    								<span>市场价：¥399</span>-->
    							</div>
    						</div>
    					</h1>
					    {% if !try.is_end %}
                            {% if is_applied %}
                              <a href="javascript:void(0);" class="ui white lapiao-btn inverted button" style="padding: .8em 2em!important;">
                                <i class="ticket icon"></i> 求支持
                              </a>
                            {%else%}
                              <a href="javascript:void(0);" class="ui white applytry inverted button" style="padding: .8em 2em!important;">
                                <i class="ticket icon"></i> 申请试用
                              </a>
                            {%endif%}
					    {% else %}
    					<a href="javascript:void(0);" class="ui active white inverted button">
    						<i class="lock icon"></i> 已结束
    					</a>
    					{% endif %}
                        <div class="ui white inverted pop share icon inverted button">
                            <i class="share icon"></i> 分享
                        </div>
                        <div class="apply">{% if !try.is_end %} 剩余时间：<div class="ui divided horizontal timer list" data-countdown="{{ try.end_time|date 'Y/m/d H:i:s' }}"></div>{% else %} 结束时间：{{ try.end_time }}{% endif %}<br/>产品数量：<b class="big">{{ try.try_count }}</b>个,&nbsp;<b class="big">{{ try.apply_count }}</b> 人已预约</div>
                    </div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="trypage sortby">
	<div class="block title">
		试用流程及规则
    </div>
    <div class="ui fluid four item menu">
        <div class="{%if try.step_stat==1%}active{%endif%} item">
            <i class="time icon"></i> 申请
        </div>
        <div class="{%if try.step_stat==2%}active{%endif%} item">
            <i class="heart icon"></i> 名单公布
        </div>
        <div class="{%if try.step_stat==3%}active{%endif%} item">
            <i class="star icon"></i> 提交报告
        </div>
        <div class="{%if try.step_stat==5%}active{%endif%} item">
            <i class="circle icon"></i> 试用结束
        </div>
    </div>
</div>

<div class="mainwrap" id="trypage">
    <div class="mainleftwrap">
        <div class="mainleft">
            <div class="container">
				<div class="ui tabox">
					<div class="ui four tabs">
						<a href="#.overview" class="active tab">试用介绍</a>
						<a href="#.people" class="tab">试用名单</a>
						<a href="#.reviews" class="tab">讨论 <small>（{{ try.comment_count||default 0 }}）</small></a>
						<a href="#.report" class="tab">试用报告</a>
					</div>
				</div>
                
				<div class="product overview">
					<div class="product content froala-element">
						{{ try.content }}
					</div>
				</div>
				
				<div class="bar"></div>
                
				<div class="product people">
                	<div class="block title">
                		试用名单
                    </div>
					{% if try.pass_users %}
					<div class="avatars" id="product-apply-people">
						{% user_list var:'userlist' user_ids:try.pass_users %}
					    <div class="ui horizontal list">
							{% for user in userlist  %}
							<div class="item">
								<a class="ui large avatar pop image" href="{{ user.home_url }}"  data-content="{{ user.summary|truncate 38 }}" data-variation="inverted">
									<img src="{{ user.medium_avatar_url }}" alt="{{ user.nickname }}" />
								</a>
							</div>
							{% endfor %}
						</div>
					</div>
					{% else %}
					<p class="resultbox">没有你的支持，这世界将失去一个伟大的产品!<p>
					{% endif %}
				</div>
                
				<div class="bar"></div>
                
				<div class="product report">
                	<div class="block title">
                		试用报告
                    </div>
                    {% topic_list var:'list' try_id:try._id time:'latest' %}
                    {% if list.rows %}
					<div class="social">
						<table class="ui topic table">
							<tbody>
							
							{% for topic in list.rows %}
								{% include "block/report_item.html" %}
							{% endfor %}
							</tbody>
						</table>
					</div>
                    {% else %}
                    <p class="resultbox">还没有人为 <a href="{{ try.view_url }}" class="ui link">{{ try.title }}</a> 撰写评测，你想做第一个为它写评测的人么？</p>
                    {% endif %}
					<div class="ui center aligned">
						<a href="{{ app_url_topic }}/report?tid={{ try._id }}" class="ui blue inverted button" target="_blank">
	                        <i class="tasks icon"></i> 全部报告
	                    </a>
						<!--通过审核的用户才能提交报告-->
						{% if visitor.is_login %}
						<a href="{{ app_url_topic }}/submit?cid={{ report_category_id }}&tid={{ try._id }}" class="ui magenta inverted button" target="_blank">
	                        <i class="edit icon"></i> 提交报告
	                    </a>
						{% endif %}
					</div>
				</div>
                
            </div>
            <div class="container">
                
				<div class="product reviews">
                	
                    <div class="reply box">
                    	<div class="block title">
                    		讨论 <small>（{{ try.comment_count||default 0 }}）</small>
                        </div>
                                <div id="comment-list">
                                
                                </div>
                                {% include "block/comment_box_site.html" %}

                    </div>
				</div>
                
            </div>
        </div>
    </div>
    <div class="mainright">
        
        {% if img_asset.qr_ios %}
        <div class="sellwrap">
            <div class="block title">
                APP下载
            </div>
            {% if img_asset.qr_ios %}
			    <img src="{{ img_asset.qr_ios.fileurl }}" style="width: 47%;margin-right: 6%;display: inline-block;float: left;" alt="app-iphone">
            {%endif%}
            {% if img_asset.qr_android %}
				<img src="{{ img_asset.qr_android.fileurl }}" style="width: 47%;">
            {%endif%}
            {% if img_asset.qr_ios %}
				<p style="width: 47%;margin-right: 6%;display: inline-block;float: left;text-align:center;">iphone</p>
            {%endif%}
            {% if img_asset.qr_android %}
				<p style="width: 47%;display: inline-block;float: left;text-align:center;">andriod</p>
            {%endif%}
        </div>
        {%endif%}

        {% if try.brand_introduce %}
        <div class="sellwrap">
			<div class="block title">
				品牌介绍
            </div>
            <div class="brand products">
                <div class="author">
                    {% if img_asset.brand_avatar %}
                        <img src="{{ img_asset.brand_avatar.fileurl }}" alt="{{ try.short_title }}" />
                    {%endif%}
                    <p class="desc">
                        {{ try.brand_introduce }}
                    </p>
                </div>
            </div>
        </div>
        {%endif%}
        
        <div class="sellwrap">
			<div class="block title">
				厂商合作申请
            </div>
            <p class="contact">邮箱: bianluyao@taihuoniao.com</p>
        </div>
        
        <div class="sellwrap">
			<div class="block title">
				这些人在申请
            </div>
            {% apply_list var:'list' target_id:try._id type:1 page:1 size:8 %}
			<div class="product appli">
				<table class="ui table">
					<tbody>
                        {% for t in list.rows %}
						<tr>
							<td class="author">
								<a class="ui small avatar image" href="{{ t.user.home_url }}" title="{{ t.user.nickname }}" target="_blank">
									<img src="{{ t.user.small_avatar_url }}" alt="{{ t.user.nickname }}">
								</a>
								<div class="content">
									<a class="ui link" href="{{ t.user.home_url }}" target="_blank">{{ t.user.nickname }}</a>
								</div>
							</td>
							<td class="nine wide">
                                {{ t.created_on|relative_date }}
							</td>
						</tr>
                        {%endfor%}
					</tbody>
				</table>
            </div>    
        </div>
        
        <div class="sellwrap">
			<div class="block title">
				关注太火鸟
            </div>
            <div class="product aption">
			    <img src="http://frstatic.qiniudn.com/images/weixin-220.jpg" alt="太火鸟-中国最火爆的智能硬件孵化平台">
			    <p>关注太火鸟有惊喜！</p>
            </div>
        </div>
        
    </div>
</div>

<div id="show-support-box">
  {% if !try.is_end %}
    {% if is_applied %}
    <div class="ui small lapiao modal">
        <i class="flat close icon"></i>
        <div class="content">
          <div class="ui grid">
            <div class="ui ten wide column">
              <h3 class="ui header">
                <img class="ui small avatar image" src="{{ apply.user.big_avatar_url }}">
                <div class="content">{{ apply.user.nickname }}
                  <div class="sub header">
                    {{ apply.user.ext_state.user_rank.title|default '鸟列兵' }}
                  </div>
                </div>
              </h3>
              
              <h2 class="ui header">恭喜您申请成功</h2>
              <p>分享到朋友圈和QQ，获取更多支持， 更有机会获取试用资格!</p>
            </div>
            <div class="ui six wide column">
              <h2 class="ui header">扫码分享</h2>
              <div id="lapiao"></div>
            </div>
          </div>
        </div>
    </div>
    {%endif%}
  {%endif%}
</div>
{% include "block/apply_try.html" %}
{% include "block/sharebox.html" %}
{% include "block/qrcode.html" %}
{% endblock %}
