{%extends 'layout/column.html'%}
{% block title %}{{ try.title }}-新品试用-{% endblock %}

{% block page_css %}
<style class="text/css">
	.try .masthead {
		{% if try.banner_id %}
		background: url("{{ try.banner.fileurl }}") no-repeat scroll center center / cover rgba(45, 53, 56, 1);
		{% else %}
	    background: no-repeat scroll center center / cover rgba(45, 53, 56, 1);
		{% endif %}
	    height: 500px;
		color: #fff;
	}
	.try .masthead .column {
		padding-top: 120px;
	}
	.try .masthead > .masthead-cover {
	    background-color: rgba(0, 0, 0, 0.15);
	    height: 100%;
	}
	.try .ui.header .sub.header {
		color: rgba(255, 255, 255, 0.9);
		font-size: 1.5rem;
	}
	.try .ui.list .count span{
		font-size:16px !important;
	}
</style>
{% endblock %}

{% block jquery %}
	$('.ui.applytry.btn').click(function(){
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.show_login_box();
			return false;
		}
		
		$('.ui.applytry.modal').modal('show');
		return false;
	});
	
	$('.ui.deny.button').click(function(){
		$('.ui.applytry.modal').modal('hide');
	});
	
	// 申请表地址信息
	$('.ui.district.dropdown').livequery(function(){
		$(this).dropdown();
	});
	
	$('.ui.province.dropdown').livequery(function(){
		$(this).dropdown({
			onChange : function(value, text){
				if (value) {
					$.get('{{ app_url_address }}/ajax_fetch_districts', {id: value});
				}
			}
		});
	});
	
	$('.ui.district.dropdown').livequery(function(){
		$(this).dropdown();
	});
	
	$('#apply-form').livequery(function(){
		$(this).form({
			name: {
				identifier  : 'name',
				rules: [
					{
						type   : 'empty',
						prompt : '姓名不能为空'
					}
				]
			},
			phone: {
				identifier  : 'password',
				rules: [
					{
						type   : 'empty',
						prompt : '电话不能为空'
					},
					{
						type   : 'length[11]',
						prompt : '电话必须11位字符'
					}
				]
			},
			address: {
				identifier  : 'address',
				rules: [
					{
						type   : 'empty',
						prompt : '地址区域不能为空'
					}
				]
			},
			content: {
				identifier  : 'content',
				rules: [
					{
						type   : 'empty',
						prompt : '申请理由不能为空'
					}
				]
			}
		}, {
			inline : true,
			onSuccess: function(event){
				event.preventDefault();
				$(this).ajaxSubmit();
			}
		});
	});
	
	phenix.hook_comment_page();
	
	// ajax加载更多评论
	$('.ui.more.button').livequery(function(){
		$(this).click(function(){
			if (!$(this).hasClass('disabled')){
				var p = $(this).data('page');
				$.get('{{ app_url_comment }}/ajax_fetch_list', {target_id: {{try._id}}, type:3, page:p});
			}
		});
	});
	
    $('.ui.tabox').smint({
    	'scrollSpeed': 1000
    });
	
	$('[data-countdown]').each(function() {
		var $this = $(this), finalDate = $(this).data('countdown');
		$this.countdown(finalDate, function(event) {
			$this.html(event.strftime('<div class="item"><div class="count">%D<span>&nbsp;天</span></div></div><div class="item"><div class="count">%H<span>&nbsp;时</span></div></div> <div class="item"><div class="count">%M<span>&nbsp;分</span></div></div><div class="magenta item"><div class="count">%S<span>&nbsp;秒</span></div></div>'));
		});
	});
	
    $('textarea.comment-textarea').maxlength({
        'feedback' : '.wordscount'
    });
	
{% endblock %}

{% block content %}
<div class="ui try" id="trypage">
	<div class="masthead">
		<div class="masthead-cover">
			<div class="ui responsive grid">
				<div class="column">
					<h1 class="ui header">
						<div class="content">
							{{ try.title }}
							<div class="sub header">
								{{ try.description }}
							</div>
						</div>
					</h1>
					<div class="ui buttons">
						{% if !try.is_end %}
						<a href="javascript:void(0);" class="ui white btn-4 btn-4c icon-arrow-right applytry btn">
							申请试用
						</a>
						{% else %}
						<a href="javascript:void(0);" class="ui active white btn-4 btn-4c icon-arrow-right btn">
							已结束
						</a>
						{% endif %}
						<a href="{{ try.product.view_url }}" class="ui white btn-4 btn-4c icon-arrow-right btn" target="_blank">
							产品详情
						</a>
					</div>
					<div class="apply"><b class="big">{{ try.apply_count }}</b> 人预约{% if !try.is_end %}, 剩余时间：<div class="ui divided horizontal timer list" data-countdown="{{ try.end_time|date 'Y/m/d H:i:s' }}"></div>{% else %}, 结束时间：{{ try.end_time }}{% endif %}</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="ui tabox">
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<div class="ui four tabs">
					  	<a class="active tab" href="#overview">试用介绍</a>
					  	<a class="tab" href="#reviews">讨论 ({{ try.comment_count||default 0 }})</a>
						<a class="tab" href="#people">名单公布</a>
						<a class="tab" href="#report">试用报告</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="product overview">
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<div class="product content froala-element">
						{{ try.content }}
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="product reviews">
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<h3 class="ui dividing header">
						讨论 <small>（{{ try.comment_count||default 0 }}）</small>
					</h3>
					<div class="ui big reply segment">
						<div class="ui threaded minimal comments" id="comments">
							{% comment_list var:'comments' page:page target_id:try._id type:3 %}
							{% for comment in comments.rows %}
							<div class="comment" id="{{ comment._id }}">
								<a class="avatar" href="{{ comment.user.home_url }}" title="{{ comment.user.nickname }}">
									<img src="{{ comment.user.small_avatar_url }}" alt="{{ comment.user.nickname }}" />
								</a>
								<div class="content">
									<a class="ui magenta link author" href="{{ comment.user.home_url }}" title="{{ comment.user.nickname }}">{{ comment.user.nickname }}</a>
									<div class="metadata">
										<div class="date">{{ comment.created_on }}</div>
									</div>
									<div class="laud">
										<a class="ui link icon ajax" href="{{ app_url_comment }}/ajax_laud?id={{ comment._id }}" id="laud_{{ comment._id}}">
											<i class="icon empty heart"></i>
										</a>
									</div>
									<div class="text">
										{{ comment.content|safe }}
									</div>
									<div class="actions">
										{% if visitor.is_login %}
										<a class="reply showbox" href="#reply_{{ comment._id }}">回复</a>
										{% endif %}
										{% if visitor.can_edit %}
										<a class="delete confirm-request" href="{{ app_url_comment }}/delete?id={{ comment._id }}">删除</a>
										{% else %}
											{% if visitor._id == reply.user_id %}
												<a class="delete confirm-request" href="{{ app_url_comment }}/delete?id={{ comment._id }}">删除</a>
											{% endif %}
										{% endif %}
									</div>
									<form class="ui reply hide form" action="{{ app_url_comment }}/ajax_reply" method="post" id="reply_{{ comment._id }}">
										<input type="hidden" name="type" value="2" />
										<input type="hidden" name="comment_id" value="{{ comment._id }}" />
										<input type="hidden" name="target_id" value="{{ topic._id }}" />
										<div class="field">
											<textarea name="content" class="reply-content"></textarea>
										</div>
										<div class="ui active button magenta submit labeled icon">
											<i class="icon location"></i> 回复
										</div>
									</form>
								</div>
				
				
								{% if comment.reply %}
								<div class="comments">
									{% for reply in comment.reply %}
										<div class="comment" id="{{ reply.r_id }}">
											<a class="avatar" href="{{ reply.user.home_url }}" title="{{ reply.user.nickname }}">
												<img src="{{ reply.user.small_avatar_url }}" />
											</a>
											<div class="content">
												<a class="author">{{ reply.user.nickname }}</a>
												<div class="metadata">
													<div class="date">{{ reply.replied_on }}</div>
												</div>
												<div class="text">
													{{ reply.content }}
												</div>
												<div class="actions">
													{% if visitor.can_edit %}
													<a class="delete confirm-request" href="{{ app_url_comment }}/delete_reply?id={{ comment._id }}&r_id={{ reply.r_id }}">删除</a>
													{% else %}
														{% if visitor._id == reply.user_id %}
															<a class="delete confirm-request" href="{{ app_url_comment }}/delete_reply?id={{ comment._id }}&r_id={{ reply.r_id }}">删除</a>
														{% endif %}
													{% endif %}
												</div>
											</div>
										</div>
									{% endfor %}
								</div>
								{% endif %}
				
							</div>
							{% endfor %}
						</div>
							
						{% if comments.total_page > 1 %}
						<div class="fluid ui gray more button" data-page="2" id="more-comments">更多评论</div>
						{% endif %}
						<div class="ui post segment">
							<p><a href="{{ visitor.home_url }}" class="ui link">{{ visitor.nickname }}</a> 发表评论</p>
							<form class="ui reply form" action="{{ app_url_comment }}/do_save" method="post" id="comment-form">
								<input type="hidden" name="target_id" value="{{ try._id }}" />
								<input type="hidden" name="type" value="3" />
								<input type="hidden" name="star" value="0" />
							
								<div class="field">
									<textarea name="content" class="comment-textarea" maxlength="140" placeholder="输入评论..."></textarea>
									<div id="comment"></div>
								</div>
								<div class="right aligned column">
									<small>还可以输入<span class="wordscount">140</span> 字</small> <input type="submit" class="ui small magenta button" value="添加评论" />
								</div>
							</form>
						</div>
						
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="product people">
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<h3 class="ui dividing header">
						试用达人
					</h3>
					
					{% if try.pass_users %}
					<div class="avatars" id="product-apply-people">
						{% user_list var:'userlist' user_ids:try.pass_users %}
					    <div class="ui horizontal list">
							{% for user in userlist  %}
							<div class="item">
								<a class="ui large avatar pop image" href="{{ user.home_url }}"  data-content="{{ user.summary|truncate 38 }}" data-variation="inverted">
									<img src="{{ user.medium_avatar_url }}" alt="{{ user.nickname }}" />
								</a>
								<div class="content">
								      <div class="header">
										  <a href="{{ user.home_url }}" class="ui link" target="_blank">{{ user.nickname }}</a>
									  </div>
								      <span>{{ user.city }}</span>
								</div>
							</div>
							{% endfor %}
						</div>
					</div>
					{% else %}
					<div class="ui gray message">没有你的支持，这世界将失去一个伟大的产品!</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
	
	<div class="product report">
		<div class="ui responsive grid">
			<div class="row">
				<div class="column">
					<h3 class="ui dividing header">
						评测报告
					</h3>
					<div class="social">
						<table class="ui topic table">
							<tbody>
							{% topic_list var:'list' try_id:try._id time:'latest' %}
							{% for topic in list.rows %}
								{% include "block/report_item.html" %}
							{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="center aligned column">
					<a href="{{ app_url_topic }}/report?tid={{ try._id }}" class="ui black btn-4 btn-4c icon-arrow-right btn" target="_blank">全部报告</a>
					<!--通过审核的用户才能提交报告-->
					{% if visitor.is_login %}
					<a href="{{ app_url_topic }}/submit?cid={{ report_category_id }}&tid={{ try._id }}" class="ui magenta btn-4 btn-4c icon-arrow-right btn" target="_blank">提交报告</a>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
	
</div>
{% include "block/apply_try.html" %}
{% endblock %}
