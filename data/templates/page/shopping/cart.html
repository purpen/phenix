{%extends 'layout/board.html'%}
{% block title %}购物车-{% endblock %}
{% block page_css %}
<style type="text/css">
	.ui.cart.list {
		
	}
	.ui.cart.list > .item .content > .attribute {
		color: rgba(0,0,0, 0.35);
		font-size: 0.875em;
	}
	.ui.cart.list > .item .quantity > .button {
		background-color: rgba(255, 255, 255, 0.85);
	    color: rgba(0, 0, 0, 0.35);
	    padding: 0.325em;
	}
	.ui.cart.list > .item .quantity > .button:hover {
		background-color: #666;
	    color: #fff;
		border-color: #666;
	}
	.ui.cart.list > .item .quantity > input {
		width: 40%;
		text-align: center;
	}
	.ui.cross.button {
		background-color: rgba(255, 255, 255, 0.85);
	    color: rgba(0, 0, 0, 0.35);
	}
	
	.ui.help {
		color: #9DA6AB;
	}
	.ui.indent {
		font-size: 0.875em;
		text-indent: 2.2em;
	}
	
	.actions {
		
	}
	
</style>
{% endblock %}
{% block js %}
{% endblock %}
{% block jquery %}
	var update_cart = function(pid, data){
		$('#cart_items_count').text(data.items_count);
		$('#cart_total_money').text(data.total_money);
	};

	$('.inc_qty.button').bind('click', function(){
		var inc_url = '{{ app_url_shopping }}/inc_qty',
			sku = $(this).data('sku'),
			qty_value = parseInt($('#product_'+sku+'_qty').val());
			
		// 添加1个数量
		qty_value += 1;
		
		$.getJSON(inc_url, {sku: sku, n: qty_value}, function(result){
			if (result.success){
				$('#product_'+sku+'_qty').val(qty_value);
				$('#product_'+sku+'_subttotal').text(result.data.product.subtotal+'元');
				
				update_cart(sku, result.data);
			}else{
				phenix.show_error_note(result.message, 5000);
			}
		});
		
	});
	
	$('.dec_qty.button').bind('click', function(){
		var dec_url = '{{ app_url_shopping }}/dec_qty', 
			sku = $(this).data('sku'),
			qty_value = parseInt($('#product_'+sku+'_qty').val());
			
		// 减少1个数量,验证是否为0
		qty_value  -= 1;
		
		$.getJSON(dec_url, {sku: sku, n: qty_value}, function(result){
			if (result.success){
				if (qty_value <= 0){
					$('#product_'+sku).remove();
				}else{
					$('#product_'+sku+'_qty').val(qty_value);
					$('#product_'+sku+'_subttotal').text(result.data.product.subtotal+'元');
				}
				
				update_cart(sku, result.data);
			}else{
				phenix.show_error_note(result.message, 5000);
			}
		});
		
	});
	
	$('.ui.close.button').bind('click', function(){
		var remove_url = '{{ app_url_shopping }}/remove',
			sku = $(this).data('sku');
		$.get(remove_url, {sku: sku});
	});
	
	$('.checkout.btn').bind('click', function(){
		var checkout = '{{ app_url_shopping }}/checkout';
		phenix.redirect(checkout, 0);
	});
	
{% endblock %}

{% block content %}
<div class="cart">
	<div class="ui responsive grid">
		
		<div class="row">
			<div class="ui center aligned column">
				<div class="ui three steps">
				  	<div class="ui active step">
				      	<span class="number">1</span>
						<span class="title">我的购物车</span>
				  	</div>
				  	<div class="ui step">
				      	<span class="middle number">2</span>
						<span class="title">填写核对订单信息</span>
				  	</div>
				  	<div class="ui step">
				    	<span class="number">3</span>
						<span class="title">支付订单</span>
				  	</div>
				</div>
			</div>
		</div>
		
		<div class="row">
			{% if products %}
				<div class="ui column" id="cart-body-content">
					<h3 class="ui header">我的购物车</h3>
					<div class="ui grid">
						<div class="two wide column"></div>
						<div class="left aligned six wide column">
							产品信息
						</div>
						<div class="center aligned one wide column">
							单价
						</div>
						<div class="center aligned three wide column">
							购买数量
						</div>
						<div class="center aligned three wide column">
							小计
						</div>
						<div class="center aligned one wide column"></div>
					</div>
				
					<div class="ui celled cart list form">
						{% for product in products %}
					  	<div class="item" id="product_{{ product.sku }}">
							<div class="ui middle aligned grid">
								<div class="two wide column">
									<a href="{{ product.view_url }}" class="ui cover image">
							      		<img src="{{ product.cover }}">
									</a>
								</div>
								<div class="six wide column">
							      	<div class="content">
							          	<div class="header">
											<a href="{{ product.view_url }}" class="ui link">{{ product.title }}</a>
										</div>
							          	<p class="attribute">编号：{{ product.sku }}</p>
							      	</div>
								</div>
								<div class="center aligned one wide column">
									{{ product.sale_price }}元
								</div>
								<div class="center aligned three wide quantity column">
									<button class="ui mini gray dec_qty icon button" data-sku="{{ product.sku }}">
										<i class="flat reduce icon"></i>
									</button>
									<input type="text" name="product_{{ product.sku }}_qty" id="product_{{ product.sku }}_qty" value="{{ product.quantity }}" />
									<button class="ui mini gray inc_qty icon button" data-sku="{{ product.sku }}">
										<i class="flat add icon"></i>
									</button>
								</div>
								<div class="center aligned three wide column">
									<div id="product_{{ product.sku }}_subttotal" data-money="{{ product.subtotal }}">
										{{ product.subtotal }}元
									</div>
								</div>
								<div class="center aligned one wide column">
									<button class="ui magenta close button" data-sku="{{ product.sku }}">
										<i class="flat close icon"></i>
									</button>
								</div>
							</div>
					  	</div>
						{% endfor %}
					</div>
				
					<div class="ui grid">
						<div class="left floated eight wide column">
							<a href="{{ app_url_shop }}" class="ui green button">继续购物</a>
						</div>
						<div class="right aligned floated eight wide column">
							<p><b id="cart_items_count">{{ items_count }}</b>件产品，总计： <b id="cart_total_money">{{ total_money }}</b>元</p>
							<button class="ui active magenta btn-4 btn-4c icon-arrow-right checkout btn">去结算</button>
						</div>
					</div>
				</div>
			
			{% else %}
				<div class="ui column" id="cart-body-content">
					<h3 class="ui header">我的购物车</h3>
					<div class="ui message">
						您还没找到喜欢的产品吗？<a href="{{ app_url_shop }}" class="ui link">赶快去选购吧</a>
					</div>
				</div>
			{% endif %}
		</div>
		
	</div>
</div>
{% endblock %}