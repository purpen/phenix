{%extends 'layout/column.html'%}
{% block title %}填写订单信息-{% endblock %}
{% block page_css %}
<style type="text/css">
    
</style>
{% endblock %}

{% block jquery %}
	
	// 显示地址框
	$('.ui.addbook.button').click(function(){
		$('.ui.addbook.modal').modal('show');
	});
	
	// 使用红包/礼品券/鸟币
	$('.bill > .ui.button').click(function(){
        var name = $(this).data('name');
        
        $('.bill > .forms-block > .ui.segment')
            .addClass('hide');
            
        $('.bill > .ui.button.active')
            .removeClass('active');
            
		if ($(this).hasClass('active')){
			$('.ui.'+ name +'.segment').addClass('hide');
			$(this).removeClass('active');
		}else{
			$('.ui.'+ name +'.segment').removeClass('hide');
			$(this).addClass('active');
		}
        
		return false;
	});    
	
	$('#submit-bonus').click(function(){
		var bonus_code = $('#bonus-code').val();
		var gift_val = $('#gift-code').val();
        if(gift_val){
 			phenix.show_error_note('礼品券和红包不能同时使用!', 3000);
            return false;
        }
		if(bonus_code){
			$.post('{{ app_url_shopping }}/ajax_bonus', {rid: '{{ order_info.rid }}', code: bonus_code}, function(result){
				if(result.success){
					$('#order-coin-money').text(result.data.discount_money);
					$('#order-pay-money').text(result.data.pay_money);
				}else{
					phenix.show_error_note(result.message, 3000);
				}
			}, 'json');
		}else{
			phenix.show_error_note('请输入红包码', 3000);
		}
	});

	$('#submit-gift').click(function(){
		var gift_code = $('#gift-code').val();
		var bonus_val = $('#bonus-code').val();
        if(bonus_val){
 			phenix.show_error_note('礼品券和红包不能同时使用!', 3000);
            return false;
        }
		if(gift_code){
			$.post('{{ app_url_shopping }}/ajax_gift', {rid: '{{ order_info.rid }}', code: gift_code}, function(result){
				if(result.success){
					$('#order-coin-money').text(result.data.discount_money);
					$('#order-pay-money').text(result.data.pay_money);
				}else{
					phenix.show_error_note(result.message, 3000);
				}
			}, 'json');
		}else{
			phenix.show_error_note('请输入礼品券号', 3000);
		}
	});

	$('#submit-bird-coin').click(function(){
		var bird_coin = $('#bird-coin').val();

		if(bird_coin){
			$.post('{{ app_url_shopping }}/ajax_check_bird_coin', {rid: '{{ order_info.rid }}', bird_coin: bird_coin}, function(result){
				if(result.success){
					$('#order-coin-money').text(result.data.discount_money);
					$('#order-pay-money').text(result.data.pay_money);
				}else{
					phenix.show_error_note(result.message, 3000);
				}
			}, 'json');
		}else{
			phenix.show_error_note('请输入鸟币数量', 3000);
		}
	});
	
	// 选择地址
	$('.address').on('click', '.block', function(){
		var addbook_id = $(this).data('id');
		// 新添加地址
		if (addbook_id == 0){
			$('.ui.addbook.modal').modal('show');
			return false;
		}
		if ($(this).hasClass('active')){
			$(this)
				.removeClass('active');
			
			$('#addbook_default_id').val('');
		} else {
			$('.address .item').removeClass('active');
			
			$(this).addClass('active');
			
			$('#addbook_default_id').val(addbook_id);
		}
	});
	
	// 支付方式,送货方式，发票
	$('.ui.options').on('click', '.option', function(){
		var id=$(this).data('value'), name=$(this).data('name');
		if ($(this).hasClass('active')){
			$(this)
				.removeClass('active');
				
			$('#'+name).val('');
			
			// 开具发票
			if (name == 'invoice_type'){
				if (id == 1) {
					$('#invoicebox').addClass('hide');
				} else {
					$('#invoicebox').removeClass('hide');
				}
			}
			
			// 单位名称
			if (name == 'invoice_caty'){
				if (id == 2) {
					$('#companybox').addClass('hide');
				} else {
					$('#companybox').removeClass('hide');
				}
			}
			
		}else{
			$(this)
				.siblings('.ui.option').removeClass('active')
				.end()
				.addClass('active');
			$('#'+name).val(id);
			
			// 开具发票
			if (name == 'invoice_type'){
				if (id == 1) {
					$('#invoicebox').removeClass('hide');
				} else {
					$('#invoicebox').addClass('hide');
				}
			}
			
			// 单位名称
			if (name == 'invoice_caty'){
				if (id == 2) {
					$('#companybox').removeClass('hide');
				} else {
					$('#companybox').addClass('hide');
				}
			}
		}
		
	});
	
	$('#addbook-form').livequery(function(){
		$(this).form({
			name: {
				identifier  : 'name',
				rules: [
					{
						type   : 'empty',
						prompt : '收货人姓名不能为空'
					}
				]
			},
			phone: {
				identifier  : 'password',
				rules: [
					{
						type   : 'empty',
						prompt : '联系电话不能为空'
					},
					{
						type   : 'length[11]',
						prompt : '联系电话必须11位字符'
					}
				]
			},
			address: {
				identifier  : 'address',
				rules: [
					{
						type   : 'empty',
						prompt : '地址区域不能为空'
					}
				]
			},
			zip: {
				identifier  : 'zip',
				rules: [
					{
						type   : 'empty',
						prompt : '邮政编码不能为空'
					}
				]
			}
		}, {
			inline : true,
			onSuccess: function(event){
				event.preventDefault();
				$(this).ajaxSubmit();
			}
		});
	});
	
	$('.ui.province.dropdown').livequery(function(){
		$(this).dropdown({
			onChange : function(value, text){
				if (value) {
					$.get('{{ app_url_address }}/ajax_fetch_districts', {id: value});
				}
			}
		});
	});
	
	$('.ui.district.dropdown').livequery(function(){
		$(this).dropdown();
	});
	
	// 编辑
	$('.ui.edit.button').bind('click', function(){
		var id = $(this).data('id');
		$.post('{{ app_url_address }}/edit_address', {id: id});
		return false;
	});
	
	// 删除
	$('.ui.remove.button').bind('click', function(){
		var id = $(this).data('id');
		if(confirm('确认执行这个删除操作吗?')){
			$.post('{{ app_url_address }}/remove_address', {id: id}, function(result){
				if (result.success){
					if ($('#'+result.data.id).hasClass('active')) {
						// 清空默认值
						$('#addbook_default_id').val('');
					}
					$('#'+result.data.id).remove();
				} else {
					phenix.show_error_note(result.message, 5000);
				}
			}, 'json');
        }
		return false;
	});
	
	$('#checkout-form').form({
		addbook_id: {
			identifier  : 'addbook_id',
			rules: [
				{
					type   : 'empty',
					prompt : '收货地址不能为空'
				}
			]
		},
		payment_method: {
			identifier  : 'payment_method',
			rules: [
				{
					type   : 'empty',
					prompt : '必须选择一种支付方式'
				}
			]
		},
		transfer: {
			identifier  : 'transfer',
			rules: [
				{
					type   : 'empty',
					prompt : '必须选择一种配送方式'
				}
			]
		},
		transfer_time: {
			identifier  : 'transfer_time',
			rules: [
				{
					type   : 'empty',
					prompt : '请选择一种送货时间'
				}
			]
		}
	}, {
		inline : false,
	    error: {
	      method  : function(message){
		      phenix.show_error_note(message, 5000);
		  }
	    },
		onSuccess: function(event){
			event.preventDefault();
			$(this).ajaxSubmit({
				dataType: 'json',
				beforeSubmit: function(){
					phenix.before_submit();
				},
				success: function(result){
					phenix.after_submit();
					
					if(result.is_error){
						$(event.target).addClass('error');
						phenix.show_error_note(result.message, 5000);
					}else{						
						phenix.redirect(result.redirect_url, 0);
					}
				}
			});
		}
	});
	
{% endblock %}

{% block content %}
<div id="checkout">
	<div class="ui responsive grid">
		<div class="row">
			<div class="ui center aligned column">
				<div class="ui three steps">
				  	<div class="ui active step">
				      	<span class="number">1</span>
						<span class="title">我的购物车</span>
				  	</div>
				  	<div class="ui active step">
				      	<span class="middle number">2</span>
						<span class="title">填写核对订单信息</span>
				  	</div>
				  	<div class="ui step">
				    	<span class="number">3</span>
						<span class="title">支付订单</span>
				  	</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="column">
				{% if preorder %}
				<div class="ui danger message">
					<div class="content">
						<i class="info icon"></i>
						请在下单后15分钟内付款哦，否则您的订单会被自动关闭。
					</div>
				</div>
				{% endif %}
				
				<h3 class="ui header">填写核对订单信息</h3>
				{% if order_info %}
				<form action="{{ app_url_shopping }}/confirm" method="post" id="checkout-form" class="ui form">
					<input type="hidden" name="rrid" value="{{ order_info._id }}" />
					<input type="hidden" name="is_presaled" value="{{ preorder }}" />
					<input type="hidden" name="is_nowbuy" value="{{ nowbuy }}" />
					
					<div class="step">
						<h3 class="ui dividing header">
							收货地址
						</h3>
						<input type="hidden" name="addbook_id" value="{{ data.addbook_id }}" id="addbook_default_id" />
						{% addbooks_list var:'addresses' user_id:visitor.id size:3 %}
						<div class="ui four address blocks">
							{% for address in addresses.rows %}
						  	<div class="{% if address.is_default %}active {% endif %} block" id="{{ address._id }}" data-id="{{ address._id }}">
                                <div class="content">
    								<h4 class="ui dividing header">
    									<i class="map marker icon"></i> <span class="name">{{ address.name }}</span>
    								</h4>
    								<p>{{ address.phone }}</p>
    								<p>{{ address.area_province.city}} {{ address.area_district.city }}<br /> {{ address.address }} <span>({{ address.zip }})</span></p>
							
    								<div class="actions">
    									<a class="ui small gray icon edit button" data-id="{{ address._id }}">
    										<i class="edit icon"></i>
    									</a>
    									<a class="ui small gray icon remove button" data-id="{{ address._id }}">
    										<i class="remove icon"></i>
    									</a>
    								</div>
                                </div>
						  	</div>
							{% endfor %}
							<div class="center aligned block" id="create-new-address" data-id="0">
								<a class="ui magenta addbook inverted button" href="javascript:void(0);">
									<i class="edit icon"></i> 添加新地址
								</a>
							</div>
						</div>
					</div>
					
					<div class="step">
						<h3 class="ui dividing header">
							支付方式
						</h3>
						<input type="hidden" name="payment_method" value="a" id="payment_method" />
						<div class="ui options">
							{% for pm in payment_methods %}
					   	 	<div class="ui {{ pm.active }} magenta alt option" data-value="{{ pm.id }}" data-name="payment_method">
					   	 		<div class="icon">
					   				<i class="fa fa-check"></i>
					   			</div>
					   	 		{{ pm.name }}
					   	 	</div>
							{% endfor %}
						</div>
					</div>
					
					<div class="step">
						<h3 class="ui dividing header">
							配送方式
						</h3>
						<input type="hidden" name="transfer" value="a" id="transfer" />
						<div class="ui options">
							{% for tm in transfer_methods %}
					   	 	<div class="ui {{ tm.active }} magenta alt option" data-value="{{ tm.id }}" data-name="transfer">
					   	 		<div class="icon">
					   				<i class="fa fa-check"></i>
					   			</div>
					   	 		{{ tm.name }} {% if tm.freight %} ({{ tm.freight }}元){% endif %}
					   	 	</div>
							{% endfor %}
						</div>
					</div>
					
					<div class="step">
						<h3 class="ui dividing header">
							送货时间
						</h3>
						<input type="hidden" name="transfer_time" value="a" id="transfer_time" />
					
						<div class="ui options">
							{% for tt in transfer_times %}
					   	 	<div class="ui {{ tt.active }} magenta alt option" data-value="{{ tt.id }}" data-name="transfer_time">
					   	 		<div class="icon">
					   				<i class="fa fa-check"></i>
					   			</div>
					   	 		{{ tt.title }}
					   	 	</div>
							{% endfor %}
						</div>
					</div>
					<!--
					<div class="step">
						<h3 class="ui dividing header">
							发票信息
						</h3>
						<input type="hidden" name="invoice_type" value="0" id="invoice_type" />
						<div class="ui options">
					   	 	<div class="ui active magenta alt option" data-value="0" data-name="invoice_type">
					   	 		<div class="icon">
					   				<i class="fa fa-check"></i>
					   			</div>
					   	 		无
					   	 	</div>
					   	 	<div class="ui magenta alt option" data-value="1" data-name="invoice_type"> 
					   	 		<div class="icon">
					   				<i class="fa fa-check"></i>
					   			</div>
					   	 		普通发票
					   	 	</div>
						</div>
						
						<div class="ui hide grid" id="invoicebox">
							<div class="row">
								<div class="ten wide column">
									<div class="ui segment">
										<p>发票内容：购买商品明细</p>
										<p>发票抬头：请确认单位名称正确,以免因名称错误耽搁您的报销。</p>
										<table class="ui table">
											<tr>
												<td class="six wide">
													<input type="hidden" name="invoice_caty" value="1" id="invoice_caty" />
													<div class="ui options">
												   	 	<div class="ui active magenta alt option" data-value="1" data-name="invoice_caty">
												   	 		<div class="icon">
												   				<i class="fa fa-check"></i>
												   			</div>
												   	 		个人
												   	 	</div>
												   	 	<div class="ui magenta alt option" data-value="2" data-name="invoice_caty"> 
												   	 		<div class="icon">
												   				<i class="fa fa-check"></i>
												   			</div>
												   	 		单位
												   	 	</div>
													</div>
												</td>
												<td class="company">
													<div class="ui hide field" id="companybox">
														<input name="invoice_title" type="text" placeholder="单位名称" />
													</div>
												</td>
											</tr>
										</table>
									</div>
								</div>
							</div>
						</div>
						
					</div>
					-->
					<div class="step">
						<h3 class="ui dividing header">
							备注信息
						</h3>
						<div class="field">
							<textarea name="summary" class="mini" maxlength="140" placeholder="特殊信息请备注说明"></textarea>
						</div>
					</div>
					
					<div class="step">
						<h3 class="ui dividing header">
							商品清单
						</h3>
						<table class="ui cart padded table segment form">
							<thead>
								<tr>
									<th>产品信息</th>
									<th class="center aligned">单价</th>
									<th class="center aligned">购买数量</th>
									<th class="center aligned">小计</th>
								</tr>
							</thead>
							<tbody>
								{% for product in data.items %}
								<tr id="product-{{ product.sku }}">
									<td class="six wide">
							          	<div class="ui small header">
									      	<div class="content">
												<a href="{{ product.view_url }}" class="ui link">{{ product.title }}</a>
												<div class="sub header">
													<p class="attribute">编号：{{ product.sku }}</p>
												</div>
									      	</div>
										</div>
									</td>
									<td class="center aligned">
										<span class="money">{{ product.sale_price }}</span> 元
									</td>
									<td class="center aligned">
										{{ product.quantity }}
									</td>
									<td class="center aligned">
										<div id="product-{{ product.sku }}-subttotal" data-money="{{ product.subtotal }}">
											<span class="money">{{ product.subtotal }}</span> 元
										</div>
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					
					<div class="ui grid">
						<div class="row">
							<div class="eight wide column">
								{% if !preorder %}
								<div class="bill">
									<a href="javascript:void(0);" class="ui small magenta bonus inverted button pop" data-content="使用红包" data-variation="inverted" data-name="bonus">
										<i class="fa-suitcase icon"></i> 使用红包
									</a>
									<a href="javascript:void(0);" class="ui small magenta gift inverted button pop" data-content="使用礼品券" data-variation="inverted" data-name="gift">
										<i class="gift icon"></i> 使用礼品券
									</a>
                                    {% if item_stage == 'exchange' %}
                                    <a href="javascript:void(0);" class="ui small magenta bird-coin inverted button pop" data-content="使用鸟币" data-variation="inverted" data-name="bird-coin">
                                        <i class="fa-money icon"></i> 使用鸟币
                                    </a>
                                    {% endif %}
                                    <div class="forms-block">
    									<div class="ui bonus hide segment">
                                            <h4>使用红包抵消部分金额</h4>
    										<div class="ui fluid action input">
                                                <input placeholder="输入红包码..." name="bonus" type="text" id="bonus-code" />
                                                <div class="ui active magenta button" id="submit-bonus">确定</div>
    										</div>
    									</div>
    									<div class="ui gift hide segment">
                                            <h4>使用礼品券抵消部分金额</h4>
    										<div class="ui fluid action input">
                                                <input placeholder="输入礼品券号..." name="gift" type="text" id="gift-code" />
                                                <div class="ui active magenta button" id="submit-gift">确定</div>
    										</div>
    									</div>
                                        {% if item_stage == 'exchange' %}
                                        <div class="ui bird-coin hide segment">
                                            <h4>{% if max_bird_coin == min_bird_coin %}可使用鸟币 <span>{{ max_bird_coin }}</span>, {%else%}可使用鸟币抵扣范围 <span>[{{ min_bird_coin }}, {{ max_bird_coin }}]</span> {%endif%} , 当前可用鸟币 <span id="current-bird-coin">{{ current_bird_coin }}</span> 个 <a href="{{ app_url_my }}/point" class="ui magenta link" target="_blank">[了解鸟币获取规则]</a></h4>
                                            <div class="ui fluid action input">
                                                <input placeholder="输入鸟币数量..." name="bird_coin" type="text" id="bird-coin" />
                                                <div class="ui active magenta button" id="submit-bird-coin">确定</div>
                                            </div>
                                            <p class="ui magenta text">
                                                <small>*</small> 下单成功后鸟币将不能退还。
                                            </p>
                                        </div>
                                        {% endif %}
                                    </div>
								</div>
								{% endif %}
							</div>
							<div class="right aligned eight wide column">
								<div class="bill">
									<p class="item">
										<b id="cart-items-count" class="money">{{ data.items_count }}</b>件产品，总计：<b id="cart-total-money" class="money">{{ data.total_money }}</b><span class="unit">元</span>
									</p>
									<p class="item">
										优惠：<b id="order-coin-money" class="money">-{{ data.coin_money }}</b>元
									</p>
									<p class="item">
										运费：<b id="order-freight-money" class="money">{{ data.freight }}</b>元
									</p>
									<p class="item">
										应付金额：<b id="order-pay-money" class="money">{{ pay_money }}</b>元
									</p>
								</div>
							</div>
						</div>
						<div class="bottom aligned row">
							<div class="six wide column">
								<a href="{{ app_url_cart }}" class="ui gray inverted button">
									<i class="truck icon"></i> 返回购物车
								</a>
							</div>
							<div class="right aligned ten wide column">
								<div class="ui magenta checkout submit inverted button">
                                    <i class="checkmark icon"></i> 立即下单
                                </div>
							</div>
						</div>
					</div>
				</form>
				{% else %}
				<div class="ui empty message">
					<div class="ui big header">
						<i class="cart icon"></i>
						<div class="content">
							<div class="sub header">还没有购物，请选择喜欢的产品 <a href="{{ app_url_shop }}" class="ui magenta link">继续购物</a></div>
						</div>
					</div>
				</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>
{% include "block/shopping/address.html" %}

{% endblock %}
