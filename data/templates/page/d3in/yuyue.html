{%extends 'layout/column.html'%}
{% block title %}铟立方未来实验室 -{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="http://frstatic.qiniudn.com/wechat/js/swiper.min.css">
<link rel="stylesheet" href="http://frstatic.qiniudn.com/wechat/js/animate.min-1.css">
<style type="text/css">
.lab.submenu>.ui.responsive.grid>.row{
	padding:1rem 0;
	border-bottom: 1px solid rgba(0,0,0,0.15);
}
.lab.submenu > .ui.responsive.grid > .row > .column{
	padding:0;
}
.lab.submenu h3{
	margin:0;
}
.lab.submenu .right.wide.column a.ui.line.item{
	margin-left: 1rem;
	line-height: 23px;
}
.ui.table th{
	text-align:center;
}
.ui.table tbody tr,.ui.table tbody tr:nth-child(2n){
	background:#fff;
}
.ui.table tbody tr:hover{
	background:rgba(255,51,102,0.75);
	cursor: pointer;
}
.clss{
	background:#f1f1f1 !important;
}

/* 已预约的 */
.okyu{
	background:#ccc !important;
	cursor:auto !important;
}
p a.ui.link{
	color:#f36;
	margin-left:1em;
}
.swiper-button-prev{
	left:0;
}
.swiper-button-next{
	right:0;
}
.swiper-slide .ui.grid.row{
	margin:0 2%;
}
.row.chooli{
	margin:0 0 1rem;
}
.row.chooli span{
	margin-right: 15px;
  background: green;
  padding: 0.5px 6px;
}
.row.chooli span.black{
	background:#f36;
}
.row.chooli .ui.white.button.active{
	color:rgba(0,0,0,0.8);
	-webkit-user-select: initial;
	  -moz-user-select: initial;
	  -ms-user-select: initial;
	  user-select: initial;
	cursor:auto;
	text-transform: none;
}
.swiper-slide td {
	position:relative;
}
.swiper-slide td span{
	background: green;
  padding: 10px 6px;
  position: absolute;
  top: 50%;
  margin-top: -10px;
  left: 25%;
}
.swiper-slide td span.black{
	background:#f36;
}
.five.fields .field {
  display: inline-block;
	width:120px;
	margin: 8px 0;
	float: left;
	padding-left:0 !important;
	padding-right:0 !important;
}
.five.fields .field .ui.radio.checkbox label{
	padding-left: 1.5em;
	margin-right: 0em;
}

.five.fields .field .ui.radio.checkbox input[type="radio"]{
	z-index:100;
	width:100%;
	margin: 0;
  padding: 0;
	top:-2px;
	height: 100%;
}
.option-hour .field input[type="checkbox"]{
	z-index:100;
	width:100%;
	margin: 0;
  padding: 0;
	top:-2px;
	height: 100%;
}
.option-hour .three.fields{
	margin-left: -1%;
	margin-right: -1%;
}
.option-hour .three.fields .field {
	width: 31.33333333% !important;
	margin: 8px 1%;
  text-align: center;
  padding: 20px 0 !important;
  background: #e3e3e3;
}
.option-hour .field .ui.checkbox{
	width: 120px;
}
input#gen-btn{
	margin-top: 20px;
}
.option-hour.ui.form .field :disabled{
	opacity:0;
}
.ui.form .fields:after{
	display:none;
}
.ui.buttons .button:first-child {
  border-left: 0px solid gray;
}
.ui.success.message {
  background-color: #DEFCD5;
  color: #52A954;
}
.ui.success.message .header .appoint-result{
	font-weight: 400;
	font-size: 1.05rem;
	margin-top: 10px;
}
.ui.success.message .header .appoint-result .item{
	margin:3px 0;
}
.ui.success.message .header{
	font-size:1.2em;
}
</style>
{% endblock %}
{% block layout_js %}
	<script src="http://frstatic.qiniudn.com/wechat/js/swiper.min-1.js" type="text/javascript"></script>
  <script type="text/javascript">
    //初始化
    //选择时间点次数
    var init_times = 4;

    function regain_appoint_option(){
      var item_id = $('[name=item_id]').val();
      var obj = $('.appoint-result .item[name='+ item_id +']');
      if(obj.length>0){
        var result = $(obj).find("[name='result[]']").val();
        var arr = result.split('|');
        //过滤已预约时间
        var url = "{{ app_url_d3in }}/ajax_filter_time"; 
        $.get(url, {item_id:item_id, date_id:arr[1], type:1}, function(){
          $('.option-date [name=date]').each(function(){
            var d = $(this).val();
            if(arr[1]==d){
              $(this).prop('checked', true);
            }
          });
          var time_arr = arr[2].split(',');
          $('#record-times').val('');
          $('.option-hour [name=hour]').each(function(){
            var t = $(this).val();
            if(time_arr.indexOf(t)>=0){
              phenix.record_asset_id('record-times', t);
              $(this).prop('checked', true);
            }
          });
        });
        
      }else{
        var date_obj = $('.option-date [name=date]:checked');
        if($(date_obj).length>0){
          //过滤已预约时间
          var url = "{{ app_url_d3in }}/ajax_filter_time"; 
          $.get(url, {item_id:item_id, date_id:$(date_obj).val(), type:1}, function(){});  
        }
        clear_times();
      }
    }

    //清除记录
    function clear_times(){
      $('#record-times').val('');
      var rest_times = $('[name=rest_times]').val();
      $('#rest-time .t').attr('rest-val', rest_times).text(rest_times);
    }

    //拼接结果集
    function join_appoint_result(val){
      var obj = $('[name=appoint_result]');
      var result = $(obj).val();
      var appoint_result;
      
      if(result == ''){
        $(obj).val(val);
      }else{
        var current_item_id = val.split('|')[0];
        var arr_p = result.split('$$');
        var has_item = false;
        for(var i=0; i<arr_p.length; i++){
          var arr_c = arr_p[i].split('|');
          if(arr_c[0]==current_item_id){
            has_item = true;
            arr_p[i] = val;
          }
        }
        if(!has_item){
          arr_p.push(val);
          appoint_result = arr_p.join('$$');
        }else{
          appoint_result = arr_p.join('$$');
        }
        $(obj).val(appoint_result);
      }
    }

    //获取并设置有效剩余时间数
    function set_rest_times(){
      var data = $('[name=appoint_result]').val();
      var rest_times = 0;
      if(!data){
        rest_times = init_times;
      }else{
        var arr_p = data.split('$$');
        for(var i=0; i<arr_p.length; i++){
          var arr_c = arr_p[i].split('|');
          var time_arr = arr_c[2].split(',');
          rest_times += time_arr.length;
        }
        rest_times = init_times - rest_times;
      }
      $('#rest-time .t').attr('rest-val', rest_times).text(rest_times);
      return rest_times;
    }

  </script>
{% endblock %}
{% block jquery %}

var rest_time = parseInt($('#rest-time .t').attr('rest-val'));

$('.ui.table tbody tr').click(function(){
	$(this).toggleClass('clss');
})
var mySwiper = new Swiper('.swiper-container',{
  freeMode : true,
  slidesPerView : 'auto',
	nextButton: '.swiper-button-next',
	prevButton: '.swiper-button-prev',
	noSwiping : 'true',
	noSwipingClass : 'stop-swiping',
});

//选择预约项目
$('.begin-appoint-btn').click(function(){
  var item_id = $(this).attr('data-cid');
  var item_name = $(this).attr('data-title');
  $('[name=item_id]').val(item_id);
  $('[name=item_name]').val(item_name);

  //清空之前选中的时间点
  $('.option-hour [name=hour]').each(function(){
    $(this).prop('checked', false);
  });

   //还原已预约值
  regain_appoint_option();
  //重置剩余次数
  set_rest_times();

  $('.option-date').show();
});

$('.begin-appoint-btn:first-child').click(function(){
	$(this).addClass('active');
	$('.begin-appoint-btn:nth-child(2)').removeClass('active');
});
$('.begin-appoint-btn:nth-child(2)').click(function(){
	$(this).addClass('active');
	$('.begin-appoint-btn:first-child').removeClass('active');
});

//选择日期
$('.option-date [name=date]').click(function(){
  var date_id = $(this).val();
  var item_id = $('[name=item_id]').val();
  //过滤已预约时间
  var url = "{{ app_url_d3in }}/ajax_filter_time";
  $.get(url, {item_id:item_id, date_id:date_id, type:1}, function(){
      var item_id = $('[name=item_id]').val();
      var obj = $('.appoint-result .item[name='+ item_id +']');
      if(obj.length>0){

        var result = $(obj).find("[name='result[]']").val();
        var arr = result.split('|');
        var time_arr = arr[2].split(',');
        if(date_id==arr[1]){
          $('#record-times').val('');
          $('.option-hour [name=hour]').each(function(){
            var t = $(this).val();
            if(time_arr.indexOf(t)>=0){
              phenix.record_asset_id('record-times', t);
              $(this).prop('checked', true);
            }
          });         
        }

      }
  });
  //重置剩余次数
  set_rest_times();
  $('[name=date_id]').val(date_id);
  $('.option-hour').show();
  $('#rest-time').show();
});

// 选择时间点
$('.option-hour [name=hour]').click(function(){
  rest_time = parseInt($('#rest-time .t').attr('rest-val'));
  var time_id = $(this).val();
  if($(this).prop("checked")){
    $(this).prop('checked', false);
    phenix.record_asset_id('record-times', time_id);
    rest_time -= 1;
  }else{
    $(this).prop('checked', true);
    phenix.remove_asset_id('record-times', time_id);
    rest_time += 1;
  }
  if(rest_time <0 ){
    phenix.show_error_note('您的时间用完!');
    $(this).prop('checked', true);
    phenix.remove_asset_id('record-times', time_id);
    return;
  }else if(rest_time>4){
    phenix.show_error_note('操作有误!');
    $(this).prop('checked', false);
    phenix.record_asset_id('record-times', time_id);
    return;  
  }

  $('#rest-time .t').attr('rest-val', rest_time).text(rest_time);
});

//确定按钮点击事件
$('#gen-btn').click(function(){
  var item_id = $('[name=item_id]').val();
  var item_name = $('[name=item_name]').val();
  var date_id = $('[name=date_id]').val();
  var time_ids = $('#record-times').val();
  if(!item_id){
    phenix.show_error_note('请选择测试项目!');
    return;
  }
  if(!date_id){
    phenix.show_error_note('请选择日期!');
    return; 
  }
  if(!time_ids){
    phenix.show_error_note('请选择时间段!');
    return; 
  }

  var obj = $('.appoint-result .item[name='+ item_id +']');
  var join_val = item_id + '|' + date_id + '|' + time_ids;
  if(obj.length>0){
    $(obj).find('.date-id-box').text(date_id);
    $(obj).find('.time-id-box').text(time_ids);
    $(obj).find("[name='result[]']").val(join_val);
  }else{
    var html='';
    html += '<div class="item" name="'+ item_id +'">';
    html += '<span class="item-name-box">'+ item_name +'</span> <span class="date-id-box">'+ date_id +'</span> <span class="time-id-box">'+ time_ids +'</span>';
    html += '<input type="hidden" name="result[]" value="'+ join_val +'" />';
    html += '</div>';
    $('.appoint-result').append(html);
  }
  //记录预约总值
  join_appoint_result(join_val);

  //记录剩余时间次数
  var rest_time = parseInt($('#rest-time .t').attr('rest-val'));
  $('[name=rest_times]').val(rest_time);

  $('#item-show').show();
  
});

//确认信息,提交
$('.next-step.button').click(function(){
  var appoint_result = $('[name=appoint_result]').val();
  if(!appoint_result){
    phenix.show_error_note('请选择预约项目!');
    return false;
  }
  var is_vip = $('[name=is_vip]').val();
  var pay_ment = 0;
  if(is_vip==0){
    pay_ment = $('[name=pay_ment]:checked').val();
    if(!pay_ment){
      phenix.show_error_note('请选择支付方式!');
      return false;
    }
  }
  var url = "{{ app_url_d3in }}/appoint_sumbit";
  $.post(url, {appoint_result:appoint_result, is_vip:is_vip, pay_ment:pay_ment});

});

{% endblock %}
{% block content %}
<div class="lab submenu">
	<div class="ui responsive grid" style="padding:0 11%;">
		<div class="row">
			<div class="eight wide column">
				<h3>D3IN铟立方未来实验室</h3>
			</div>
			<div class="eight right aligned wide column">
        {% include "block/d3in/sub_nav.html" %}
			</div>
		</div>
	</div>
</div>
<div class="ui big block">
	<div class="ui responsive grid" style="padding:0 11% 3%;">
		<div class="row">
			<div class="column">
				<h3 class="ui header">实验室预约</h3>
				<p>您希望什么时间前来？</p>
			</div>
		</div>
		
		<div class="row chooli">
			<div class="column">
				<div class="ui buttons">
        {% for d in classes %}
        <div class="ui green inverted button begin-appoint-btn" data-cid="{{ d._id }}" data-title={{ d.title }}>
	<!--<span class="black"></span>-->{{ d.title }}</div>&nbsp;
        {%endfor%}
				</div>
			</div>
		</div>

		<div class="row" id="item-show" style="display:none;">
                    <input type="hidden" name="item_id" value="" />
                    <input type="hidden" name="item_name" value="" />
                    <input type="hidden" name="date_id" value="" />
                    <input type="hidden" name="time_ids" id="record-times" value="" />
                    <input type="hidden" name="rest_times" value="4" />
                    <input type="hidden" name="appoint_result" value="" />
			<div class="column">
				<div class="ui success message">
					<div class="header">
					预约结果: 
						<div class="appoint-result">
        
		        </div>
					</div>
				</div>
			</div>
		</div>

		<div class="row">
      <div class="column">

        <div class="option-date ui form" style="display:none;">
					<div class="five fields">						
{% for d in appoint_date_arr %}
{% for c in d %}
            <div class="field">
    				   <div class="ui radio checkbox">
							   <input name="date" type="radio" value="{{ c.id }}" />
										<label>{{ c.date }}</label>
							 </div>
						 </div>
            {%endfor%}
{%endfor%}
          </div>
				</div>
                 
			</div>
		</div>
		<div class="row">
			<div class="column">
         <div class="option-hour ui form" style="display:none;">
			    <div class="ui three fields">
						<div class="field">
							<div class="ui checkbox">
								<input name="hour" type="checkbox" value="9" /><label>9:00-10:00</label>
							</div>
						</div>
						<div class="field">
							<div class="ui checkbox">
              				<input name="hour" type="checkbox" value="10" /><label>10:00-11:00</label>
							</div>
						</div>
						<div class="field">
							<div class="ui checkbox">
              				<input name="hour" type="checkbox" value="11" /><label>11:00-12:00</label>
							</div>
						</div>
						<div class="field">
							<div class="ui checkbox">
              				<input name="hour" type="checkbox" value="12" /><label>12:00-13:00</label>
							</div>
						</div>
						<div class="field">
							<div class="ui checkbox">
              				<input name="hour" type="checkbox" value="13" /><label>13:00-14:00</label>
							</div>
						</div>
						<div class="field">
							<div class="ui checkbox">
              				<input name="hour" type="checkbox" value="14" /><label>14:00-15:00</label>
							</div>
						</div>
						<div class="field">
							<div class="ui checkbox">
              				<input name="hour" type="checkbox" value="15" /><label>15:00-16:00</label>
							</div>
						</div>
						<div class="field">
							<div class="ui checkbox">
              				<input name="hour" type="checkbox" value="16" /><label>16:00-17:00</label>
							</div>
						</div>
						<div class="field">
							<div class="ui checkbox">
								<input name="hour" type="checkbox" value="17" /><label>17:00-18:00</label>
							</div>
						</div>
						<div class="field">
							<div class="ui checkbox">
								<input name="hour" type="checkbox" value="18" /><label>18:00-19:00</label>
							</div>
						</div>
						<div class="field">
							<div class="ui checkbox">
              				<input name="hour" type="checkbox" value="19" /><label>19:00-20:00</label>
							</div>
						</div>
						<div class="field">
							<div class="ui checkbox">
              				<input name="hour" type="checkbox" value="20" /><label>20:00-21:00</label>
							</div>
						</div>
           </div>
					<input class="ui magenta inverted button" type="button" name="gen-btn" id="gen-btn" value="确定" />
                 

       	</div>
   		</div>
		</div>

     <div class="row" id="rest-time" style="display:none;">
      <div class="column">
        剩余<span rest-val="4" class="t">4</span>小时
      </div>
    </div>
		
	<!--	<div class="swiper-container">
			<div class="swiper-wrapper">

        {% for d in appoint_date_arr %}

				<div class="swiper-slide stop-swiping">
					<div class="ui center aligned grid row">
			
            {% for c in d %}
						<div class="five wide center aligned column">
							<table class="ui celled table">
								<thead>
									<tr>
                    <th id="{{ c.id }}">{{ c.date }} {{ c.week }}</th>
									</tr>
								</thead>
								<tbody>
									<tr name="10" class="clss">
										<td>
											<span></span>
											10:00-11:00</td>
									</tr>
									<tr name="11" class="clss">
										<td>
												11:00-12:00</td>
									</tr>
									<tr name="12" class="clss">
										<td>12:00-13:00</td>
									</tr>
									<tr name="13" class="clss">
										<td>13:00-14:00</td>
									</tr>
									<tr name="14" class="okyu">
										<td><span class="black"></span>
                      14:00-15:00</td>
									</tr>
									<tr name="15">
										<td>15:00-16:00</td>
									</tr>
									<tr name="16">
										<td>16:00-17:00</td>
									</tr>
									<tr name="17">
										<td>17:00-18:00</td>
									</tr>
									<tr name="18">
										<td>18:00-19:00</td>
									</tr>
									<tr name="19">
										<td>19:00-20:00</td>
									</tr>
									<tr name="20">
										<td>20:00-21:00</td>
									</tr>
									<tr name="21">
										<td>21:00-22:00</td>
									</tr>
							
								</tbody>
							</table>	
						</div>
            {%endfor%}
			
					</div>
				</div>

        {%endfor%}
		
			</div>
			<div class="swiper-button-next"></div>
			<div class="swiper-button-prev"></div>
		</div>
	-->	
		<div class="row">
      <div class="column">

      </div>
    </div>
		
		<div class="row">
        {% if vip_state != 3 %}
			<div class="column">
				<p>费用</p>
        <p>
        {{ vip_money.day }}元/次    
        {% if vip_state==0 %}<a href="{{ app_url_d3in }}/member" class="ui link" target="_blank"> 加入VIP会员订阅计划 </a>{%endif%}{% if vip_state==1 %}<a href="{{ app_url_d3in }}/member" class="ui link" target="_blank"> 会员到期,点击续费 </a>{%endif%}
        {% if vip_state==2 %}<a href="javascript:void(0);" class="ui link"> 该会员被禁用,暂时无法预约,请联系管理员 </a>{%endif%}
        </p>
				<p>支付方式</p>
				<input type="hidden" name="is_vip" value="0" />
				<div class="ui checkbox" style="margin-right:1rem;">
					<input type="radio" name="pay_ment" value="1" />
					<label for="">在线支付</label>
				</div>
				<div class="ui checkbox">
					<input name="pay_ment" type="radio" value="2" />
					<label for="">现场支付</label>
				</div>

			</div>
      {%endif%}

      {% if vip_state == 3 %}
      <input type="hidden" name="is_vip" value="1" />
      {%endif%}
		</div>
		
		<div class="row">
			<div class="right aligned column">
        <a href="{{ app_url_domin }}/d3in/choose?ids={{ ids }}" class="ui magenta inverted button">上一步</a>&nbsp;&nbsp;&nbsp;&nbsp;
        {% if vip_state != 2 %}
				<a href="javascript:void(0);" class="ui magenta inverted next-step button">下一步</a>
        {%endif%}
			</div>
		</div>
		
	</div>
</div>

{% endblock %}
