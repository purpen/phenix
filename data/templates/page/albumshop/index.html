{%extends 'layout/column.html'%}
{% block title %}{% endblock %}
{% block page_css %}
<style type="text/css">
    .categorybox {
        background-color: #fff;
    }
	.category{
		{% if albums.banner %}
		background: url("{{ albums.banner.fileurl }}") no-repeat scroll center center / cover rgba(45, 53, 56, 1);
		{% else %}
	    background: no-repeat scroll center center / cover rgba(45, 53, 56, 1);
		{% endif %}
	}
	.problock > a{
    padding-top: 65% !important;
  }
</style>
{% endblock %}

{% block layout_js %}
<script type="text/javascript" >
    function ajax_load_more(page, size){
        var url = '{{ app_url_album_shop }}/ajax_load_list?did={{ did }}&rand='+Math.random();
        $.get(url, { page:page, size:size }, function(rs){
            if(rs.data.results.total_page > rs.data.results.current_page){
                $('#albums-more')
                    .hide()
                    .attr({'status': 0, 'p': rs.data.results.current_page});
            }else{
                $('#albums-more').html('没有更多');
            }
            var rendered = phenix.ajax_render_result('#fetch_more_albumshop_tpl', rs.data);
            $('.item-box').append(rendered);
        }, 'json');
    }
</script>
{% endblock %}

{% block jquery %}

    // ajax加载更多(滚动条接近底部加载)
    $(window).scroll(function(){
        var scrollTop = $(this).scrollTop();
        var scrollHeight = $(document).height();
        var windowHeight = $(this).height();
        if(scrollTop + windowHeight > scrollHeight-150){
            var page = parseInt($('#albums-more').attr('p')) + 1;
			var stat = $('#albums-more').attr('status');
            // 防止频繁请求(在没加载完成时只允许请求一次)
            if(stat == 0){
                $('#albums-more').show();
                ajax_load_more(page, 12);
            }
        }
    });

    // ajax加载商品列表
    ajax_load_more(1, 12);
	
	/* 登录用户行为 */
	{% if visitor.is_login %}
		
		// 初始化互动，是否关注、点赞
		$.get('{{ app_url_favorite }}/ajax_done', {id: {{albums._id}},type:8,event:1}, function(result){
			if (result.success) {
				// 验证关注
				if (result.data.favorited) {
					$('.ui.favorite.button')
						.data('mark', 'y')
						.addClass('active')
                        .html('<i class="minus icon"></i> 已关注');
				}
			}
		}, 'json');

	{% endif %}
	
	// 关注
	$('.ui.favorite.button').bind('click', function(){
		var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.show_login_box();
			return false;
		}
		if (mark == 'n') {
			$.post('{{ app_url_favorite }}/ajax_favorite', {id: id, type:8}, function(result){
				if (result.success) {
					$btn
						.data('mark', 'y')
						.addClass('active')
                        .html('<i class="minus icon"></i> 已关注');
                        
                    $('#target-favorite-count').text(result.data.favorite_count);
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		} else {
			$.post('{{ app_url_favorite }}/ajax_cancel_favorite', {id: id, type:8}, function(result){
				if (result.success) {
					$btn
						.data('mark', 'n')
						.removeClass('active')
                        .html('<i class="plus icon"></i> 关注');
                        
                    $('#target-favorite-count').text(result.data.favorite_count);
                    
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		}
	});
	
{% endblock %}

{% block content %}
<div class="category image {{ albums._id }}" >
	<h1>
		{{ albums.title|default '专辑精选' }}
        <div class="desc">
            <p>{{ albums.des|default '我们用心挑选数以万计的创意产品，为你每次的一见钟情!' }}</p>
        </div>
		<div class="ui magenta pop favorite inverted button" data-title="关注一下" data-content="有关该产品动态及时通知你，后续可以在‘我关注的’中快捷查找" data-id="{{ albums._id }}" data-mark="n">
			<i class="plus icon"></i> 关注
		</div>
	</h1>
</div>

<div class="shop list" id="shoplist">
	<div class="ui responsive grid">
		<div class="row">
			<div class="column">
				<div class="ui two products cards item-box">
                    <!--ajax load list-->
                </div>
            </div>
            <div id="albums-more" p="{{ page }}" style="text-align:center;margin:10px auto;display:none;">
                <img src="{{ app_url_packaged }}/images/loading.gif" alt="loading" />
                加载中...
            </div>
		</div>
	</div>
</div>
{% endblock %}

{% block templates %}
{% mustache id:'fetch_more_albumshop_tpl' tpl:'mustache/fetch_more_albumshop.mustache' %}
{% endblock %}
