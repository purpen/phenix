{%extends 'layout/column.html'%}
{% block title %}{% endblock %}
{% block page_css %}
<style type="text/css">
    .categorybox {
        background-color: #fff;
    }
	.category{
		{% if albums.banner %}
		background: url("{{ albums.banner.fileurl }}") no-repeat scroll center center / cover rgba(45, 53, 56, 1);
		{% else %}
	    background: no-repeat scroll center center / cover rgba(45, 53, 56, 1);
		{% endif %}
	}
	.mainleft{
	  min-height:auto !important;
	}
</style>
{% endblock %}

{% block layout_js %}
<script type="text/javascript" >
    function ajax_load_more(page, size){
        var url = '{{ app_url_album_shop }}/ajax_load_list?did={{ did }}&rand='+Math.random();
        $.get(url, { page:page, size:size }, function(rs){
            if(rs.data.results.total_page > rs.data.results.current_page){
                $('#albums-more')
                    .hide()
                    .attr({'status': 0, 'p': rs.data.results.current_page});
            }else{
                $('#albums-more').html('没有更多');
            }
            var rendered = phenix.ajax_render_result('#fetch_more_albumshop_tpl', rs.data);
            $('.item-box').append(rendered);
        }, 'json');
    }
</script>
{% endblock %}

{% block jquery %}

    // ajax加载更多(滚动条接近底部加载)
    $(window).scroll(function(){
        var scrollTop = $(this).scrollTop();
        var scrollHeight = $(document).height();
        var windowHeight = $(this).height();
        if(scrollTop + windowHeight > scrollHeight-150){
            var page = parseInt($('#albums-more').attr('p')) + 1;
			var stat = $('#albums-more').attr('status');
            // 防止频繁请求(在没加载完成时只允许请求一次)
            if(stat == 0){
                $('#albums-more').show();
				$('#albums-more').attr('status', 1);
                ajax_load_more(page, 12);
            }
        }
    });

    // ajax加载商品列表
    ajax_load_more(1, 12);
	
	/* 登录用户行为 */
	{% if visitor.is_login %}
		
		// 初始化互动，是否关注、点赞
		$.get('{{ app_url_favorite }}/ajax_done', {id: {{albums._id}},type:8,event:1}, function(result){
			if (result.success) {
				// 验证关注
				if (result.data.favorited) {
					$('.ui.favorite.button')
						.data('mark', 'y')
						.addClass('active')
                        .html('<i class="minus icon"></i> 已关注');
				}
			}
		}, 'json');

	{% endif %}
	
	// 关注
	$('.ui.favorite.button').bind('click', function(){
		var id = $(this).data('id'),mark = $(this).data('mark'),$btn = $(this);
		// 所有ajax请求，验证是否登录
		if (!phenix.visitor.is_login){
			phenix.show_login_box();
			return false;
		}
		if (mark == 'n') {
			$.post('{{ app_url_favorite }}/ajax_favorite', {id: id, type:8}, function(result){
				if (result.success) {
					$btn
						.data('mark', 'y')
						.addClass('active')
                        .html('<i class="minus icon"></i> 已关注');
                        
                    $('#target-favorite-count').text(result.data.favorite_count);
                    if(result.data.new_fav){
                        $('#target_favorite_support')
                            .prepend('<a href=\"/user/'+ result.data.user_id +'\" target=\"_blank\" id=\"user-'+ result.data.user_id +'\" class=\"image\" data-variation=\"wide\" data-html=\"<div class=\'header\'>'+  result.data.nickname +'</div><div class=\'content\'>'+ result.data.city +' '+ result.data.job +'</div>\"><img src=\"'+ result.data.avatar +'\" /></a>');
                    }
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		} else {
			$.post('{{ app_url_favorite }}/ajax_cancel_favorite', {id: id, type:8}, function(result){
				if (result.success) {
					$btn
						.data('mark', 'n')
						.removeClass('active')
                        .html('<i class="plus icon"></i> 关注');
                        
                    $('#target-favorite-count').text(result.data.favorite_count);
                    
				} else {
					phenix.show_error_note(result.message);
				}
			}, 'json');
		}
	});

    // ajax加载签到数据
    phenix.signin();

    // 加载推荐专辑
    $.get('{{ app_url_albums }}/ajax_load_list?rand='+Math.random(), { page: 1, size: 4, album_id: "{{ albums._id }}" }, function(rs){
          if(rs.success){
              var rendered = phenix.ajax_render_result('#get_shop_albums_tpl', rs.data);
              $('.shop-albums').html(rendered);                          
          }else{
              phenix.show_error_note(rs.message);
          }

      }, 'json');
	
{% endblock %}

{% block content %}
<div class="category image {{ albums._id }}" >
	<h1>
		{{ albums.title|default '专辑精选' }}
        <div class="desc">
            <p>{{ albums.des|default '我们用心挑选数以万计的创意产品，为你每次的一见钟情!' }}</p>
        </div>
        <!--
		<div class="ui magenta pop favorite inverted button" data-title="关注一下" data-content="有关该产品动态及时通知你，后续可以在‘我关注的’中快捷查找" data-id="{{ albums._id }}" data-mark="n">
			<i class="plus icon"></i> 关注
		</div>
    -->
	</h1>
</div>

<div class="shop list mainwrap social" id="shoplist">
  <div class="mainleftwrap">
    <div class="mainleft">
      <div class="ui three products cards item-box">
                  <!--ajax load list-->
              </div>
      <div id="albums-more" p="{{ page }}" status="1" style="text-align:center;margin:10px auto;display:none;">
          <img src="{{ app_url_packaged }}/images/loading.gif" alt="loading" />
          加载中...
      </div>

    </div>
  </div>
  <div class="mainright">
    {% include "page/topic/usersign.html" %}

    {% if visitor.can_edit %}
      <div class="sellwrap userinfo">
        <a href="{{ app_url_albums }}/add" class="fluid ui red inverted button">
          <i class="edit icon"></i> 创建新专辑
        </a>
        <p>甄选你最偏爱的智能创意品味，收获无穷灵感与未来眼界。</p>
      </div>
    {%endif%}

        <div class="ui sticky">
            <div class="sellwrap">
                <div class="block title">
                         关注 
                </div>
                <div class="user action">
        			<div class="ui magenta pop favorite inverted button" data-title="关注一下" data-content="有关该专辑动态及时通知你，后续可以在‘我关注的’中快捷查找" data-id="{{ albums._id }}" data-mark="n">
        				<i class="plus icon"></i> 关注
        			</div>
                </div>
                <div class="user avatars">
              	  	<div class="ui images" id="target_favorite_support">
                        {% if albums.favorite_count %}
                            {% favorite_list var:'userlist' target_id:albums._id event:1 type:8 size:50 %}
                            {% for target in userlist.rows %}
                            <a href="{{ target.user.home_url }}" target="_blank" id="user-{{ target.user._id }}" class="image" data-variation="wide" data-html="<div class='header'>{{ target.user.nickname }}</div><div class='content'>{{ target.user.city }} {{ target.user.profile.job }} </div>">
                  	  	        <img src="{{ target.user.mini_avatar_url }}" alt="{{ target.user.nickname }}" />
                            </a>
                            {% endfor %}
                        {% endif %}
              	  	</div>
                    <p>
                        已有 <span id="target-favorite-count">{{ albums.favorite_count }}</span> 人关注
                    </p>                    
                </div>

            </div>
        </div>

        <!--推荐专辑-->
        <div class="sellwrap" id="shop-albums-list">
			<div class="block title">
               推荐专辑 
      </div>
            <div class="ui articles shop-albums list">

            </div>
    </div>

    
  </div>
  
  
  
  
	<!--<div class="ui responsive grid">
		<div class="row">
			<div class="column">
				<div class="ui four products cards item-box">-->
                    <!--ajax load list-->
              <!--  </div>
            </div>
            <div id="albums-more" p="{{ page }}" status="1" style="text-align:center;margin:10px auto;display:none;">
                <img src="{{ app_url_packaged }}/images/loading.gif" alt="loading" />
                加载中...
            </div>
		</div>
	</div>-->
</div>
{% endblock %}

{% block templates %}
  {% mustache id:'fetch_more_albumshop_tpl' tpl:'mustache/fetch_more_albumshop.mustache' %}
  {% mustache id:'user_sign_box_tpl' tpl:'mustache/user_sign_box.mustache' %}
  {% mustache id:'get_shop_albums_tpl' tpl:'mustache/fetch_albums_right.mustache' %}
{% endblock %}
