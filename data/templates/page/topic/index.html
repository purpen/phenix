{%extends 'layout/column.html'%}
{% block title %}{% endblock %}
{% block page_css %}
<style type="text/css">
.ui.topics.segment .ui.table {
    border: none;
}

#minslider.flexslider .slides {
    height: 350px;
}
#minslider.flexslider .slides > li {
    height: 350px;
    border-radius: 4px;
}
#minslider.flexslider .slides > li > a {
    height: 350px;
}
#minslider.flexslider .flex-direction-nav {
    display:block;
    height:auto;
}
#minslider.flexslider .flex-direction-nav a {
    top: 50%;
}
#minslider.flexslider:hover .flex-direction-nav .flex-prev {
    left: 30px;
}
#minslider.flexslider:hover .flex-direction-nav .flex-next {
    right: 30px;
}
</style>
{% endblock %}

{% block layout_js %}
<script type="text/javascript" >
    function ajax_load_more(page, status){
        var url = '{{ app_url_topic }}/ajax_fetch_more';
        if(page != 'no'){
            $.get(url, { page:page }, function(rs){
                rs.data['phenix'] = phenix.url;
                var rendered = phenix.ajax_render_result('#fetch_more_topics_tpl', rs.data);
                $('#topic_list_box').append(rendered);
                $('#topic-more').data('status', 0);
                $('#topic-more').data('page', page);
                $('#topic-more').hide();
            }, 'json');
        }else{
            $(this).text('没有更多了~');
        }

    }
</script>
{% endblock %}

{% block jquery %} 
    $('#minslider').flexslider({
        animation: "fade",
        controlNav: false,
        slideshow: false,
    });
    
    // ajax加载签到数据
    phenix.signin();
    
	// 加载更多动态
	$('.ui.more.button').bind('click', function(){
		var page = $(this).data('page');
    ajax_load_more(page);

	});
    $('.mentors > .avatar a')
      .popup({
        hoverable: true,
        position : 'top center',
      });

    // ajax加载更多(滚动条接近底部加载)
    $(window).scroll(function(){
        var scrollTop = $(this).scrollTop();
        var scrollHeight = $(document).height();
        var windowHeight = $(this).height();
        if(scrollTop + windowHeight > scrollHeight - 200){
            var stat = $('#topic-more').data('status');
            var page = parseInt($('#topic-more').data('page')) + 1;

            // 防止频繁请求(在没加载完成时只允许请求一次)
            if(stat == 0){
                $('#topic-more').data('status', 1);
                $('#topic-more').show();
                ajax_load_more(page);
            }
        }
    });
{% endblock %}

{% block content %}
<!-- 话题推荐位 -->
<div class="mainwrap social" id="topics">
    <div class="social topstick">
        <div class="slidebox">
            
            {% ad_list var:'adslide' page:1 size:3 state:2 name:'find_home_slide' %}
            <div id="minslider" class="flexslider flex-single">
                <ul class="slides">                    
	                {% for ad in adslide.rows %}
                        <li style="background-image: url('{{ ad.cover.fileurl }}');">
                            <a href="{{ ad.view_url }}" title="{{ ad.title }}" alt="{{ ad.title }}" target="_blank">
                                <img src="{{ ad.cover.fileurl }}" alt="{{ ad.title }}" style="display: none;" />
                            </a>
                        </li>
					{% endfor %}
                  </ul>
            </div>
            <div class="controls-dots"></div>
            
		</div>
    </div>
    
    <div class="mainleftwrap">
        <div class="mainleft">
            <!--最新话题-->
            <div class="ui topics segment">
				{% topic_list var:'list' is_top:1 time:time sort:0 published:1 page:1 size:15 %}
				<div class="ui computer tablet only block">
					<table class="ui basic topic table">
                        <tbody id="topic_list_box">
						{% if dig_list %}
							{% for topic in dig_list %}
								{% if topic %}
									<!-- 判断话题是否可以显示 -->
									{% if topic.published %}
										{% include "block/topic_item.html" %}
									{% endif %}
								{% endif %}
							{% endfor %}
						{% endif %}   
            
						{% for topic in list.rows %}
							{% if !topic.top %}<!--过滤置顶帖子-->
								{% include "block/topic_item.html" %}
							{% endif %}
						{% endfor %}
                        </tbody>
					</table>
				</div>

				<div class="ui mobile only block">
					<table class="ui basic table">
						{% for topic in list.rows %}
							<tr>
								<td class="{%if topic.t_color==1%}topic-title-color-red{%endif%}{%if topic.t_color==2%}topic-title-color-blue{%endif%}{%if topic.t_color==3%}topic-title-color-green{%endif%}{%if topic.t_color==4%}topic-title-color-yellow{%endif%}">
						          	<a href="{{ topic.view_url }}" title="{{ topic.title }}" class="ui link">{{ topic.title }}</a>
								</td>
							</tr>
						{% endfor %}
					</table>
				</div>
    
                {% if list.total_page > 1 %}
                    <div id="topic-more" data-page="1" data-status="0" style="text-align:center;margin:10px auto;display:none;">
                        <img src="{{ app_url_packaged }}/images/loading.gif" alt="loading" />
                        加载中...
                    </div>
                {% endif %}
			</div>
        </div>

    </div>
    <div class="mainright">
        {% include "page/topic/usersign.html" %}
        {% include "page/topic/login_user.html" %}
        {% include "page/topic/rightbar.html" %}
        {% include "page/topic/hotpeople.html" %}
        {% include "page/topic/top_user.html" %}
        {% include "page/topic/stick_list.html" %}
        {% include "page/topic/adwrap.html" %}
    </div>
</div>
{% endblock %}

{% block templates %}
{% mustache id:'user_sign_box_tpl' tpl:'mustache/user_sign_box.mustache' %}
{% mustache id:'fetch_more_topics_tpl' tpl:'mustache/fetch_more_topics.mustache' %}
{% endblock %}
