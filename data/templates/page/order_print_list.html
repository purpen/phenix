{%extends 'layout/column.html'%}
{% block title %}订单打印列表-{% endblock %}
{% block page_css %}
<style class="text/css">

    .red-point{
      position: relative;
    }

    .red-point::before{
      content: " ";
      border: 3px solid red;/*设置红色*/
      border-radius:3px;/*设置圆角*/
      position: absolute;
      z-index: 1000;
      left: 0%;
      margin-left: -10px;
    }
    
</style>
{% endblock %}
{% block layout_js %}
<script type="text/javascript" src="https://s3.taihuoniao.com/js/LodopFuncs.js"></script>
<script type="text/javascript" >
    var page = 1;
    function load_orders(){
        var url = '{{ app_url_domain }}/order/ajax_order_print_list';
        $.get(url, { page: 1, size: 100, type: 1 }, function(rs){
            if(rs.data.rows.length == 0) {
            $('#order-box').html('<div class="ui segment"><p>您还没有相关订单</p></div>');
              return;
            }

            console.log(rs.data);
            rs.data['phenix'] = phenix.url;
            var rendered = phenix.ajax_render_result('#order_print_list_tpl', rs.data);
            if(page==1){
                $('#order-box').html(rendered);
            }else{
                $('#order-box').append(rendered);          
            }
        }, 'json');
    }

  var LODOP;

</script>
{% endblock %}
{% block jquery %}
  // 加载订单列表
	load_orders();
  // 定时加载
  setInterval(load_orders, 10000);

  // 删除记录
  $('.del-btn').livequery(function(){
    $(this).click(function(){
      var id = $(this).data('id');
      var url = '{{ app_url_domain }}/order/del_order_print';
      $.get(url, { id: id }, function(rs){
        if(!rs.success){
          phenix.show_error_note(rs.message);
          return false;
        }
        $('#order-'+id).remove();
      }, 'json');
    });
	});

  // 打开预览页面
  $('.view_btn1').livequery(function(){
    $(this).click(function(){
      var id = $(this).data('id');

      var url = '{{ app_url_domain }}/order/order_print_show?id=' + id;

      LODOP=getCLodop();
	    LODOP.PRINT_INIT("D3IN");
      LODOP.ADD_PRINT_URL(10,1,"100%","100%",url);
      //LODOP.SET_PRINT_STYLEA(0,"HOrient",3);
      //LODOP.SET_PRINT_STYLEA(0,"VOrient",3);
      //LODOP.SET_SHOW_MODE("MESSAGE_GETING_URL",""); //该语句隐藏进度条或修改提示信息
      //LODOP.SET_SHOW_MODE("MESSAGE_PARSING_URL","");//该语句隐藏进度条或修改提示信息
      LODOP.ADD_PRINT_HTM("1mm", 34, "RightMargin:1mm", "BottomMargin:1mm", document.getElementById('printArea').innerHTML);
      
      LODOP.PREVIEW();
    });
	});

  // 打印
  $('.view_btn').livequery(function(){
    $(this).click(function(){
      var id = $(this).data('id');

      var url = '{{ app_url_domain }}/order/ajax_order_print_show';

      $.get(url, { id: id }, function(rs){
        if(!rs.success){
          phenix.show_error_note(rs.message);
          return false;
        }


        var html = '';
        html += '<div class="print-box" style="width: 100%;background-color: #fff;font-size: 10px;font-weight: 300;" >';
        html += '<h2 style="text-align: center;font-size: 12px;">D3IN</h2>';
        html += '<div class="order">';
        html += '<p style="font-size: 10px;line-height: 0.5;">销售单号: ' + rs.data.rid + '</p>';
        html += '<p style="font-size: 10px;line-height: 0.5;">交易时间: ' + rs.data.created_at + '</p>';
        html += '<p style="font-size: 10px;line-height: 0.5;">&nbsp;</p>';
        html += '<table class="product-list" style="width: 100%;">';
        html += '<tr class="head" style="border-bottom: 1px dashed #000;font-weight: 400;"><td>商品名称</td><td>单价</td><td>数量</td><td>金额</td></tr>';
        
        for(var i = 0; i < rs.data.products.length; i++){
          html += '<tr>';
          html += '<td style="text-align: left;">' + rs.data.products[i].short_title + '('+ rs.data.products[i].sku_mode +')</td>';
          html += '<td style="text-align: left;">¥'+ rs.data.products[i].sale_price +'</td>';
          html += '<td style="text-align: left;">'+ rs.data.products[i].quantity +'</td>';
          html += '<td style="text-align: left;">¥'+ rs.data.products[i].total_price +'</td>';
          html += '</tr>';
        } // endfor

        html += '</table>';
        html += '<p class="line" style="border-bottom: 1px dashed #000;font-size: 10px;line-height: 0.5;">&nbsp;</p>';
        html += '<p style="font-size: 10px;line-height: 0.5;">总数: '+ rs.data.items_count +'</p>';
        html += '<p style="font-size: 10px;line-height: 0.5;">快递: ¥'+ rs.data.freight +'</p>';
        html += '<p style="font-size: 10px;line-height: 0.5;">合计: ¥'+ rs.data.total_money +'</p>';
        html += '<p class="line" style="border-bottom: 1px dashed #000;font-size: 10px;line-height: 0.5;">&nbsp;</p>';
        html += '<p style="font-size: 10px;line-height: 0.5;">优惠: ¥'+ rs.data.discount_money +'</p>';
        html += '<p style="font-size: 10px;line-height: 0.5;">应付: ¥'+ rs.data.pay_money +'</p>';
        html += '<p style="font-size: 10px;line-height: 0.5;">实收: ¥'+ rs.data.pay_money +'</p>';
        html += '<p class="line" style="border-bottom: 1px dashed #000;font-size: 10px;line-height: 0.5;">&nbsp;</p>';
        html += '<p style="text-align: center;">谢谢惠顾，欢迎下次光临!</p>';
        html += '</div>';
        html += '<div style="height: 10px;"></div>';
        html += '</div>';


        LODOP=getCLodop();
        LODOP.PRINT_INIT("D3IN");
        //LODOP.SET_PRINT_STYLEA(0,"HOrient",3);
        //LODOP.SET_PRINT_STYLEA(0,"VOrient",3);
        //LODOP.SET_SHOW_MODE("MESSAGE_GETING_URL",""); //该语句隐藏进度条或修改提示信息
        //LODOP.SET_SHOW_MODE("MESSAGE_PARSING_URL","");//该语句隐藏进度条或修改提示信息
        LODOP.ADD_PRINT_HTM("1mm", "1mm", "RightMargin:1mm", "BottomMargin:1mm", html);
        
        LODOP.PREVIEW();

      }, 'json');

    });
	});

{% endblock %}
{% block content %}
<object  id="LODOP_OB" classid="clsid:2105C259-1E0C-4534-8141-A753534CB4CA" width=0 height=0> 
       <embed id="LODOP_EM" type="application/x-print-lodop" width=0 height=0></embed>
</object>
<div class="section breadcrumb">
	<div class="ui responsive grid">
		<div class="row">
			<div class="column">
				<div class="ui medium breadcrumb">
				  	<a class="ui section link" href="{{ app_url_domin }}">
						<i class="home icon"></i> 首页
					</a>
					<i class="angle right icon divider"></i>
					<div class="active section">订单打印列表</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="account myorders profile">
	<div class="ui responsive grid">

		<div class=" wide column">
			
			<div class="ui middle aligned grid">
				<div class="row">
					<div class="three wide column">
						<h2 class="ui header">订单打印列表</h2>
					</div>
				</div>
			</div>
      <div id="order-box"><!--ajax fetch order--></div>

		</div>
	</div>
</div>

<div class="ui small modal order-box">
  <i class="close icon"></i>
  <div class="header">打印购物清单</div>
  <div class="content">
    <div id="print-box"><h1>测试打印购物清单</h1></div>
  </div>
</div>

{% endblock %}
{% block templates %}
  {% mustache id:'order_print_list_tpl' tpl:'mustache/order_print_list.mustache' %}
{% endblock %}
