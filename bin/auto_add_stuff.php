#!/usr/bin/env php
<?php
/**
 * fix topic try_id => (int)try_id
 */
$config_file =  dirname(__FILE__).'/../deploy/app_config.php';
if (!file_exists($config_file)) {
    die("Can't find config_file: $config_file\n");
}
include $config_file;

define('DOGGY_VERSION', $cfg_doggy_version);
define('DOGGY_APP_ROOT', $cfg_app_deploy_root);
define('DOGGY_APP_CLASS_PATH', $cfg_app_class_path);
require $cfg_doggy_bootstrap;
require $cfg_app_rc;

set_time_limit(0);
ini_set('memory_limit','512M');

echo "add stuff ...\n";

$stuff_model = new Sher_Core_Model_Stuff();
$page = 1;
$size = 100;
$is_end = false;
$total = 0;

$user_ids = "573342,573347,573349,573353,573355,573358,573361,573365,573368,573372,573376,573379,573383,573386,573389,573392,573395,573398,573401,573405,573407,573411,573414,573417,573421,573423,573427,573430,573433,573435,573437,573442,573445,573447,573451,573452,573456,573458,573461,573462,573467,573469,573472,573476,573478,573482,573485,573488,573489,573494,573496,573498,573501,573503,573507,573509,573511,573513,573515,573518,573523,573527,573531,573533,573538,573542,573546,573550,573553,573555,573559,573562,573566,573568,573569,573573,573577,573581,573585,573587,573590,573593,573595,573599,573602,573605,573609,573613,573616,573619,573623,573628,573630,573633,573637,573642,573646,573648,573652,573657,573659,573662,573665,573668,573670,573672,573676,573680,573682,573685,573689,573692,573694,573697,573700,573703,573707,573711,573716,573718,573721,573723,573726,573730,573733,573736,573738,573740,573745,573749,573753,573755,573756,573759,573760,573763,573764,573766,573769,573772,573775,573779,573782,573785,573787,573789,573793,573796,573800,573803,573806,573808,573812,573815,573817,573819,573822,573827,573830,573832,573834,604441,604444,604447,604450,604452,604456,604458,604461,604464,604468,604471,604474,604477,604482,604486,604489,604492,604494,604498,604502,604506,604508,604513,604516,604519,604522,604526,604529,604531,604533,604535,604538,604540,604543,604545,604549,604552,604553,604558,604561,604566,604569,604573,604575,604577,604579,604583,604586,604588,604590,604594,604596,604599,604602,604605,604608,604611,604616,604621,604625,604630,604635,604638,604642,604645,604649,604653,604657,604661,604664,604668,604672,604676,604678,604681,604683,604686,604689,604694,604698,604702,604707,604710,604714,604718,604722,604724,604726,604730,604733,604737,604740,604743,604746,604748,604750,604753,604756,604758,604762,604765,604767,604770,604774,604777,604780,604785,604787,604788,604791,604795,604798,604801,604804,604809,604811,604817,604819,604823,604826,604830,604834,604836,604839,604840,604844,604847,604850,604853,604854,604857,604861,604865,604870,604872,604875,604880,604883,604886,604887,604890,604895,604896,604899,604902,604904,604907,604910,604914,604918,604921,604923";

$user_arr = explode(',', $user_ids);
$user_count = count($user_arr);


while(!$is_end){
	$query = array('fid'=>38, 'published'=>1, 'deleted'=>0);
	$options = array('page'=>$page,'size'=>$size);
	$list = $stuff_model->find($query, $options);
	if(empty($list)){
		echo "get stuff list is null,exit......\n";
		break;
	}
	$max = count($list);
	for ($i=0; $i < $max; $i++) {
        $id = $list[$i]['_id'];
        $item = $list[$i];
        $category_id = $item['category_id'];
        $new_category_id = 249;
        if ($category_id == 39 || $category_id == 46) {
            $new_category_id = 250;
        } elseif ($category_id == 47 || $category_id == 48) {
            $new_category_id = 246;
        } elseif ($category_id == 45 || $category_id == 43 || $category_id == 41) {
            $new_category_id = 247;
        }
        $row = array(
            'title' => $item['title'],
            'short_title' => $item['short_title'],
            'description' => $item['description'],
            'cover_id' => $item['cover_id'],
            'published' => 1,
            'from_to' => 8,
            'attr'=> 1,
            'fid' => 244,
            'category_id' => $new_category_id,
            'is_robot_no' => 1,
            'company' => '设计团队',
            'user_id' => $user_arr[rand(0, $user_count)],
        );

        $has_one = $stuff_model->first(array('title'=>$row['title'], 'from_to'=>8));
        if ($has_one) {
            echo "重复:$row[title].\n";
            continue;
        }
        $ok = $stuff_model->create($row);
        if ($ok) {
          echo "创建成功！$row[title].\n";
          $total++;
        } else {
          echo "创建失败！\n";
        }
        break;
      
    }
	if($max < $size){
		break;
	}
	$page++;
	echo "page [$page] updated---------\n";
}




echo "All stuff count: $total update ok.\n";

